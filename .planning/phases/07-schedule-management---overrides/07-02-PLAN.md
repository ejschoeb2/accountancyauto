---
phase: 07-schedule-management
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - app/(dashboard)/schedules/[id]/edit/page.tsx
  - app/(dashboard)/schedules/components/schedule-step-editor.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a new schedule by selecting a filing type, entering a name, and adding steps"
    - "User can add a step that assigns an email template, delay in days, and urgency level"
    - "User can choose from preset delays (7, 14, 30 days) or type a custom number"
    - "User can reorder steps using up/down arrow buttons"
    - "User can remove individual steps"
    - "User sees a warning when the same template is used in multiple steps"
    - "User can edit an existing schedule with all data loading correctly"
    - "User can save and is redirected back to the schedules list"
  artifacts:
    - path: "app/(dashboard)/schedules/[id]/edit/page.tsx"
      provides: "Full page schedule editor (create + edit)"
      min_lines: 80
    - path: "app/(dashboard)/schedules/components/schedule-step-editor.tsx"
      provides: "Step list with reorder, add, remove, template/delay/urgency config"
      min_lines: 60
  key_links:
    - from: "app/(dashboard)/schedules/[id]/edit/page.tsx"
      to: "/api/schedules and /api/schedules/[id]"
      via: "fetch for load and save"
      pattern: "fetch.*api/schedules"
    - from: "app/(dashboard)/schedules/components/schedule-step-editor.tsx"
      to: "react-hook-form useFieldArray"
      via: "move() for reorder, append() for add, remove() for delete"
      pattern: "useFieldArray"
    - from: "app/(dashboard)/schedules/[id]/edit/page.tsx"
      to: "lib/validations/schedule.ts"
      via: "zodResolver for form validation"
      pattern: "scheduleSchema"
---

<objective>
Build the schedule editor page with step management -- the core interactive UI where users create and edit reminder schedules with ordered steps.

Purpose: This is the primary user-facing feature of Phase 7. Users configure WHEN reminders are sent by creating schedules with multiple steps, each assigning a template, delay, and urgency level. The editor uses React Hook Form's useFieldArray for step management with up/down reordering.

Output: Working full-page schedule editor that can create new schedules and edit existing ones, with inline step configuration.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-schedule-management---overrides/07-CONTEXT.md
@.planning/phases/07-schedule-management---overrides/07-RESEARCH.md
@.planning/phases/07-schedule-management---overrides/07-01-SUMMARY.md
@lib/types/database.ts
@lib/validations/schedule.ts
@app/(dashboard)/templates/[id]/edit/page.tsx
@app/(dashboard)/templates/components/template-step-editor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schedule step editor component with reordering</name>
  <files>
    app/(dashboard)/schedules/components/schedule-step-editor.tsx
  </files>
  <action>
    Create a client component `ScheduleStepEditor` that manages an ordered list of schedule steps using React Hook Form's `useFieldArray`.

    **Props:** `form: UseFormReturn<ScheduleInput>`, `templates: Array<{ id: string; name: string }>`

    **useFieldArray setup:**
    - `const { fields, append, remove, move } = useFieldArray({ control: form.control, name: "steps" })`

    **Reorder functions (per user decision: up/down arrow buttons):**
    - `moveUp(index)`: if index > 0, call `move(index, index - 1)`
    - `moveDown(index)`: if index < fields.length - 1, call `move(index, index + 1)`

    **Add step:**
    - `append({ email_template_id: "", days_before_deadline: 7, urgency_level: "normal" })`
    - Default delay is 7 days, default urgency is "normal"

    **Each step row renders (using card layout per Claude's discretion):**

    1. **Header row:** "Step {index + 1}" label on left. On right: up arrow button (disabled if first), down arrow button (disabled if last), delete button (red/destructive). Use lucide-react icons: `ChevronUp`, `ChevronDown`, `Trash2`.

    2. **Email Template selector:** shadcn Select dropdown. Value bound to `steps.${index}.email_template_id`. `onValueChange` calls `form.setValue(...)`. Placeholder: "Select template". Lists all templates by name.

    3. **Days before deadline (per user decision: preset options + custom input):**
       - Three preset buttons: 7 days, 14 days, 30 days
       - Active preset gets `variant="default"`, inactive gets `variant="outline"`
       - Determine active by comparing `form.watch(\`steps.${index}.days_before_deadline\`)` to preset value
       - Clicking preset calls `form.setValue(\`steps.${index}.days_before_deadline\`, days)`
       - Custom input: `<Input type="number" min={1} max={365} className="w-24" />` registered with `{ valueAsNumber: true }`
       - Layout: presets in a row, then "or" text, then custom input

    4. **Urgency level (per user decision: dropdown with 3 levels):**
       - shadcn Select with options: Normal, High, Urgent
       - Values: "normal", "high", "urgent"
       - NOTE: Only 3 levels per user decision. The database has 4 levels (low, normal, high, urgent) but user specified exactly 3 in the UI. Do NOT show "low" in the dropdown.

    **Duplicate template warning (per user decision: non-blocking):**
    - Watch all step template IDs: `form.watch("steps").map(s => s.email_template_id)`
    - Find duplicates: IDs that appear more than once (excluding empty strings)
    - If duplicates exist, show warning banner above the step list:
      - Yellow/warning styled div with border
      - Text: "Note: The same email template is assigned to multiple steps. This is allowed, but recipients will receive similar emails at different intervals."
    - This is NOT a validation error. Do NOT use `setError()`. Just render conditionally.

    **Empty state:** "No steps added. Click 'Add Step' to define when reminders are sent."

    **CRITICAL:** Use `field.id` as the React key for each step (NOT array index). This prevents state desync on reorder.

    **CRITICAL:** The database column is `days_before_deadline` not `delay_days`. Match the Zod schema field names from `lib/validations/schedule.ts`.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify the component compiles. Check that `useFieldArray` is imported from `react-hook-form`, `field.id` is used as key, and `move()` is used for reordering.
  </verify>
  <done>
    ScheduleStepEditor renders step list with up/down reorder buttons, add/remove, template selector dropdown, preset delay buttons (7/14/30) + custom input, urgency dropdown (Normal/High/Urgent), and non-blocking duplicate template warning. Uses field.id as React key. No validation errors for duplicates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create schedule editor page (create + edit)</name>
  <files>
    app/(dashboard)/schedules/[id]/edit/page.tsx
  </files>
  <action>
    Create a client component page following the exact same pattern as `app/(dashboard)/templates/[id]/edit/page.tsx`. This is the full page schedule editor.

    **URL pattern:**
    - `/schedules/new/edit` = create new schedule
    - `/schedules/{uuid}/edit` = edit existing schedule

    **Form setup:**
    - `useForm<ScheduleInput>` with `zodResolver(scheduleSchema)`
    - Default values: `filing_type_id: "corporation_tax_payment"`, `name: ""`, `description: ""`, `steps: []`, `is_active: true`

    **Data loading:**
    1. Load filing types from `/api/filing-types` (same as template editor)
    2. Load email templates from Supabase or a new API. Since we need template names for the step editor dropdown, fetch email_templates list. Use `/api/schedules` won't work for this. Instead, create a simple fetch: call Supabase directly via `fetch` to get email templates, OR add a lightweight endpoint. Simplest approach: fetch from the existing API pattern. Actually, the cleanest approach is to use the Supabase client directly in the client component. But this is a "use client" component, so use `@supabase/ssr` createBrowserClient. Check if `lib/supabase/client.ts` exists; if not, create a browser client helper. Alternatively, just fetch via API route. Use whichever pattern the codebase already has for client-side data fetching.

    Actually, looking at the existing template editor: it fetches via API routes (`/api/filing-types`, `/api/templates/${id}`). Follow the same pattern. For email templates list, we can add a fetch to the existing `/api/templates` endpoint (which returns reminder_templates). BUT we need the NEW email_templates table, not the old reminder_templates. So either:
    - Option A: Create a simple API route at `/api/email-templates` that queries the `email_templates` table
    - Option B: Fetch directly in the component

    Go with Option A -- create `app/api/email-templates/route.ts` with a simple GET that returns `id, name` from the `email_templates` table. Add this file to the files_modified list for this task.

    3. If editing (not new), load existing schedule from `GET /api/schedules/${id}` and call `form.reset()` with the data.

    **Form layout (matches template editor structure):**

    Section 1 - "Basic Information" (bordered card):
    - Filing Type: shadcn Select dropdown (same as template editor)
    - Schedule Name: text input, placeholder "e.g., Standard Corporation Tax Reminders"
    - Description: textarea (optional), placeholder "Internal notes about this schedule"
    - Active checkbox: "Active (will be used for generating reminders)"

    Section 2 - "Schedule Steps" (bordered card):
    - Render `<ScheduleStepEditor form={form} templates={emailTemplates} />`

    Bottom action bar:
    - Left: Cancel button (navigates to `/templates?tab=schedules`)
    - Right: Submit button ("Create Schedule" for new, "Save Changes" for edit), disabled while submitting
    - For existing schedules: Delete button (top right, same position as template editor)

    **Save handler (`onSubmit`):**
    - POST to `/api/schedules` for new, PUT to `/api/schedules/${id}` for edit
    - On success: toast "Schedule created!" or "Schedule updated!", navigate to `/templates?tab=schedules`
    - On error: toast error message

    **Delete handler:**
    - `confirm("Are you sure you want to delete this schedule? All steps will be removed.")` -- mention steps since CASCADE will delete them
    - DELETE to `/api/schedules/${id}`
    - On success: toast "Schedule deleted!", navigate to `/templates?tab=schedules`

    **Loading state:** Show "Loading..." while fetching existing schedule data (same as template editor).

    **Additional file:** Also create `app/api/email-templates/route.ts` -- simple GET returning `select("id, name, subject").order("name")` from `email_templates` table. This provides the template dropdown options for the step editor.
  </action>
  <verify>
    Run `npx tsc --noEmit` for type checking. Run `npm run build` to verify the page compiles. Navigate to `/schedules/new/edit` and verify the form renders with filing type dropdown, name input, description, active checkbox, and empty step editor. Add a step and verify template dropdown, delay presets, and urgency dropdown appear.
  </verify>
  <done>
    Schedule editor page loads at `/schedules/new/edit` (create) and `/schedules/{id}/edit` (edit). Form has filing type, name, description, active toggle. Step editor allows adding steps with template selection, preset delays (7/14/30) + custom, urgency dropdown (Normal/High/Urgent), up/down reorder, and remove. Save creates/updates via API. Delete with confirmation. Cancel returns to schedules list. Email templates API provides dropdown options.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Navigate to `/schedules/new/edit` -- form renders with all fields
4. Add 2 steps -- both render with template dropdown, delay presets, urgency selector
5. Click up/down arrows -- steps reorder correctly (values follow the step)
6. Select same template in both steps -- warning message appears (not blocking)
7. Fill in schedule name and filing type, save -- redirects to `/templates?tab=schedules`
8. Click created schedule from list -- editor loads with all saved data
9. Edit and save -- data updates correctly
10. Delete with confirmation -- schedule removed, redirected to list
</verification>

<success_criteria>
- New schedule can be created with name, filing type, description, and multiple steps
- Each step has template dropdown (populated from email_templates), preset delay buttons + custom input, urgency dropdown (Normal/High/Urgent)
- Steps can be reordered with up/down arrows (values move with the step, no state desync)
- Duplicate template warning appears as non-blocking message
- Existing schedules load correctly in editor with all data populated
- Save creates/updates via API, delete removes with CASCADE confirmation
- All navigation flows back to `/templates?tab=schedules`
</success_criteria>

<output>
After completion, create `.planning/phases/07-schedule-management---overrides/07-02-SUMMARY.md`
</output>
