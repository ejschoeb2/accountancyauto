---
phase: 05-rich-text-editor---templates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - app/(dashboard)/templates/extensions/placeholder-node.ts
  - app/(dashboard)/templates/components/placeholder-pill.tsx
  - app/(dashboard)/templates/extensions/paste-handler.ts
autonomous: true

must_haves:
  truths:
    - "PlaceholderNode is an atomic inline node that cannot be split or corrupted"
    - "Pasting content from any source strips all formatting and inserts plain text only"
  artifacts:
    - path: "app/(dashboard)/templates/extensions/placeholder-node.ts"
      provides: "TipTap custom Node extension for placeholder pills"
      contains: "atom: true"
    - path: "app/(dashboard)/templates/components/placeholder-pill.tsx"
      provides: "React NodeView component for rendering placeholder as styled pill"
      contains: "NodeViewWrapper"
    - path: "app/(dashboard)/templates/extensions/paste-handler.ts"
      provides: "TipTap Extension that strips paste formatting to plain text"
      contains: "handlePaste"
  key_links:
    - from: "app/(dashboard)/templates/extensions/placeholder-node.ts"
      to: "app/(dashboard)/templates/components/placeholder-pill.tsx"
      via: "ReactNodeViewRenderer"
      pattern: "ReactNodeViewRenderer"
---

<objective>
Install TipTap 3.x packages and create the two custom TipTap extensions needed by the template editor: an atomic PlaceholderNode for variable pills and a PasteHandler that strips all formatting.

Purpose: These extensions are the foundation for the rich text editor. PlaceholderNode ensures variables like {{client_name}} render as protected pills that cannot be accidentally split. PasteHandler ensures Word/Outlook paste always produces clean plain text.

Output: TipTap npm packages installed, PlaceholderNode extension with React NodeView pill component, PasteHandler extension.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-rich-text-editor---templates/05-RESEARCH.md
@lib/types/database.ts (TipTapDocument, TipTapNode, PLACEHOLDER_VARIABLES)
@package.json (current dependencies)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install TipTap and create PlaceholderNode extension with pill component</name>
  <files>
    package.json
    package-lock.json
    app/(dashboard)/templates/extensions/placeholder-node.ts
    app/(dashboard)/templates/components/placeholder-pill.tsx
  </files>
  <action>
    1. Install TipTap packages:
       ```
       npm install @tiptap/react @tiptap/pm @tiptap/starter-kit
       ```

    2. Create `app/(dashboard)/templates/extensions/placeholder-node.ts`:
       - Import `Node`, `mergeAttributes` from `@tiptap/core` and `ReactNodeViewRenderer` from `@tiptap/react`
       - Export `PlaceholderNode = Node.create({...})` with:
         - `name: 'placeholder'`
         - `group: 'inline'`, `inline: true`, `atom: true` (CRITICAL: atom prevents splitting)
         - `addAttributes()` returning `id` (string, the variable key e.g. 'client_name') and `label` (string, display text e.g. 'Client Name')
         - `parseHTML()` matching `span[data-type="placeholder"]`
         - `renderHTML()` producing `['span', mergeAttributes({'data-type': 'placeholder', class: 'placeholder-pill'}, HTMLAttributes), node.attrs.label || node.attrs.id]`
         - `addNodeView()` returning `ReactNodeViewRenderer(PlaceholderPill)`
       - Import PlaceholderPill from the components file

    3. Create `app/(dashboard)/templates/components/placeholder-pill.tsx`:
       - `'use client'` directive
       - Import `NodeViewWrapper` from `@tiptap/react`
       - Export `PlaceholderPill` component that receives `node` prop (with attrs.id and attrs.label)
       - Render: `<NodeViewWrapper as="span" className="...">{{node.attrs.label}}</NodeViewWrapper>`
       - Pill styling with Tailwind: `inline-flex items-center rounded-full bg-primary/10 text-primary px-2 py-0.5 text-sm font-medium select-none` — visually distinct colored pill that clearly stands out from body text
       - The pill must NOT be editable (NodeViewWrapper handles this via atom: true)
  </action>
  <verify>
    - `npm ls @tiptap/react` shows installed version
    - `placeholder-node.ts` exports PlaceholderNode with `atom: true` and `inline: true`
    - `placeholder-pill.tsx` uses NodeViewWrapper and renders styled pill
    - TypeScript compiles: `npx tsc --noEmit --skipLibCheck` passes (or at least these files have no errors)
  </verify>
  <done>PlaceholderNode TipTap extension exists with atom: true, inline: true, and ReactNodeViewRenderer pointing to a styled pill component</done>
</task>

<task type="auto">
  <name>Task 2: Create PasteHandler extension</name>
  <files>
    app/(dashboard)/templates/extensions/paste-handler.ts
  </files>
  <action>
    Create `app/(dashboard)/templates/extensions/paste-handler.ts`:
    - Import `Extension` from `@tiptap/core`, `Plugin`, `PluginKey` from `@tiptap/pm/state`
    - Export `PasteHandler = Extension.create({...})` with:
      - `name: 'pasteHandler'`
      - `addProseMirrorPlugins()` returning a Plugin with:
        - `key: new PluginKey('pasteHandler')`
        - `props.handlePaste: (view, event, slice)` handler that:
          1. Gets plain text via `event.clipboardData?.getData('text/plain')`
          2. If no text, returns false (allow default)
          3. Inserts text using `view.dispatch(view.state.tr.insertText(text, view.state.selection.from, view.state.selection.to))` — note: use both from and to to handle selection replacement
          4. Returns true (prevents default paste with formatting)

    Per user decision: Ctrl+V ALWAYS strips formatting, no Ctrl+Shift+V alternative. Images are ignored completely — only text is pasted. No paste notification shown.
  </action>
  <verify>
    - File exists and exports PasteHandler extension
    - Extension uses ProseMirror Plugin with handlePaste prop
    - Handler extracts only 'text/plain' from clipboardData (strips formatting)
    - TypeScript compiles without errors
  </verify>
  <done>PasteHandler extension strips all formatting from pasted content, inserting only plain text</done>
</task>

</tasks>

<verification>
- `npm ls @tiptap/react @tiptap/pm @tiptap/starter-kit` shows all three packages installed
- All three extension/component files exist and export their respective modules
- PlaceholderNode has `atom: true` and `inline: true` (prevents corruption)
- PasteHandler intercepts paste and extracts only plain text
- No TypeScript compilation errors in the new files
</verification>

<success_criteria>
TipTap 3.x is installed. PlaceholderNode extension creates atomic inline nodes rendered as styled pills via React NodeView. PasteHandler extension strips all formatting from pasted content. Both extensions are ready to be consumed by the template editor component in Plan 03.
</success_criteria>

<output>
After completion, create `.planning/phases/05-rich-text-editor---templates/05-01-SUMMARY.md`
</output>
