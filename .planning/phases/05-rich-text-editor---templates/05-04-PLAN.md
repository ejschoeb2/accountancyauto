---
phase: 05-rich-text-editor---templates
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - app/(dashboard)/templates/new/page.tsx
  - app/(dashboard)/templates/[id]/edit/page.tsx
  - app/(dashboard)/templates/page.tsx
  - app/(dashboard)/templates/components/template-card.tsx
autonomous: false

must_haves:
  truths:
    - "User can create a new email template with name, subject line, and rich text body"
    - "User can edit an existing email template with content loading correctly in the editor"
    - "User can view a list of all templates as cards in a grid layout"
    - "Navigating to /templates shows cards for all email_templates from the database"
    - "Clicking Create Template navigates to /templates/new with empty editor"
    - "Clicking a template card navigates to /templates/{id}/edit with content pre-loaded"
  artifacts:
    - path: "app/(dashboard)/templates/new/page.tsx"
      provides: "Create new email template page with editor"
      contains: "TemplateEditor"
    - path: "app/(dashboard)/templates/[id]/edit/page.tsx"
      provides: "Edit existing email template page with editor"
      contains: "TemplateEditor"
    - path: "app/(dashboard)/templates/page.tsx"
      provides: "Template list page with card grid"
      contains: "email-templates"
    - path: "app/(dashboard)/templates/components/template-card.tsx"
      provides: "Card component for template grid"
      contains: "EmailTemplate"
  key_links:
    - from: "app/(dashboard)/templates/new/page.tsx"
      to: "/api/email-templates"
      via: "fetch POST on save"
      pattern: "fetch.*api/email-templates"
    - from: "app/(dashboard)/templates/[id]/edit/page.tsx"
      to: "/api/email-templates/[id]"
      via: "fetch GET on load, PUT on save"
      pattern: "fetch.*api/email-templates"
    - from: "app/(dashboard)/templates/page.tsx"
      to: "email_templates table"
      via: "Supabase server component query"
      pattern: "from.*email_templates"
---

<objective>
Build the template list page (card grid) and create/edit template pages that compose the TipTap editor, subject line editor, and API routes into a complete template management flow.

Purpose: This is the final assembly plan — connecting the editor components (Plan 03) to the API routes (Plan 02) through page-level components. After this plan, the user has a complete template CRUD workflow.

Output: Template list page showing cards, create template page with editor, edit template page with pre-loaded content, template card component.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-rich-text-editor---templates/05-CONTEXT.md
@.planning/phases/05-rich-text-editor---templates/05-02-SUMMARY.md
@.planning/phases/05-rich-text-editor---templates/05-03-SUMMARY.md
@lib/types/database.ts (EmailTemplate, TipTapDocument)
@app/(dashboard)/templates/[id]/edit/page.tsx (existing v1.0 edit page — will be replaced)
@app/(dashboard)/templates/page.tsx (existing v1.0 list page — will be replaced)
@app/(dashboard)/templates/components/template-editor.tsx
@app/(dashboard)/templates/components/subject-line-editor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build create/edit template pages</name>
  <files>
    app/(dashboard)/templates/new/page.tsx
    app/(dashboard)/templates/[id]/edit/page.tsx
  </files>
  <action>
    1. Create `app/(dashboard)/templates/new/page.tsx`:
       - `'use client'`
       - Import TemplateEditor from `../components/template-editor`
       - Import SubjectLineEditor from `../components/subject-line-editor`
       - Import Button, Input, Label, Checkbox from shadcn/ui
       - Import `useRouter` from `next/navigation`, `useState` from React, `toast` from `sonner`
       - State: `name` (string), `subject` (string), `bodyJson` (TipTapDocument | null), `isActive` (boolean, default true), `saving` (boolean)
       - Layout:
         - Page header: "Create Template" heading with Cancel and Save buttons
         - Section 1 — "Template Details": Name input, Active checkbox
         - Section 2 — "Subject Line": SubjectLineEditor component bound to `subject` state
         - Section 3 — "Email Body": TemplateEditor component with `onUpdate` setting `bodyJson` state
       - Save handler:
         1. Validate name and subject are non-empty, bodyJson exists
         2. POST to `/api/email-templates` with `{ name, subject, body_json: bodyJson, is_active: isActive }`
         3. On success: `toast.success("Template created!")`, `router.push("/templates")`
         4. On error: `toast.error(error.message)`
       - Cancel: `router.push("/templates")`

    2. Rewrite `app/(dashboard)/templates/[id]/edit/page.tsx`:
       - `'use client'`
       - Same component structure as create page but:
         - Fetch existing template on mount: `GET /api/email-templates/{id}`
         - Pre-populate name, subject, bodyJson, isActive from fetched data
         - Pass `initialContent={bodyJson}` to TemplateEditor so it loads existing content
         - Save handler uses `PUT /api/email-templates/{id}` instead of POST
         - Add Delete button that calls `DELETE /api/email-templates/{id}` with confirmation dialog
         - Show "Loading..." state while fetching template
         - If fetch fails (404), redirect to /templates with toast error
       - Page header: "Edit Template" with Delete and Save buttons

    IMPORTANT: Both pages use the NEW `/api/email-templates/` routes (not the old `/api/templates/`). The old edit page at `[id]/edit/page.tsx` is completely replaced.

    Design notes (Claude's discretion):
    - Each section wrapped in a `rounded-lg border p-8 space-y-6` container (consistent with existing template edit page style)
    - Name input with `hover:border-foreground/20` class (existing pattern)
    - Save button with `active:scale-[0.97]` class (existing pattern)
    - Button alignment: Cancel left, Save right (existing pattern)
  </action>
  <verify>
    - `/templates/new` page renders with empty editor, name input, subject editor
    - `/templates/{id}/edit` page fetches template and pre-populates all fields
    - Save button POSTs/PUTs to `/api/email-templates/` endpoints
    - Delete button calls DELETE with confirmation
    - Toast messages on success/error
    - TypeScript compiles without errors
  </verify>
  <done>Create and edit template pages are functional — user can fill in name, subject (with placeholders), rich text body, and save to the email_templates table</done>
</task>

<task type="auto">
  <name>Task 2: Rebuild template list page as card grid</name>
  <files>
    app/(dashboard)/templates/page.tsx
    app/(dashboard)/templates/components/template-card.tsx
  </files>
  <action>
    1. Create `app/(dashboard)/templates/components/template-card.tsx`:
       - Import `EmailTemplate` from `@/lib/types/database`
       - Import `Badge` from `@/components/ui/badge`
       - Props: `template: EmailTemplate`
       - Render a card with:
         - Template name as heading (font-semibold, truncate if long)
         - Active/Inactive badge (using Badge component, variant="default" for active, variant="secondary" for inactive)
         - Subject line preview (truncated, text-sm text-muted-foreground)
         - Updated timestamp (formatted with date-fns `formatDistanceToNow` or similar, text-xs text-muted-foreground)
       - Card styling: `rounded-lg border bg-card p-6 hover:shadow-md hover:border-accent/30 transition-all duration-200` (matches existing card style)

    2. Rewrite `app/(dashboard)/templates/page.tsx`:
       - Server component (no 'use client')
       - Import `createClient` from `@/lib/supabase/server`
       - Import `Link` from `next/link`, Button from shadcn/ui
       - Import TemplateCard from `./components/template-card`
       - Import `EmailTemplate` from `@/lib/types/database`
       - Query: Fetch from `email_templates` table (NOT `reminder_templates`) ordered by `created_at` desc
       - Layout:
         - Page header: "Email Templates" heading + subtitle "Create and manage your email templates" + "Create Template" button linking to `/templates/new`
         - If templates exist: Grid layout `grid gap-6 md:grid-cols-2 lg:grid-cols-3` with TemplateCard for each, wrapped in Link to `/templates/{id}/edit`
         - If no templates: Empty state card with "No templates yet" message and "Create Template" CTA button

    Per user decision: No search or filter — simple grid of all templates. Cards show preview and metadata. Grid layout.
  </action>
  <verify>
    - Template list page queries `email_templates` table (NOT `reminder_templates`)
    - Cards display name, active status badge, subject preview, and timestamp
    - Grid layout: 1 col mobile, 2 cols md, 3 cols lg
    - "Create Template" button links to `/templates/new`
    - Card clicks link to `/templates/{id}/edit`
    - Empty state shown when no templates exist
    - TypeScript compiles without errors
  </verify>
  <done>Template list page shows a card grid of all email templates with preview, metadata, and navigation to create/edit pages</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete email template management system with:
    1. Template list page at /templates showing card grid
    2. Create page at /templates/new with TipTap rich text editor
    3. Edit page at /templates/{id}/edit loading existing content
    4. Placeholder insertion via button dropdown in both body and subject
    5. Paste formatting stripping (plain text only)
    6. Toolbar with bold, italic, lists, links
  </what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev`
    2. Navigate to http://localhost:3000/templates — should see card grid (or empty state)
    3. Click "Create Template" — should navigate to /templates/new with empty editor
    4. Enter a template name (e.g. "Test Template")
    5. In the subject line, type "Reminder: " then click Insert Placeholder and select "Filing Type" — should insert {{filing_type}} with pill preview below
    6. In the body editor:
       a. Type some text, select it, click Bold — should bold the text
       b. Click Insert Placeholder dropdown, select "Client Name" — should insert a colored pill
       c. Try typing inside or next to the pill — cursor should not enter the pill
       d. Try Ctrl+B for bold, Ctrl+I for italic — keyboard shortcuts should work
       e. Copy formatted text from Word or a website, paste it — should paste as plain text only
    7. Click Save — should create template and redirect to /templates
    8. Verify the new template appears as a card in the grid
    9. Click the card — should navigate to edit page with all content loaded correctly
    10. Make a change and save — should update successfully
  </how-to-verify>
  <resume-signal>Type "approved" if template management works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- /templates page lists all email_templates as cards in a grid
- /templates/new allows creating a new template with name, subject, and rich text body
- /templates/{id}/edit loads existing template and allows editing
- PlaceholderDropdown inserts atomic pills in body and {{variable}} in subject
- Toolbar formatting (bold, italic, lists, links) works correctly
- Paste strips all formatting
- Save persists to email_templates table via API
- Delete removes template (with FK protection)
- Human verification confirms end-to-end flow works
</verification>

<success_criteria>
User can create, view, edit, and delete standalone email templates using the rich text editor. Templates are stored in the email_templates table with TipTap JSON bodies. Template list shows cards in a grid. The complete CRUD flow works end-to-end from UI through API to database.
</success_criteria>

<output>
After completion, create `.planning/phases/05-rich-text-editor---templates/05-04-SUMMARY.md`
</output>
