---
phase: 05-rich-text-editor---templates
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/(dashboard)/templates/components/template-editor.tsx
  - app/(dashboard)/templates/components/template-editor-toolbar.tsx
  - app/(dashboard)/templates/components/placeholder-dropdown.tsx
  - app/(dashboard)/templates/components/subject-line-editor.tsx
autonomous: true

must_haves:
  truths:
    - "User can compose email body with bold, italic, lists, and links using a fixed toolbar"
    - "User can click Insert Placeholder button to open dropdown and insert a placeholder pill into the body"
    - "User can insert placeholders in the subject line via the same button dropdown pattern"
    - "Pasting content strips all formatting (plain text only)"
    - "Keyboard shortcuts work: Ctrl+B for bold, Ctrl+I for italic"
    - "Placeholder pills are visually distinct colored badges that cannot be split or edited"
  artifacts:
    - path: "app/(dashboard)/templates/components/template-editor.tsx"
      provides: "Main TipTap editor wrapper with onUpdate callback"
      contains: "useEditor"
    - path: "app/(dashboard)/templates/components/template-editor-toolbar.tsx"
      provides: "Fixed toolbar with bold, italic, list, link, and placeholder buttons"
      contains: "toggleBold"
    - path: "app/(dashboard)/templates/components/placeholder-dropdown.tsx"
      provides: "Reusable button + dropdown for inserting placeholders"
      contains: "PLACEHOLDER_VARIABLES"
    - path: "app/(dashboard)/templates/components/subject-line-editor.tsx"
      provides: "Plain text subject input with placeholder pill display"
      contains: "insertPlaceholder"
  key_links:
    - from: "app/(dashboard)/templates/components/template-editor.tsx"
      to: "app/(dashboard)/templates/extensions/placeholder-node.ts"
      via: "TipTap extension registration"
      pattern: "PlaceholderNode"
    - from: "app/(dashboard)/templates/components/template-editor.tsx"
      to: "app/(dashboard)/templates/extensions/paste-handler.ts"
      via: "TipTap extension registration"
      pattern: "PasteHandler"
    - from: "app/(dashboard)/templates/components/template-editor-toolbar.tsx"
      to: "app/(dashboard)/templates/components/placeholder-dropdown.tsx"
      via: "Component composition in toolbar"
      pattern: "PlaceholderDropdown"
---

<objective>
Build the TipTap rich text editor component with toolbar, placeholder insertion dropdown, and subject line editor with placeholder support.

Purpose: These are the core UI components that let users compose email templates with formatting and variable placeholders. The editor is the centerpiece of Phase 5.

Output: TipTap editor wrapper, formatting toolbar, placeholder dropdown (reusable for body and subject), subject line editor with pill display.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-rich-text-editor---templates/05-RESEARCH.md
@.planning/phases/05-rich-text-editor---templates/05-01-SUMMARY.md
@lib/types/database.ts (TipTapDocument, PLACEHOLDER_VARIABLES)
@lib/templates/variables.ts (AVAILABLE_PLACEHOLDERS — reuse this list)
@app/(dashboard)/templates/extensions/placeholder-node.ts
@app/(dashboard)/templates/extensions/paste-handler.ts
@components/ui/button.tsx
@components/ui/dropdown-menu.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build TipTap editor wrapper and formatting toolbar</name>
  <files>
    app/(dashboard)/templates/components/template-editor.tsx
    app/(dashboard)/templates/components/template-editor-toolbar.tsx
    app/(dashboard)/templates/components/placeholder-dropdown.tsx
  </files>
  <action>
    1. Create `app/(dashboard)/templates/components/placeholder-dropdown.tsx`:
       - `'use client'`
       - Import DropdownMenu components from `@/components/ui/dropdown-menu`, Button from `@/components/ui/button`
       - Import `AVAILABLE_PLACEHOLDERS` from `@/lib/templates/variables`
       - Props: `onSelect: (id: string, label: string) => void`
       - Render a Button with text "Insert Placeholder" that opens a DropdownMenu
       - Each DropdownMenuItem shows the placeholder label (e.g. "Client Name") with the variable name below in muted text (e.g. "client_name")
       - On select, call `onSelect(placeholder.name, readableLabel)` where readableLabel converts snake_case to Title Case (e.g. 'client_name' -> 'Client Name')
       - CRITICAL: Add `onCloseAutoFocus={(e) => e.preventDefault()}` to DropdownMenuContent to prevent focus steal from editor

    2. Create `app/(dashboard)/templates/components/template-editor-toolbar.tsx`:
       - `'use client'`
       - Import Button from `@/components/ui/button`
       - Import icons from lucide-react: `Bold, Italic, List, ListOrdered, Link2, Unlink`
       - Import PlaceholderDropdown from `./placeholder-dropdown`
       - Import `type Editor` from `@tiptap/react`
       - Props: `editor: Editor | null`
       - Render a fixed toolbar div with `border-b p-2 flex items-center gap-1 flex-wrap bg-background`
       - Buttons (all use variant toggle pattern: `editor.isActive('x') ? 'default' : 'ghost'`):
         - Bold: `editor.chain().focus().toggleBold().run()`
         - Italic: `editor.chain().focus().toggleItalic().run()`
         - Separator div (vertical line)
         - Bullet List: `editor.chain().focus().toggleBulletList().run()`
         - Ordered List: `editor.chain().focus().toggleOrderedList().run()`
         - Separator div
         - Link: If link active, show Unlink button that calls `editor.chain().focus().unsetLink().run()`. Otherwise show Link2 button that prompts for URL via `window.prompt('Enter URL:')` then calls `editor.chain().focus().setLink({ href: url }).run()` — per user decision: auto-detect pasted URLs is handled by TipTap's Link extension autolink feature; toolbar button is for manual insertion
         - Separator div
         - PlaceholderDropdown with `onSelect` that inserts placeholder node: `editor.chain().focus().insertContent({ type: 'placeholder', attrs: { id, label } }).run()`
       - All buttons use `size="sm"` and `variant="ghost"` (or "default" when active)

    3. Create `app/(dashboard)/templates/components/template-editor.tsx`:
       - `'use client'`
       - Import `useEditor, EditorContent` from `@tiptap/react`
       - Import `StarterKit` from `@tiptap/starter-kit`
       - Import `Link` from `@tiptap/starter-kit` (StarterKit does NOT include Link — NOTE: if StarterKit doesn't bundle Link, install `@tiptap/extension-link` separately. Check StarterKit docs. StarterKit does NOT include Link, so add `npm install @tiptap/extension-link` to the task if needed, or use StarterKit's built-in functionality)
       - Actually: StarterKit does NOT include the Link extension. The executor must `npm install @tiptap/extension-link` and import `Link` from `@tiptap/extension-link`.
       - Import `PlaceholderNode` from `../extensions/placeholder-node`
       - Import `PasteHandler` from `../extensions/paste-handler`
       - Import `EditorToolbar` from `./template-editor-toolbar`
       - Props: `initialContent?: TipTapDocument | null`, `onUpdate?: (json: TipTapDocument) => void`
       - useEditor config:
         - `immediatelyRender: false` (CRITICAL: Next.js SSR)
         - `shouldRerenderOnTransaction: false` (performance)
         - extensions array:
           - `StarterKit.configure({ heading: false, blockquote: false, codeBlock: false, horizontalRule: false, code: false, strike: false })`
           - `Link.configure({ openOnClick: false, autolink: true, HTMLAttributes: { class: 'text-primary underline' } })` — autolink: true auto-detects pasted URLs per user decision
           - `PlaceholderNode`
           - `PasteHandler`
         - `content: initialContent || { type: 'doc', content: [{ type: 'paragraph' }] }`
         - `onUpdate: ({ editor }) => onUpdate?.(editor.getJSON() as TipTapDocument)`
       - Render:
         ```
         <div className="rounded-lg border">
           <EditorToolbar editor={editor} />
           <EditorContent editor={editor} className="prose prose-sm max-w-none p-4 min-h-[200px] focus-within:outline-none [&_.ProseMirror]:outline-none [&_.ProseMirror]:min-h-[200px]" />
         </div>
         ```
       - Add editor cleanup in useEffect return: `editor?.destroy()`
       - Show loading state if editor is null: `<div className="rounded-lg border p-4 text-muted-foreground">Loading editor...</div>`
  </action>
  <verify>
    - `template-editor.tsx` uses useEditor with `immediatelyRender: false` and `shouldRerenderOnTransaction: false`
    - Editor registers PlaceholderNode and PasteHandler extensions
    - StarterKit configured with heading, blockquote, codeBlock, horizontalRule, code, strike all set to false
    - Link extension installed and configured with `autolink: true`
    - Toolbar renders bold, italic, bullet list, ordered list, link buttons and PlaceholderDropdown
    - PlaceholderDropdown uses `AVAILABLE_PLACEHOLDERS` to populate items
    - TypeScript compiles without errors: `npx tsc --noEmit --skipLibCheck`
  </verify>
  <done>TipTap editor component renders with fixed toolbar (bold, italic, lists, links) and placeholder dropdown. Placeholder pills display as styled badges. Paste strips formatting. Keyboard shortcuts (Ctrl+B, Ctrl+I) work via StarterKit defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Build subject line editor with placeholder support</name>
  <files>
    app/(dashboard)/templates/components/subject-line-editor.tsx
  </files>
  <action>
    Create `app/(dashboard)/templates/components/subject-line-editor.tsx`:
    - `'use client'`
    - Import `useState, useRef, useCallback` from React
    - Import Button, Input from shadcn/ui
    - Import PlaceholderDropdown from `./placeholder-dropdown`
    - Props: `value: string`, `onChange: (value: string) => void`
    - Component manages cursor position via ref on the input element

    Implementation approach — the subject is stored as plain text with `{{variable}}` syntax (e.g. `"Reminder: {{filing_type}} due {{deadline}}"`). The editor shows:
    1. A text input where user types and sees raw `{{variable}}` text
    2. A PlaceholderDropdown button next to the input
    3. Below the input, a visual preview row that renders the subject with `{{variable}}` patterns replaced by styled pill spans (same visual style as body pills: `inline-flex items-center rounded-full bg-primary/10 text-primary px-2 py-0.5 text-sm font-medium`)

    PlaceholderDropdown onSelect:
    - Get current cursor position from input ref (`inputRef.current?.selectionStart`)
    - Insert `{{id}}` at cursor position in the value string
    - Call `onChange` with the new string
    - After state update, restore focus to input and set cursor after inserted text

    Preview rendering:
    - Split subject string on `{{...}}` pattern using regex
    - For each `{{variable}}` match, render a styled pill span
    - For plain text segments, render as-is
    - Use the AVAILABLE_PLACEHOLDERS list to get display labels for known variables

    Per user decision: Subject is plain text only (no rich text formatting). Placeholder pills are styled the same as body pills.
  </action>
  <verify>
    - Component renders an input field and a placeholder dropdown button
    - Selecting a placeholder inserts `{{variable_name}}` at cursor position in the input
    - Preview row below the input shows `{{variable}}` patterns as styled pills
    - onChange callback is fired with the updated subject string
    - TypeScript compiles without errors
  </verify>
  <done>Subject line editor allows plain text input with placeholder insertion via dropdown button, and shows a visual preview with pills for placeholders</done>
</task>

</tasks>

<verification>
- Editor component loads without SSR hydration errors (immediatelyRender: false)
- Toolbar buttons toggle bold/italic/lists formatting
- Link button prompts for URL and creates clickable link
- PlaceholderDropdown lists all 6 AVAILABLE_PLACEHOLDERS variables
- Clicking a placeholder inserts an atomic pill in the editor body
- Pasting formatted text produces plain text only
- Subject line editor inserts {{variable}} at cursor, preview shows pills
- No TypeScript compilation errors
</verification>

<success_criteria>
All four editor UI components exist and are ready for composition: TipTap editor wrapper (with extensions registered), formatting toolbar (bold, italic, lists, links), placeholder dropdown (reusable), and subject line editor (plain text + pills). The editor correctly handles placeholder insertion, paste stripping, and toolbar formatting.
</success_criteria>

<output>
After completion, create `.planning/phases/05-rich-text-editor---templates/05-03-SUMMARY.md`
</output>
