---
phase: 05-rich-text-editor---templates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/validations/email-template.ts
  - app/api/email-templates/route.ts
  - app/api/email-templates/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "API can create a new email template with name, subject, and body_json"
    - "API can list all email templates"
    - "API can fetch, update, and delete a single email template by ID"
  artifacts:
    - path: "lib/validations/email-template.ts"
      provides: "Zod schema for email_template create/update validation"
      exports: ["emailTemplateSchema", "EmailTemplateInput"]
    - path: "app/api/email-templates/route.ts"
      provides: "GET (list all) and POST (create) endpoints for email_templates"
      exports: ["GET", "POST"]
    - path: "app/api/email-templates/[id]/route.ts"
      provides: "GET (single), PUT (update), DELETE endpoints for email_templates"
      exports: ["GET", "PUT", "DELETE"]
  key_links:
    - from: "app/api/email-templates/route.ts"
      to: "email_templates table"
      via: "Supabase client"
      pattern: "supabase.*from.*email_templates"
    - from: "app/api/email-templates/[id]/route.ts"
      to: "email_templates table"
      via: "Supabase client"
      pattern: "supabase.*from.*email_templates"
    - from: "app/api/email-templates/route.ts"
      to: "lib/validations/email-template.ts"
      via: "Zod validation on POST body"
      pattern: "emailTemplateSchema.parse"
---

<objective>
Create the API routes and validation schema for v1.1 email_templates CRUD, enabling the template editor to save, load, list, and delete standalone email templates stored with TipTap JSON bodies.

Purpose: The template editor UI (Plan 03-04) needs backend endpoints to persist templates. These API routes operate on the new email_templates table created in Phase 4, using TipTap JSON for body storage.

Output: Zod validation schema, GET/POST route for listing and creating, GET/PUT/DELETE route for individual template operations.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@lib/types/database.ts (EmailTemplate, TipTapDocument, TipTapNode)
@lib/validations/template.ts (existing v1.0 template validation — reference for patterns)
@app/api/templates/route.ts (existing v1.0 template API — reference for Supabase patterns)
@app/api/templates/[id]/route.ts (existing v1.0 single template API — reference)
@lib/supabase/server.ts (createClient function)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod validation schema for email_template</name>
  <files>
    lib/validations/email-template.ts
  </files>
  <action>
    Create `lib/validations/email-template.ts`:
    - Import `z` from `zod`
    - Define `tipTapNodeSchema` as a recursive Zod schema:
      - `type: z.string()`
      - `content: z.lazy(() => z.array(tipTapNodeSchema)).optional()`
      - `text: z.string().optional()`
      - `attrs: z.record(z.unknown()).optional()`
      - `marks: z.array(z.object({ type: z.string(), attrs: z.record(z.unknown()).optional() })).optional()`
    - Define `tipTapDocumentSchema`:
      - `type: z.literal('doc')`
      - `content: z.array(tipTapNodeSchema)`
    - Define `emailTemplateSchema`:
      - `name: z.string().min(1, "Name is required").max(100, "Name must be 100 characters or less")`
      - `subject: z.string().min(1, "Subject is required").max(200, "Subject must be 200 characters or less")`
      - `body_json: tipTapDocumentSchema`
      - `is_active: z.boolean().default(true)`
    - Export `emailTemplateSchema` and `type EmailTemplateInput = z.infer<typeof emailTemplateSchema>`
  </action>
  <verify>
    - File exports emailTemplateSchema and EmailTemplateInput type
    - Schema validates correct TipTap JSON structure: `{ type: 'doc', content: [{ type: 'paragraph', content: [{ type: 'text', text: 'hello' }] }] }`
    - Schema rejects missing name or subject
  </verify>
  <done>Zod schema validates email_template input with TipTap JSON body structure</done>
</task>

<task type="auto">
  <name>Task 2: Create API routes for email_templates CRUD</name>
  <files>
    app/api/email-templates/route.ts
    app/api/email-templates/[id]/route.ts
  </files>
  <action>
    1. Create `app/api/email-templates/route.ts`:
       - Import `createClient` from `@/lib/supabase/server`, `NextResponse` from `next/server`, and the validation schema
       - `GET` handler: Query `email_templates` table ordered by `created_at` desc, return JSON array. No joins needed.
       - `POST` handler:
         1. Parse request body
         2. Validate with `emailTemplateSchema.parse(body)`
         3. Insert into `email_templates` table with fields: name, subject, body_json, is_active
         4. Return 201 with created template
         5. Catch validation errors -> return 400, other errors -> return 500
       - Follow existing API pattern from `app/api/templates/route.ts`

    2. Create `app/api/email-templates/[id]/route.ts`:
       - `GET` handler: Fetch single template by ID from `email_templates` where `id = params.id`. Return 404 if not found.
       - `PUT` handler:
         1. Parse and validate body with `emailTemplateSchema.parse(body)`
         2. Update `email_templates` where `id = params.id` with name, subject, body_json, is_active
         3. Return updated template. Return 404 if no rows updated.
       - `DELETE` handler:
         1. Delete from `email_templates` where `id = params.id`
         2. Return 200 on success. Return 404 if not found.
         3. Handle FK constraint error from schedule_steps gracefully: if delete fails due to ON DELETE RESTRICT, return 409 with message "Template is in use by a schedule and cannot be deleted"
       - Follow pattern from existing `app/api/templates/[id]/route.ts`

    NOTE: These are NEW routes at `/api/email-templates/` (NOT the existing `/api/templates/` which handles v1.0 reminder_templates). Both coexist.
  </action>
  <verify>
    - Both route files export proper HTTP method handlers (GET, POST, PUT, DELETE)
    - Routes query `email_templates` table (NOT `reminder_templates`)
    - POST validates input with emailTemplateSchema before insert
    - DELETE handles FK constraint error (409 response)
    - TypeScript compiles without errors
  </verify>
  <done>API routes provide full CRUD for email_templates table: list all, create, get by ID, update, and delete (with FK protection)</done>
</task>

</tasks>

<verification>
- `lib/validations/email-template.ts` exports emailTemplateSchema with name, subject, body_json, is_active fields
- `app/api/email-templates/route.ts` handles GET (list) and POST (create)
- `app/api/email-templates/[id]/route.ts` handles GET (single), PUT (update), DELETE
- All routes use Supabase client to query `email_templates` table
- POST/PUT validate body with Zod schema
- DELETE returns 409 if template is referenced by schedule_steps (ON DELETE RESTRICT)
</verification>

<success_criteria>
Complete CRUD API exists for v1.1 email_templates. Templates can be created with TipTap JSON bodies, listed, fetched individually, updated, and deleted (with FK protection). API routes are at /api/email-templates/ separate from v1.0 /api/templates/ routes.
</success_criteria>

<output>
After completion, create `.planning/phases/05-rich-text-editor---templates/05-02-SUMMARY.md`
</output>
