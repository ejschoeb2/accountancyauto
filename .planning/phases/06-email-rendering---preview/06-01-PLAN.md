---
phase: 06-email-rendering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/email/tiptap-extensions.ts
  - lib/email/render-tiptap.ts
  - lib/email/templates/reminder.tsx
  - lib/email/sender.ts
  - lib/email/render-tiptap.test.ts
autonomous: true

must_haves:
  truths:
    - "TipTap JSON content from the database converts to valid HTML with bold, italic, lists, links, and placeholder nodes preserved"
    - "Placeholder variables in rendered HTML are replaced with client data, with safe fallback text when data is missing"
    - "All links in rendered email open in new tab with rel=noopener noreferrer"
    - "Output HTML has all CSS styles inlined (no classes or stylesheet references)"
    - "Rendered email HTML stays compact (render with pretty: false to avoid Gmail 102KB clipping)"
  artifacts:
    - path: "lib/email/tiptap-extensions.ts"
      provides: "Shared TipTap extensions config used by both editor (Phase 5) and server-side renderer"
      exports: ["getSharedExtensions"]
    - path: "lib/email/render-tiptap.ts"
      provides: "Complete rendering pipeline: TipTap JSON -> HTML -> variable substitution -> React Email -> inline-styled email HTML"
      exports: ["renderTipTapEmail"]
    - path: "lib/email/templates/reminder.tsx"
      provides: "Updated React Email template accepting HTML body content via dangerouslySetInnerHTML"
      exports: ["default"]
    - path: "lib/email/sender.ts"
      provides: "Updated sender accepting rich HTML body and generating plain text fallback"
      exports: ["sendReminderEmail"]
    - path: "lib/email/render-tiptap.test.ts"
      provides: "Tests proving rendering pipeline correctness"
  key_links:
    - from: "lib/email/render-tiptap.ts"
      to: "lib/email/tiptap-extensions.ts"
      via: "imports getSharedExtensions"
      pattern: "getSharedExtensions"
    - from: "lib/email/render-tiptap.ts"
      to: "lib/templates/variables.ts"
      via: "imports substituteVariables for placeholder replacement"
      pattern: "substituteVariables"
    - from: "lib/email/render-tiptap.ts"
      to: "lib/email/templates/reminder.tsx"
      via: "renders ReminderEmail with HTML body"
      pattern: "ReminderEmail"
    - from: "lib/email/sender.ts"
      to: "lib/email/render-tiptap.ts"
      via: "imports renderTipTapEmail to generate HTML for Postmark"
      pattern: "renderTipTapEmail"
---

<objective>
Build the email rendering pipeline that converts TipTap JSON content (stored in email_templates.body_json) into email-safe HTML with inline styles, suitable for delivery via Postmark to Gmail, Outlook, and Apple Mail.

Purpose: This is the critical bridge between the rich text editor (Phase 5) and email delivery. Without this pipeline, TipTap JSON content cannot be sent as emails. The existing v1.0 pipeline handles plain text only; this phase upgrades it to handle rich text with formatting, links, and placeholder substitution.

Output: A `renderTipTapEmail()` function that takes TipTap JSON + client context and returns fully rendered, inline-styled email HTML ready for Postmark delivery. Updated sender and React Email template to support HTML content.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-email-rendering---preview/06-RESEARCH.md
@lib/email/sender.ts
@lib/email/templates/reminder.tsx
@lib/email/client.ts
@lib/templates/variables.ts
@lib/templates/variables.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared extensions config and rendering pipeline</name>
  <files>
    lib/email/tiptap-extensions.ts
    lib/email/render-tiptap.ts
    lib/email/templates/reminder.tsx
    lib/email/sender.ts
  </files>
  <action>
    **Step 1: Create `lib/email/tiptap-extensions.ts` -- shared TipTap extensions config**

    Export a `getSharedExtensions()` function that returns the exact same extensions list used by the editor (Phase 5 will import this too). This is CRITICAL: the extensions passed to `generateHTML()` MUST match the editor's extensions, or rendering silently drops nodes.

    Extensions to include:
    - `StarterKit` configured with: heading: false, blockquote: false, codeBlock: false, horizontalRule: false, code: false, strike: false (keep bold, italic, bulletList, orderedList, listItem, paragraph, document, text)
    - `Link` configured with: openOnClick: false, HTMLAttributes: { target: '_blank', rel: 'noopener noreferrer' } (per user decision: all links open in new tab)
    - A `PlaceholderNode` extension (Node.create) that is inline, atom: true, group: 'inline', with attributes `id` and `label`. Its `renderHTML` method must output `{{id}}` as text content inside a span -- this ensures generateHTML produces `{{client_name}}` etc. which substituteVariables can then replace.

    The PlaceholderNode renderHTML should output:
    ```
    ['span', { 'data-type': 'placeholder', 'data-id': attributes.id }, `{{${attributes.id}}}`]
    ```

    This means generateHTML will produce `<span data-type="placeholder" data-id="client_name">{{client_name}}</span>`. The substituteVariables regex `\{\{(\w+)\}\}` will then replace the inner text. After substitution, the span wrapper is harmless.

    **Step 2: Create `lib/email/render-tiptap.ts` -- the complete rendering pipeline**

    Export a single function:

    ```typescript
    export async function renderTipTapEmail(params: {
      bodyJson: Record<string, any>;    // TipTap JSON content
      subject: string;                   // Subject line (may contain {{placeholders}})
      context: Partial<TemplateContext>; // Client data for variable substitution
    }): Promise<{ html: string; text: string; subject: string }>
    ```

    Pipeline steps inside this function:
    1. **Validate JSON** -- wrap generateHTML in try-catch. If bodyJson is malformed, throw a descriptive error ("Invalid template content: ...").
    2. **Convert TipTap JSON to raw HTML** -- call `generateHTML(bodyJson, getSharedExtensions())` from `@tiptap/html`.
    3. **Build safe context with fallbacks** (per user decision: show fallback text if data missing):
       - `client_name` -> `context.client_name || '[Client Name]'`
       - `deadline` -> `context.deadline || new Date()` (use current date as fallback)
       - `filing_type` -> `context.filing_type || '[Filing Type]'`
       - `accountant_name` -> `context.accountant_name || 'Peninsula Accounting'`
    4. **Substitute variables** -- call existing `substituteVariables(rawHtml, safeContext)` to replace `{{placeholders}}` in the HTML body. Also substitute in subject line: `substituteVariables(subject, safeContext)`.
    5. **Render via React Email** -- call `render(ReminderEmail({ subject: resolvedSubject, htmlBody: resolvedHtml }), { pretty: false })`. The `pretty: false` keeps output compact to avoid Gmail's 102KB clipping threshold.
    6. **Generate plain text fallback** -- strip HTML tags from the resolved HTML for the TextBody. A simple regex `html.replace(/<[^>]+>/g, '')` is sufficient; this is just a fallback, not the primary content. Replace `</p>` and `<br>` with newlines before stripping.
    7. **Return** `{ html: renderedHtml, text: plainText, subject: resolvedSubject }`.

    Import from:
    - `@tiptap/html` -> `generateHTML`
    - `./tiptap-extensions` -> `getSharedExtensions`
    - `@/lib/templates/variables` -> `substituteVariables`, `TemplateContext`
    - `@react-email/render` -> `render`
    - `./templates/reminder` -> `ReminderEmail`

    **Step 3: Update `lib/email/templates/reminder.tsx` -- accept HTML body**

    Modify the ReminderEmail component to support BOTH plain text (v1.0 backwards compatibility) and HTML body (v1.1 rich text):

    - Change props interface to:
      ```typescript
      interface ReminderEmailProps {
        subject: string;
        // v1.0: plain text body (used by existing queue)
        body?: string;
        clientName?: string;
        filingType?: string;
        // v1.1: pre-rendered HTML body (from renderTipTapEmail)
        htmlBody?: string;
      }
      ```
    - In the main content section:
      - If `htmlBody` is provided, render it inside a `<Section>` using `dangerouslySetInnerHTML={{ __html: htmlBody }}` wrapped in a div. Apply base email styles to the wrapper div: `color: '#333333', fontSize: '14px', lineHeight: '1.6'`. These base styles will be inlined by React Email's render().
      - If `htmlBody` is NOT provided (v1.0 fallback), render the existing plain text layout with clientName, body, filingType as currently implemented.
    - Add `<meta charSet="UTF-8" />` inside the `<Head>` component for proper character encoding.
    - Remove the "Filing Type" line when using htmlBody (templates handle their own content).
    - Keep the header branding and footer unchanged.

    **Step 4: Update `lib/email/sender.ts` -- support rich text sending**

    Add a new function alongside the existing one (do NOT break the existing v1.0 function -- the cron queue still uses it):

    ```typescript
    export async function sendRichEmail(params: {
      to: string;
      subject: string;
      html: string;  // Pre-rendered HTML from renderTipTapEmail
      text: string;  // Plain text fallback from renderTipTapEmail
    }): Promise<SendReminderEmailResult>
    ```

    This function:
    - Sends via `postmarkClient.sendEmail()` with the provided HtmlBody and TextBody directly (no React Email rendering needed -- it was already done by renderTipTapEmail)
    - Uses same From, ReplyTo, MessageStream, TrackOpens, TrackLinks settings as existing sendReminderEmail
    - Same error handling pattern

    Do NOT modify the existing `sendReminderEmail` function. It must continue working for the v1.0 cron queue until Phase 9 rewires it.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify all TypeScript compiles without errors.
    Run `npm run build` to verify no build errors.
  </verify>
  <done>
    - `lib/email/tiptap-extensions.ts` exports `getSharedExtensions()` returning StarterKit + Link + PlaceholderNode
    - `lib/email/render-tiptap.ts` exports `renderTipTapEmail()` that takes TipTap JSON + context and returns {html, text, subject}
    - `lib/email/templates/reminder.tsx` accepts both plain text body (v1.0) and htmlBody (v1.1)
    - `lib/email/sender.ts` exports `sendRichEmail()` alongside existing `sendReminderEmail()` (v1.0 untouched)
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Test the rendering pipeline</name>
  <files>
    lib/email/render-tiptap.test.ts
  </files>
  <action>
    Create `lib/email/render-tiptap.test.ts` using vitest (project convention from `lib/templates/variables.test.ts`).

    **Test cases to implement:**

    1. **Basic rendering** -- Pass minimal TipTap JSON (a single paragraph with text), verify output contains the text in an HTML string with inline styles.

    2. **Bold and italic formatting** -- Pass TipTap JSON with bold and italic marks, verify output contains `<strong>` and `<em>` tags.

    3. **Placeholder substitution** -- Pass TipTap JSON containing a placeholder node (type: 'placeholder', attrs: { id: 'client_name', label: 'Client Name' }), provide context with client_name: 'ABC Ltd', verify output contains 'ABC Ltd' (not '{{client_name}}').

    4. **Fallback text for missing data** -- Pass TipTap JSON with a client_name placeholder but provide empty context (no client_name), verify output contains '[Client Name]' fallback text.

    5. **Subject line substitution** -- Pass subject '{{filing_type}} reminder for {{client_name}}' with context, verify resolved subject has actual values.

    6. **Link attributes** -- Pass TipTap JSON containing a link node, verify output contains `target="_blank"` and `rel="noopener noreferrer"`.

    7. **Plain text fallback generation** -- Verify the returned `text` field contains readable text without HTML tags.

    8. **Malformed JSON handling** -- Pass invalid TipTap JSON (e.g., `{ type: 'invalid' }`), verify function throws with a descriptive error message.

    9. **Multiple placeholders** -- Pass TipTap JSON with client_name and deadline placeholders, verify both are substituted correctly.

    10. **Bullet list rendering** -- Pass TipTap JSON with a bulletList, verify output contains `<ul>` and `<li>` tags.

    **TipTap JSON test fixtures:**

    For reference, minimal TipTap JSON for a paragraph looks like:
    ```json
    {
      "type": "doc",
      "content": [
        {
          "type": "paragraph",
          "content": [
            { "type": "text", "text": "Hello world" }
          ]
        }
      ]
    }
    ```

    A placeholder node in TipTap JSON:
    ```json
    {
      "type": "placeholder",
      "attrs": { "id": "client_name", "label": "Client Name" }
    }
    ```

    A bold text mark:
    ```json
    {
      "type": "text",
      "marks": [{ "type": "bold" }],
      "text": "important"
    }
    ```

    A link mark:
    ```json
    {
      "type": "text",
      "marks": [{ "type": "link", "attrs": { "href": "https://example.com" } }],
      "text": "click here"
    }
    ```

    The test should import `renderTipTapEmail` from `./render-tiptap` and run it with these fixtures.

    Use `describe('renderTipTapEmail', () => { ... })` grouping. Each test should be a focused `it()` block that tests one behavior.
  </action>
  <verify>
    Run `npm test` (vitest run). All tests in render-tiptap.test.ts must pass.
    Run `npm test -- --reporter=verbose` to see individual test names and results.
  </verify>
  <done>
    - All 10 test cases pass
    - Tests cover: basic rendering, formatting marks, placeholder substitution, fallback text, subject substitution, link attributes, plain text generation, error handling, multiple placeholders, list rendering
    - `npm test` exits 0 with no failures
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- TypeScript compiles cleanly
2. `npm test` -- All tests pass including new render-tiptap tests and existing variables tests
3. `npm run build` -- Next.js build succeeds (no import/export errors)
4. Manual verification: The existing `sendReminderEmail` function is UNCHANGED -- grep for it and confirm it still takes {to, subject, body, clientName, filingType}
</verification>

<success_criteria>
- renderTipTapEmail() converts TipTap JSON with formatting, links, and placeholders to inline-styled email HTML
- Placeholder variables are replaced with client data, with fallback text for missing values
- Links have target="_blank" and rel="noopener noreferrer"
- React Email render produces inline styles (no class references in output)
- Plain text fallback is generated for email clients that don't render HTML
- v1.0 email sending pipeline is completely untouched (backwards compatible)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-email-rendering---preview/06-01-SUMMARY.md`
</output>
