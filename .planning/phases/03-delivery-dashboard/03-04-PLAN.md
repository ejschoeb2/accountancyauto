---
phase: 03-delivery-dashboard
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - lib/dashboard/traffic-light.ts
  - lib/dashboard/metrics.ts
  - app/(dashboard)/dashboard/page.tsx
  - app/(dashboard)/dashboard/components/summary-cards.tsx
  - app/(dashboard)/dashboard/components/client-status-table.tsx
  - app/(dashboard)/dashboard/components/traffic-light-badge.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard page at /dashboard shows summary cards with key metrics"
    - "Client status list shows traffic-light indicators (green/amber/red/grey) with correct logic"
    - "GREEN means records received, AMBER means actively chasing, RED means overdue, GREY means paused or inactive"
    - "Summary cards show overdue count, actively chasing count, sent today count, and paused clients count"
    - "Data loads on page visit with manual refresh button (no auto-polling)"
  artifacts:
    - path: "lib/dashboard/traffic-light.ts"
      provides: "Traffic-light status calculation logic"
      exports: ["calculateClientStatus", "TrafficLightStatus"]
    - path: "lib/dashboard/metrics.ts"
      provides: "Dashboard summary metrics queries"
      exports: ["getDashboardMetrics"]
    - path: "app/(dashboard)/dashboard/page.tsx"
      provides: "Main dashboard page"
      min_lines: 30
    - path: "app/(dashboard)/dashboard/components/summary-cards.tsx"
      provides: "Summary metric cards"
      contains: "Overdue"
    - path: "app/(dashboard)/dashboard/components/client-status-table.tsx"
      provides: "Client list with traffic-light indicators"
      contains: "TrafficLightBadge"
    - path: "app/(dashboard)/dashboard/components/traffic-light-badge.tsx"
      provides: "Traffic-light Badge component"
      contains: "green.*amber.*red.*grey"
  key_links:
    - from: "app/(dashboard)/dashboard/page.tsx"
      to: "lib/dashboard/metrics.ts"
      via: "server component calls getDashboardMetrics"
      pattern: "getDashboardMetrics"
    - from: "app/(dashboard)/dashboard/components/client-status-table.tsx"
      to: "lib/dashboard/traffic-light.ts"
      via: "calculates status for each client row"
      pattern: "calculateClientStatus"
    - from: "app/(dashboard)/dashboard/components/client-status-table.tsx"
      to: "app/(dashboard)/dashboard/components/traffic-light-badge.tsx"
      via: "renders badge for each client"
      pattern: "TrafficLightBadge"
---

<objective>
Build the dashboard page with summary metric cards and client status list featuring traffic-light indicators.

Purpose: The dashboard is the accountant's primary monitoring view -- at a glance they can see which clients are overdue, being chased, or on track. This becomes the landing page after login.
Output: /dashboard page with 4 summary cards and a client status table with traffic-light badges.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-delivery-dashboard/03-CONTEXT.md
@.planning/phases/03-delivery-dashboard/03-RESEARCH.md
@app/(dashboard)/layout.tsx
@supabase/migrations/create_phase2_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create traffic-light logic and dashboard metrics</name>
  <files>
lib/dashboard/traffic-light.ts
lib/dashboard/metrics.ts
  </files>
  <action>
Create `lib/dashboard/traffic-light.ts`:

Export type TrafficLightStatus = 'green' | 'amber' | 'red' | 'grey'

Export function calculateClientStatus for a single client. The function receives client data and returns a TrafficLightStatus.

Input type:
```typescript
interface ClientStatusInput {
  reminders_paused: boolean;
  records_received_for: string[]; // array of filing_type_id strings
  filings: Array<{
    filing_type_id: string;
    deadline_date: string; // ISO date
    has_been_sent: boolean; // whether any reminder has been sent for this filing
  }>;
}
```

Logic per user decision (these are LOCKED -- implement exactly):
- GREY: Client has reminders_paused = true OR filings array is empty (paused or no active deadlines)
- RED: ANY filing where deadline_date < today AND filing_type_id NOT in records_received_for (deadline passed, records not received)
- AMBER: ANY filing where has_been_sent = true AND filing_type_id NOT in records_received_for AND deadline NOT passed (actively chasing)
- GREEN: All filings either have records received OR no reminders sent yet and deadline not passed

Priority order: grey > red > amber > green (check in this order, first match wins)

Create `lib/dashboard/metrics.ts`:

Export async function getDashboardMetrics(supabase: SupabaseClient) that returns:
```typescript
interface DashboardMetrics {
  overdueCount: number;      // RED clients
  chasingCount: number;      // AMBER clients
  sentTodayCount: number;    // emails sent today from email_log
  pausedCount: number;       // clients with reminders_paused = true
  failedDeliveryCount: number; // email_log entries with delivery_status = 'failed' or 'bounced'
}
```

Query strategy:
1. Fetch all active clients with their filing assignments, deadline data, and reminder queue status
2. For each client, use calculateClientStatus to determine traffic-light state
3. Count RED clients -> overdueCount, AMBER -> chasingCount
4. Query email_log for today's sent count: `.eq('delivery_status', 'sent').gte('sent_at', todayStart)`
5. Query clients for pausedCount: `.eq('reminders_paused', true).eq('active', true)`
6. Query email_log for failedDeliveryCount: `.in('delivery_status', ['failed', 'bounced'])`

Also export async function getClientStatusList(supabase: SupabaseClient) that returns an array of:
```typescript
interface ClientStatusRow {
  id: string;
  company_name: string;
  status: TrafficLightStatus;
  next_deadline: string | null;  // earliest upcoming deadline date
  days_until_deadline: number | null;
}
```

For the client status list, query:
- All active clients
- Their filing assignments with calculated deadlines (from client_deadline_overrides or calculated)
- Their reminder_queue entries to determine if reminders have been sent
- Their records_received_for
- Sort by: RED first, then AMBER, then GREEN, then GREY (priority sorting)
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Check that calculateClientStatus returns correct status for each scenario: paused -> grey, overdue -> red, chasing -> amber, clear -> green.
  </verify>
  <done>
Traffic-light logic correctly implements the 4-state system per user decision. getDashboardMetrics returns all 5 metric counts. getClientStatusList returns sorted client rows with status and next deadline.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build dashboard page with summary cards and client status table</name>
  <files>
app/(dashboard)/dashboard/page.tsx
app/(dashboard)/dashboard/components/summary-cards.tsx
app/(dashboard)/dashboard/components/client-status-table.tsx
app/(dashboard)/dashboard/components/traffic-light-badge.tsx
  </files>
  <action>
Create `app/(dashboard)/dashboard/components/traffic-light-badge.tsx`:
- Client component accepting status: TrafficLightStatus prop
- Use shadcn Badge component (already installed)
- Color mapping:
  - green: bg-green-500 text-white, label "On Track"
  - amber: bg-amber-500 text-white, label "Chasing"
  - red: bg-red-500 text-white (or use destructive variant), label "Overdue"
  - grey: bg-gray-300 text-gray-600, label "Inactive"
- Include aria-label for accessibility: `Status: {label}`

Create `app/(dashboard)/dashboard/components/summary-cards.tsx`:
- Client component accepting metrics: DashboardMetrics prop
- Use shadcn Card, CardHeader, CardTitle, CardContent (already installed)
- 4-column responsive grid: `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4`
- Cards per user decision (summary cards at top with key metrics):
  1. "Overdue Clients" - metrics.overdueCount in text-red-600 with large font
  2. "Actively Chasing" - metrics.chasingCount in text-amber-600
  3. "Sent Today" - metrics.sentTodayCount in text-blue-600
  4. "Paused Clients" - metrics.pausedCount in text-gray-600
- If failedDeliveryCount > 0, show a warning banner below the cards:
  - Yellow/amber background with warning icon
  - Text: "{N} reminder(s) failed to deliver" (per user decision -- failed/bounced warning banner)
  - Link or button to view audit log for details
  - Make this dismissible (store dismissed state in React state -- reappears on page refresh per Claude's discretion)

Create `app/(dashboard)/dashboard/components/client-status-table.tsx`:
- Client component accepting clients: ClientStatusRow[] prop
- Use shadcn Table, TableHeader, TableBody, TableRow, TableHead, TableCell
- Columns per user decision (essential columns only):
  1. Client Name (company_name, link to /clients/{id})
  2. Status (TrafficLightBadge component)
  3. Next Deadline (formatted date or "N/A")
  4. Days Until Deadline (number or "Overdue" in red if negative, "N/A" if null)
- Include a refresh button that reloads the page (manual refresh per user decision)
- Default sort: by status priority (red > amber > green > grey), then by days_until_deadline ascending (most urgent first)

Create `app/(dashboard)/dashboard/page.tsx`:
- Server component (data loads on page visit per user decision)
- Import createClient from @/lib/supabase/server
- Call getDashboardMetrics and getClientStatusList
- Render:
  1. Page header: "Dashboard" with subtitle "Monitor client reminders and filing status"
  2. SummaryCards component with metrics (includes warning banner if failed deliveries)
  3. ClientStatusTable component with client list
- Manual refresh: the refresh button in ClientStatusTable does router.refresh() or window.location.reload()
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Run `npm run build` to verify the page builds. Navigate to /dashboard in dev server to confirm it renders (will show empty state with no data).
  </verify>
  <done>
Dashboard page renders at /dashboard with 4 summary cards (overdue, chasing, sent today, paused), failed delivery warning banner when applicable, and client status table with traffic-light badges. Data loads on page visit. Refresh button available.
  </done>
</task>

</tasks>

<verification>
- /dashboard page loads with summary cards and client status table
- Traffic-light badges show correct colors and labels
- Summary cards display 4 key metrics
- Failed delivery banner appears when failedDeliveryCount > 0
- Client rows link to /clients/{id}
- Sort order: red first, then amber, green, grey
- Manual refresh button works
- `npx tsc --noEmit` passes
- `npm run build` succeeds
</verification>

<success_criteria>
Dashboard page is complete with summary metric cards showing overdue/chasing/sent/paused counts, a warning banner for failed deliveries, and a client status table with traffic-light indicators sorted by urgency. The page loads data on visit with a manual refresh button.
</success_criteria>

<output>
After completion, create `.planning/phases/03-delivery-dashboard/03-04-SUMMARY.md`
</output>
