---
phase: 03-delivery-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/create_phase3_schema.sql
  - lib/email/client.ts
  - lib/email/sender.ts
  - lib/email/templates/reminder.tsx
autonomous: true
user_setup:
  - service: postmark
    why: "Transactional email delivery"
    env_vars:
      - name: POSTMARK_SERVER_TOKEN
        source: "Postmark Dashboard -> Servers -> [Your Server] -> API Tokens -> Server API Token"
      - name: POSTMARK_WEBHOOK_SECRET
        source: "Postmark Dashboard -> Servers -> [Your Server] -> Webhooks -> Create webhook -> copy webhook secret"
      - name: ACCOUNTANT_EMAIL
        source: "The accountant's real email address for Reply-To header (e.g., info@peninsulaaccounting.co.uk)"

must_haves:
  truths:
    - "email_log table exists in database with columns for tracking sent emails and delivery status"
    - "Postmark SDK client is configured and ready to send emails"
    - "HTML email template renders Peninsula Accounting branded emails with inline CSS"
    - "Sender function accepts reminder data and returns Postmark message ID"
  artifacts:
    - path: "supabase/migrations/create_phase3_schema.sql"
      provides: "email_log table with delivery tracking columns"
      contains: "CREATE TABLE email_log"
    - path: "lib/email/client.ts"
      provides: "Postmark ServerClient singleton"
      contains: "ServerClient"
    - path: "lib/email/sender.ts"
      provides: "sendReminderEmail function"
      exports: ["sendReminderEmail"]
    - path: "lib/email/templates/reminder.tsx"
      provides: "React Email reminder template with Peninsula Accounting branding"
      contains: "Peninsula Accounting"
  key_links:
    - from: "lib/email/sender.ts"
      to: "lib/email/client.ts"
      via: "imports Postmark client"
      pattern: "import.*client"
    - from: "lib/email/sender.ts"
      to: "lib/email/templates/reminder.tsx"
      via: "renders template to HTML"
      pattern: "render.*ReminderEmail"
---

<objective>
Create the email infrastructure foundation for Phase 3: database schema for email logging, Postmark client configuration, branded HTML email template using React Email, and the core sender function.

Purpose: Every other Phase 3 plan depends on the email_log table and sender function. This plan establishes the data layer and email pipeline that the send-emails cron, webhook handler, and dashboard will all use.
Output: email_log migration SQL, Postmark client singleton, React Email reminder template, and sendReminderEmail function.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-delivery-dashboard/03-RESEARCH.md
@supabase/migrations/create_phase1_schema.sql
@supabase/migrations/create_phase2_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email_log table migration and install dependencies</name>
  <files>supabase/migrations/create_phase3_schema.sql</files>
  <action>
Install the new npm dependencies:
```
npm install postmark @react-email/components @react-email/render
```

Create `supabase/migrations/create_phase3_schema.sql` with the email_log table. The table must track:
- id: UUID primary key (uuid_generate_v4)
- reminder_queue_id: UUID FK to reminder_queue(id) ON DELETE SET NULL (nullable -- keeps log even if queue entry deleted)
- client_id: UUID FK to clients(id) ON DELETE CASCADE (NOT NULL)
- filing_type_id: TEXT FK to filing_types(id) ON DELETE SET NULL
- postmark_message_id: TEXT (Postmark's MessageID for tracking)
- recipient_email: TEXT NOT NULL
- subject: TEXT NOT NULL
- sent_at: TIMESTAMPTZ NOT NULL DEFAULT now()
- delivery_status: TEXT NOT NULL DEFAULT 'sent' CHECK (status IN ('sent', 'delivered', 'bounced', 'failed'))
- bounce_type: TEXT (nullable -- 'HardBounce', 'SoftBounce', etc. from Postmark)
- bounce_description: TEXT (nullable -- reason from Postmark)
- delivered_at: TIMESTAMPTZ (nullable)
- created_at: TIMESTAMPTZ DEFAULT now()
- updated_at: TIMESTAMPTZ DEFAULT now()

Add indexes:
- idx_email_log_client_id ON email_log(client_id)
- idx_email_log_sent_at ON email_log(sent_at DESC)
- idx_email_log_delivery_status ON email_log(delivery_status)
- idx_email_log_postmark_message_id ON email_log(postmark_message_id)

Add updated_at trigger (reuse existing update_updated_at function from Phase 1).

Add RLS policies matching the pattern from Phase 1 and 2:
- Authenticated users can read email_log
- Authenticated users can modify email_log
- Service role full access to email_log

Follow the exact same SQL style and conventions as create_phase1_schema.sql and create_phase2_schema.sql.
  </action>
  <verify>
Review the SQL file: check that email_log table has all columns, proper FK references, indexes, RLS policies, and updated_at trigger. Verify npm packages installed by checking package.json for postmark, @react-email/components, @react-email/render.
  </verify>
  <done>
email_log migration SQL exists with correct schema. postmark, @react-email/components, and @react-email/render are in package.json dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Postmark client, React Email template, and sender function</name>
  <files>
lib/email/client.ts
lib/email/sender.ts
lib/email/templates/reminder.tsx
  </files>
  <action>
Create `lib/email/client.ts`:
- Import ServerClient from 'postmark'
- Export a singleton Postmark client: `new ServerClient(process.env.POSTMARK_SERVER_TOKEN!)`
- Add a comment noting the env var must be set

Create `lib/email/templates/reminder.tsx`:
- Use @react-email/components: Html, Head, Body, Container, Section, Heading, Text
- Props interface: { clientName: string; subject: string; body: string; filingType: string }
- Peninsula Accounting branding per user decision:
  - Logo at top (use placeholder URL https://peninsulaaccounting.co.uk/logo.png or a text fallback)
  - Professional layout with 600px max-width container
  - Font: Arial, sans-serif
  - Colors: #333333 headings, #666666 body text, #f4f4f4 background, #ffffff container
- Footer per user decision: "This is an automated reminder from Peninsula Accounting" -- NO unsubscribe link
- ALL styles must be inline (not external CSS) -- email client compatibility
- Export default function ReminderEmail

Create `lib/email/sender.ts`:
- Import the Postmark client from ./client
- Import render from @react-email/render
- Import ReminderEmail from ./templates/reminder
- Export async function sendReminderEmail(params: { to: string; subject: string; body: string; clientName: string; filingType: string }):
  - Render the React Email template to HTML string using `await render(ReminderEmail({...}))`
  - Send via Postmark client.sendEmail():
    - From: 'Peninsula Accounting <reminders@peninsulaaccounting.co.uk>' (per user decision -- practice name only)
    - To: params.to
    - ReplyTo: process.env.ACCOUNTANT_EMAIL || 'info@peninsulaaccounting.co.uk' (per user decision -- accountant's real email)
    - Subject: params.subject
    - HtmlBody: rendered HTML
    - TextBody: params.body (plain text fallback)
    - MessageStream: 'outbound'
    - TrackOpens: false
    - TrackLinks: 'None' as any
  - Return { messageId: result.MessageID, submittedAt: result.SubmittedAt, to: result.To }
  - Wrap in try/catch, log errors, re-throw with descriptive message
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation succeeds with no errors in the new files. Check that all three files exist with correct imports and exports.
  </verify>
  <done>
Postmark client singleton exports ServerClient instance. ReminderEmail template renders branded HTML with inline CSS, Peninsula Accounting footer, no unsubscribe link. sendReminderEmail function sends via Postmark with correct From/ReplyTo/MessageStream and returns messageId. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
- `supabase/migrations/create_phase3_schema.sql` contains email_log table with all required columns and RLS
- `lib/email/client.ts` exports configured Postmark ServerClient
- `lib/email/templates/reminder.tsx` renders Peninsula Accounting branded email with inline CSS
- `lib/email/sender.ts` exports sendReminderEmail that uses Postmark SDK
- `npx tsc --noEmit` passes with no errors
- `npm ls postmark @react-email/components @react-email/render` shows packages installed
</verification>

<success_criteria>
Email infrastructure is complete: database table ready for deployment, Postmark client configured, branded email template built with React Email, and sender function ready to be called by the cron job. All TypeScript compiles cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/03-delivery-dashboard/03-01-SUMMARY.md`
</output>
