---
phase: 09-queue-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260208100001_add_html_body_to_reminder_queue.sql
  - lib/reminders/queue-builder.ts
  - lib/reminders/scheduler.ts
  - app/api/cron/send-emails/route.ts
  - lib/types/database.ts
autonomous: true

must_haves:
  truths:
    - "Queue builder reads from schedules + schedule_steps + email_templates tables (not reminder_templates)"
    - "Queue builder resolves email content via schedule_step -> email_template FK path"
    - "Queue builder skips missing templates/schedules gracefully and logs to email_log"
    - "Scheduler renders pending reminders using renderTipTapEmail() and stores html_body"
    - "Send-emails cron uses sendRichEmail() to deliver HTML emails via Postmark"
    - "Postmark failures leave reminder as pending for retry on next cron run"
  artifacts:
    - path: "supabase/migrations/20260208100001_add_html_body_to_reminder_queue.sql"
      provides: "html_body TEXT column on reminder_queue"
      contains: "ALTER TABLE reminder_queue ADD COLUMN html_body"
    - path: "lib/reminders/queue-builder.ts"
      provides: "v1.1 queue builder reading from normalized tables"
      exports: ["buildReminderQueue", "rebuildQueueForClient", "cancelRemindersForReceivedRecords", "handleUnpauseClient"]
    - path: "lib/reminders/scheduler.ts"
      provides: "v1.1 scheduler with TipTap rendering"
      exports: ["processReminders"]
    - path: "app/api/cron/send-emails/route.ts"
      provides: "v1.1 email sender using sendRichEmail"
      exports: ["GET"]
  key_links:
    - from: "lib/reminders/queue-builder.ts"
      to: "schedules, schedule_steps, email_templates tables"
      via: "supabase queries with application-level joins"
      pattern: "from\\('schedules'\\)|from\\('schedule_steps'\\)|from\\('email_templates'\\)"
    - from: "lib/reminders/scheduler.ts"
      to: "lib/email/render-tiptap.ts"
      via: "renderTipTapEmail() call"
      pattern: "renderTipTapEmail"
    - from: "app/api/cron/send-emails/route.ts"
      to: "lib/email/sender.ts"
      via: "sendRichEmail() call"
      pattern: "sendRichEmail"
---

<objective>
Rewire the automated reminder cron system to read from v1.1 normalized tables (schedules, schedule_steps, email_templates) instead of the old reminder_templates JSONB structure. Use the v1.1 TipTap rendering pipeline for all email content.

Purpose: This is the core migration that switches the queue builder, scheduler, and email sender from v1.0 to v1.1 architecture. After this plan, all automated reminders flow through the new normalized tables and rich HTML rendering pipeline.

Output: Rewritten queue-builder.ts, scheduler.ts, send-emails/route.ts, plus a migration adding html_body column to reminder_queue.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@lib/reminders/queue-builder.ts
@lib/reminders/scheduler.ts
@app/api/cron/send-emails/route.ts
@lib/email/render-tiptap.ts
@lib/email/sender.ts
@lib/templates/variables.ts
@lib/types/database.ts
@lib/deadlines/calculators.ts
@lib/deadlines/working-days.ts
@lib/bank-holidays/cache.ts
@app/actions/audit-log.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add html_body column and rewrite queue builder</name>
  <files>
    supabase/migrations/20260208100001_add_html_body_to_reminder_queue.sql
    lib/reminders/queue-builder.ts
    lib/types/database.ts
  </files>
  <action>
    **Migration (20260208100001_add_html_body_to_reminder_queue.sql):**
    Create a migration that adds `html_body TEXT` column to the `reminder_queue` table. This column stores the v1.1 rich HTML content rendered by renderTipTapEmail(). Keep existing `resolved_body` for plain text fallback.

    ```sql
    ALTER TABLE reminder_queue ADD COLUMN IF NOT EXISTS html_body TEXT;
    ```

    **Types (lib/types/database.ts):**
    Add `html_body: string | null;` to the `ReminderQueueItem` interface, after `resolved_body`.

    **Queue Builder (lib/reminders/queue-builder.ts):**
    Complete rewrite of `buildReminderQueue()` and `rebuildQueueForClient()` to read from v1.1 tables. Keep `cancelRemindersForReceivedRecords()` and `handleUnpauseClient()` unchanged (they don't reference templates).

    Key changes to `buildReminderQueue()`:
    1. Remove ALL imports of old types: `ReminderTemplate`, `ClientTemplateOverride`, `TemplateStep`
    2. Remove import of `resolveTemplateForClient` from `lib/templates/inheritance`
    3. Replace `reminder_templates` query with three separate queries (per PostgREST FK join workaround):
       - `schedules` table (filter `is_active: true`)
       - `schedule_steps` table (order by `step_number` ascending)
       - `email_templates` table (filter `is_active: true`)
    4. Build lookup maps in application code:
       - `scheduleByFilingType`: Map filing_type_id -> schedule
       - `stepsBySchedule`: Map schedule_id -> ScheduleStep[]
       - `templateMap`: Map template_id -> EmailTemplate
    5. Remove ALL override fetching and processing: no `client_deadline_overrides`, no `client_template_overrides`, no `templateOverrideMap`, no `resolveTemplateForClient()`. Per user decision: no per-client overrides at all.
    6. Keep `client_deadline_overrides` fetch for deadline date calculation (these are deadline overrides, not template overrides -- they remain relevant).
    7. For each client+filing assignment:
       - Look up schedule by `filing_type_id` from `scheduleByFilingType` map
       - If no schedule found: insert warning to `email_log` table with `delivery_status: 'failed'` and `bounce_description: '[WARNING] No schedule found for filing type {id}'`, then skip
       - Get steps from `stepsBySchedule` map
       - For each step: look up template from `templateMap` by `step.email_template_id`
       - If no template found: insert warning to `email_log`, skip that step, continue with remaining steps
       - Use `step.step_number` for the `step_index` field in reminder_queue (was array index before)
       - Use `step.delay_days` for send date calculation (same formula as v1.0)
       - Set `template_id: schedule.id` in the queue entry (points to schedule, not old reminder_templates)
       - Idempotency check remains the same: client_id + filing_type_id + step_index + deadline_date
    8. Similarly rewrite `rebuildQueueForClient()` with the same v1.1 table reads and no override processing.

    **Audit logging helper pattern** (inline, no separate file needed):
    ```typescript
    // Log warnings/errors to email_log for visibility
    async function logQueueWarning(supabase: SupabaseClient, entry: {
      message: string;
      client_id?: string;
      filing_type_id?: string;
    }): Promise<void> {
      await supabase.from('email_log').insert({
        client_id: entry.client_id || null,
        filing_type_id: entry.filing_type_id || null,
        delivery_status: 'failed',
        bounce_description: `[QUEUE] ${entry.message}`,
        subject: 'Queue Builder Warning',
        sent_at: new Date().toISOString(),
      });
    }
    ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes (no type errors)
    - queue-builder.ts contains NO references to `reminder_templates`, `resolveTemplateForClient`, `inheritance`, `ClientTemplateOverride`
    - queue-builder.ts queries `schedules`, `schedule_steps`, and `email_templates` tables
    - Migration file exists and contains ALTER TABLE statement
  </verify>
  <done>
    buildReminderQueue() and rebuildQueueForClient() read exclusively from v1.1 normalized tables (schedules, schedule_steps, email_templates). Missing templates/schedules are logged to email_log and skipped gracefully. html_body column added to reminder_queue schema.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite scheduler and send-emails cron for v1.1 rendering</name>
  <files>
    lib/reminders/scheduler.ts
    app/api/cron/send-emails/route.ts
  </files>
  <action>
    **Scheduler (lib/reminders/scheduler.ts):**
    Rewrite the template variable resolution section (Step 6) of `processReminders()` to use v1.1 rendering:

    1. Remove import of `substituteVariables` from `lib/templates/variables` (renderTipTapEmail handles substitution internally)
    2. Add import of `renderTipTapEmail` from `@/lib/email/render-tiptap`
    3. In Step 6 (resolving template variables for each pending reminder):
       - Instead of fetching from `reminder_templates`, fetch the schedule for this filing type:
         ```typescript
         const { data: schedule } = await supabase
           .from('schedules')
           .select('*')
           .eq('filing_type_id', reminder.filing_type_id)
           .eq('is_active', true)
           .single();
         ```
       - If no schedule found, log error and continue
       - Fetch schedule_steps for that schedule:
         ```typescript
         const { data: steps } = await supabase
           .from('schedule_steps')
           .select('*')
           .eq('schedule_id', schedule.id)
           .order('step_number', { ascending: true });
         ```
       - Find the step matching `reminder.step_index`
       - Fetch the email template for that step:
         ```typescript
         const { data: template } = await supabase
           .from('email_templates')
           .select('*')
           .eq('id', step.email_template_id)
           .single();
         ```
       - If no template found, log error and continue
       - Call `renderTipTapEmail()` with template content and client context:
         ```typescript
         const rendered = await renderTipTapEmail({
           bodyJson: template.body_json,
           subject: template.subject,
           context: {
             client_name: client.company_name,
             deadline: new UTCDate(reminder.deadline_date),
             filing_type: filingType.name,
             accountant_name: 'Peninsula Accounting',
           },
         });
         ```
       - Update reminder_queue with rendered content:
         ```typescript
         await supabase.from('reminder_queue').update({
           resolved_subject: rendered.subject,
           resolved_body: rendered.text,   // Plain text fallback
           html_body: rendered.html,       // Rich HTML from v1.1 pipeline
         }).eq('id', reminder.id);
         ```
       - Wrap renderTipTapEmail in try/catch. On rendering failure: log error to email_log, skip that reminder, continue with others

    **Send-Emails Cron (app/api/cron/send-emails/route.ts):**
    1. Replace import: `sendReminderEmail` -> `sendRichEmail` from `@/lib/email/sender`
    2. Update the pending reminders query to also check for `html_body`:
       - Add `.not('html_body', 'is', null)` to the query filters
    3. Replace the `sendReminderEmail()` call with `sendRichEmail()`:
       ```typescript
       const result = await sendRichEmail({
         to: client.primary_email,
         subject: reminder.resolved_subject!,
         html: reminder.html_body!,
         text: reminder.resolved_body!,
       });
       ```
    4. On Postmark failure: change from marking as `'failed'` to keeping as `'pending'` for retry on next cron run (per user decision). Also log the failure to email_log (keep existing logging).
       ```typescript
       // Keep as pending for retry (per user decision - no missed emails)
       await adminClient
         .from('reminder_queue')
         .update({ status: 'pending' })
         .eq('id', reminder.id);
       ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - scheduler.ts imports `renderTipTapEmail` (not `substituteVariables`)
    - scheduler.ts queries `schedules`, `schedule_steps`, `email_templates` (not `reminder_templates`)
    - send-emails/route.ts imports `sendRichEmail` (not `sendReminderEmail`)
    - send-emails/route.ts references `html_body` column
    - send-emails/route.ts marks Postmark failures as 'pending' (not 'failed')
  </verify>
  <done>
    processReminders() renders emails using v1.1 TipTap pipeline and stores html_body. send-emails cron sends rich HTML via sendRichEmail() with pending retry for Postmark failures.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` passes with no errors
2. No file in `lib/reminders/` references `reminder_templates` table
3. No file in `lib/reminders/` imports from `lib/templates/inheritance`
4. `lib/reminders/queue-builder.ts` queries `schedules`, `schedule_steps`, `email_templates`
5. `lib/reminders/scheduler.ts` calls `renderTipTapEmail()`
6. `app/api/cron/send-emails/route.ts` calls `sendRichEmail()`
7. Migration file adds `html_body TEXT` column to `reminder_queue`
</verification>

<success_criteria>
The entire automated reminder pipeline (queue building, template resolution, email sending) reads from v1.1 normalized tables and uses the TipTap rendering pipeline. No code path references the old reminder_templates table. Failures are logged to email_log and skipped gracefully.
</success_criteria>

<output>
After completion, create `.planning/phases/09-queue-integration/09-01-SUMMARY.md`
</output>
