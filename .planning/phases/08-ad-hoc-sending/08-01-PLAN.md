---
phase: 08-ad-hoc-sending
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/TIMESTAMP_add_email_log_send_type.sql
  - app/actions/send-adhoc-email.ts
  - app/(dashboard)/delivery-log/components/delivery-log-table.tsx
  - app/actions/audit-log.ts
autonomous: true

must_haves:
  truths:
    - "A single ad-hoc email can be rendered from a template and sent to a client via Postmark"
    - "Ad-hoc email sends are logged to email_log with send_type='ad-hoc' and NULL reminder_queue_id"
    - "The delivery log table displays an 'ad-hoc' badge on ad-hoc sends to distinguish from scheduled reminders"
  artifacts:
    - path: "supabase/migrations/TIMESTAMP_add_email_log_send_type.sql"
      provides: "send_type column on email_log table (default 'scheduled')"
      contains: "send_type"
    - path: "app/actions/send-adhoc-email.ts"
      provides: "Server action to render template, send via Postmark, log to email_log"
      exports: ["sendAdhocEmail"]
    - path: "app/(dashboard)/delivery-log/components/delivery-log-table.tsx"
      provides: "Ad-hoc badge rendering in delivery log"
      contains: "ad-hoc"
  key_links:
    - from: "app/actions/send-adhoc-email.ts"
      to: "lib/email/render-tiptap.ts"
      via: "renderTipTapEmail() call"
      pattern: "renderTipTapEmail"
    - from: "app/actions/send-adhoc-email.ts"
      to: "lib/email/sender.ts"
      via: "sendRichEmail() call"
      pattern: "sendRichEmail"
    - from: "app/actions/send-adhoc-email.ts"
      to: "email_log"
      via: "supabase insert with send_type='ad-hoc'"
      pattern: "send_type.*ad-hoc"
---

<objective>
Create the backend infrastructure for ad-hoc email sending: a server action that renders a template with client data and sends via Postmark, logs the send to email_log with an "ad-hoc" type indicator, and update the delivery log UI to show ad-hoc badges.

Purpose: This is the backbone of the ad-hoc sending feature. The server action will be called per-client from the frontend modal (Plan 02) in a loop for progress tracking. The delivery log update ensures users can distinguish ad-hoc sends from scheduled reminders.

Output: Working server action callable from the frontend, migration for send_type column, delivery log with ad-hoc badge support.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@lib/email/render-tiptap.ts
@lib/email/sender.ts
@lib/templates/variables.ts
@lib/types/database.ts
@app/actions/audit-log.ts
@app/(dashboard)/delivery-log/components/delivery-log-table.tsx
@supabase/migrations/20260207020738_add_email_log_table.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add send_type column to email_log and create sendAdhocEmail server action</name>
  <files>
    supabase/migrations/TIMESTAMP_add_email_log_send_type.sql
    app/actions/send-adhoc-email.ts
  </files>
  <action>
**Migration (use actual timestamp in filename, format YYYYMMDDHHMMSS):**
Add a `send_type` TEXT column to `email_log` with DEFAULT 'scheduled' and CHECK constraint for values ('scheduled', 'ad-hoc'). All existing rows get 'scheduled'. This is a non-breaking additive change.

```sql
ALTER TABLE email_log ADD COLUMN IF NOT EXISTS send_type TEXT NOT NULL DEFAULT 'scheduled'
  CHECK (send_type IN ('scheduled', 'ad-hoc'));
```

**Server Action (`app/actions/send-adhoc-email.ts`):**

Create a `'use server'` action `sendAdhocEmail` with this signature:

```typescript
interface SendAdhocEmailParams {
  clientId: string;
  clientName: string;
  clientEmail: string;
  templateId: string;
}

interface SendAdhocEmailResult {
  success: boolean;
  messageId?: string;
  error?: string;
}
```

Implementation steps:
1. Fetch the email template by ID from `email_templates` table (need `subject`, `body_json`)
2. Call `renderTipTapEmail()` with:
   - `bodyJson`: template's `body_json`
   - `subject`: template's `subject`
   - `context`: `{ client_name: clientName, filing_type: 'Ad-hoc', deadline: new Date(), accountant_name: 'Peninsula Accounting' }`
   - Note: Ad-hoc sends don't have a filing type or deadline, so use sensible defaults. The filing_type placeholder will show 'Ad-hoc' and deadline will show today's date. These are acceptable because templates used for ad-hoc sends typically won't use deadline/filing_type placeholders.
3. Call `sendRichEmail()` with the rendered html, text, and resolved subject
4. On success, insert into `email_log`:
   - `client_id`: params.clientId
   - `recipient_email`: params.clientEmail
   - `subject`: resolved subject
   - `delivery_status`: 'sent'
   - `send_type`: 'ad-hoc'
   - `reminder_queue_id`: null (distinguishes from scheduled sends)
   - `filing_type_id`: null (ad-hoc sends have no filing type)
   - `postmark_message_id`: result.messageId
5. Return `{ success: true, messageId }` on success
6. On any error (template fetch, render, send), catch and return `{ success: false, error: errorMessage }` -- do NOT throw, since the caller needs to continue sending to other clients

Use Zod validation on the input params (clientId, clientEmail as email, templateId as uuid, clientName as non-empty string).

Import from existing modules:
- `renderTipTapEmail` from `@/lib/email/render-tiptap`
- `sendRichEmail` from `@/lib/email/sender`
- `createClient` from `@/lib/supabase/server`
  </action>
  <verify>
    - `npx supabase migration list` shows the new migration (or check file exists)
    - TypeScript compiles: `npx tsc --noEmit --pretty` passes (or at least no errors in the new files)
    - The server action exports `sendAdhocEmail` function
  </verify>
  <done>
    - send_type column exists on email_log with CHECK constraint
    - sendAdhocEmail server action fetches template, renders via renderTipTapEmail, sends via sendRichEmail, logs to email_log with send_type='ad-hoc', and returns success/failure without throwing
  </done>
</task>

<task type="auto">
  <name>Task 2: Update delivery log to show ad-hoc badge</name>
  <files>
    app/(dashboard)/delivery-log/components/delivery-log-table.tsx
    app/actions/audit-log.ts
  </files>
  <action>
**Update `app/actions/audit-log.ts`:**
1. Add `send_type` to the `AuditEntry` interface: `send_type: 'scheduled' | 'ad-hoc';`
2. Add `send_type` to the Supabase select query for `email_log`
3. Map `send_type` in the transform: `send_type: row.send_type || 'scheduled'` (fallback for old rows)

**Update `app/(dashboard)/delivery-log/components/delivery-log-table.tsx`:**
1. Add a "Type" column to the table between "Date Sent" and "Client Name"
2. Render a Badge component:
   - For `send_type === 'ad-hoc'`: `<Badge variant="outline" className="border-accent text-accent">ad-hoc</Badge>`
   - For `send_type === 'scheduled'` (or missing): no badge needed, just show "scheduled" as plain text in muted-foreground
3. This keeps it visually distinct â€” ad-hoc sends get a highlighted badge, scheduled sends blend in as default

The badge styling should use the existing `accent` color which is already used for "Overrides" badges on the clients page, keeping visual language consistent.
  </action>
  <verify>
    - TypeScript compiles without errors
    - Delivery log table renders with a "Type" column
    - Ad-hoc entries show an "ad-hoc" badge, scheduled entries show "scheduled" text
  </verify>
  <done>
    - AuditEntry interface includes send_type field
    - Delivery log table has a Type column showing ad-hoc badge for ad-hoc sends
    - Scheduled sends show as plain text "scheduled" (no visual noise)
  </done>
</task>

</tasks>

<verification>
1. New migration file exists in supabase/migrations/ with send_type column addition
2. sendAdhocEmail server action is exported and compiles
3. Delivery log table has Type column with ad-hoc badge rendering
4. TypeScript compilation passes: `npx tsc --noEmit`
</verification>

<success_criteria>
- send_type column on email_log distinguishes ad-hoc from scheduled sends
- sendAdhocEmail action renders template, sends via Postmark, logs with send_type='ad-hoc'
- Delivery log visually distinguishes ad-hoc sends with badge
- All existing functionality (scheduled sends, delivery log filtering) unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/08-ad-hoc-sending/08-01-SUMMARY.md`
</output>
