---
phase: 08-ad-hoc-sending
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - components/ui/progress.tsx
  - app/(dashboard)/clients/components/send-email-modal.tsx
  - app/(dashboard)/clients/components/bulk-actions-toolbar.tsx
  - app/(dashboard)/clients/components/client-table.tsx
autonomous: false

must_haves:
  truths:
    - "User can click 'Send Email' in bulk actions toolbar when clients are selected"
    - "User can select a template from a dropdown listing all templates by name"
    - "User can see a preview of the rendered email with the first selected client's data"
    - "User sees 'Send to X clients?' confirmation with send button before emails go out"
    - "User sees a progress bar showing X/Y sent as emails are sent"
    - "User sees results summary with sent count, failed count, and failed client details"
    - "After successful send, modal closes and success toast appears"
    - "Clients without email addresses are silently skipped with count shown in results"
  artifacts:
    - path: "components/ui/progress.tsx"
      provides: "shadcn Progress bar component"
      contains: "Progress"
    - path: "app/(dashboard)/clients/components/send-email-modal.tsx"
      provides: "Multi-step modal: template select, preview, confirm, sending, results"
      min_lines: 150
    - path: "app/(dashboard)/clients/components/bulk-actions-toolbar.tsx"
      provides: "Updated toolbar with Send Email button"
      contains: "Send Email"
    - path: "app/(dashboard)/clients/components/client-table.tsx"
      provides: "Modal wiring with open state and selected clients"
      contains: "SendEmailModal"
  key_links:
    - from: "app/(dashboard)/clients/components/send-email-modal.tsx"
      to: "app/actions/send-adhoc-email.ts"
      via: "sendAdhocEmail() call in send loop"
      pattern: "sendAdhocEmail"
    - from: "app/(dashboard)/clients/components/send-email-modal.tsx"
      to: "/api/email-templates"
      via: "fetch to load template list and template data"
      pattern: "email-templates"
    - from: "app/(dashboard)/clients/components/send-email-modal.tsx"
      to: "lib/email/render-tiptap.ts"
      via: "Server-side preview rendering (via API or action)"
      pattern: "preview"
    - from: "app/(dashboard)/clients/components/client-table.tsx"
      to: "app/(dashboard)/clients/components/send-email-modal.tsx"
      via: "open state prop and selectedClients prop"
      pattern: "SendEmailModal"
    - from: "app/(dashboard)/clients/components/bulk-actions-toolbar.tsx"
      to: "client-table.tsx"
      via: "onSendEmail callback prop"
      pattern: "onSendEmail"
---

<objective>
Build the Send Email modal UI with multi-step flow (template selection, preview, confirmation, sending with progress, results), wire it into the clients page via the bulk actions toolbar, and install the shadcn Progress component.

Purpose: This is the user-facing feature that enables ad-hoc email sending. The entire flow happens in a modal triggered from the existing clients page -- no new navigation pages. The modal calls the sendAdhocEmail server action (from Plan 01) in a client-side loop to provide real-time progress feedback.

Output: Complete ad-hoc sending flow from client selection through to results summary.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ad-hoc-sending/08-01-SUMMARY.md

@app/(dashboard)/clients/components/client-table.tsx
@app/(dashboard)/clients/components/bulk-actions-toolbar.tsx
@app/(dashboard)/clients/components/bulk-edit-modal.tsx
@app/actions/send-adhoc-email.ts
@app/api/email-templates/route.ts
@lib/email/render-tiptap.ts
@lib/types/database.ts
@app/actions/clients.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Progress component, create Send Email modal, wire into clients page</name>
  <files>
    components/ui/progress.tsx
    app/(dashboard)/clients/components/send-email-modal.tsx
    app/(dashboard)/clients/components/bulk-actions-toolbar.tsx
    app/(dashboard)/clients/components/client-table.tsx
  </files>
  <action>
**Step 1: Install shadcn Progress component**
```bash
npx shadcn@latest add progress
```

**Step 2: Create `app/(dashboard)/clients/components/send-email-modal.tsx`**

A "use client" component with a multi-step modal flow. Use state-driven view switching:

```typescript
type SendStep = 'select-template' | 'preview' | 'confirm' | 'sending' | 'results';
```

Props:
```typescript
interface SendEmailModalProps {
  open: boolean;
  onClose: () => void;
  selectedClients: Client[];  // From client-table selection
}
```

**Step: select-template**
- Fetch templates on mount via `fetch('/api/email-templates')` and store in state
- Show a Select dropdown listing all templates by name (use shadcn Select component, already in project)
- "Next" button enabled only when a template is selected
- Show count: "Sending to X clients (Y without email will be skipped)" where Y is the count of selectedClients with null/empty primary_email
- If ALL selected clients lack email addresses, show a warning message and disable Next button. Message: "None of the selected clients have email addresses."

**Step: preview**
- After template is selected, render a preview using a new server action `previewAdhocEmail` (add to `app/actions/send-adhoc-email.ts`):
  ```typescript
  export async function previewAdhocEmail(params: {
    templateId: string;
    clientName: string;
  }): Promise<{ html: string; subject: string } | { error: string }>
  ```
  This action fetches the template, calls renderTipTapEmail with the first client's data, and returns the HTML + subject. (Use a server action rather than client-side fetch to keep rendering server-side.)
- Display the resolved subject at the top
- Display the rendered HTML in an iframe with `srcDoc` for isolated rendering (prevents modal styles from affecting email preview)
- Show a note below: "Preview shown for [first client name]. Placeholders like client_name will be personalized for each recipient."
- "Back" button to return to template selection, "Next" to proceed to confirm

**Step: confirm**
- Show: "Send to X clients?" (only clients WITH email addresses)
- List the template name being used
- "Back" button and "Send" button (primary, prominent)
- Disable the close button / escape key during this step onwards to prevent accidental abort

**Step: sending**
- Disable modal close entirely (no X button, no escape, no backdrop click)
- Filter selectedClients to only those with primary_email (skip clients without email)
- Loop through eligible clients, calling `sendAdhocEmail` server action for each:
  ```typescript
  for (const client of eligibleClients) {
    const result = await sendAdhocEmail({
      clientId: client.id,
      clientName: client.display_name || client.company_name,
      clientEmail: client.primary_email!,
      templateId: selectedTemplateId,
    });
    if (result.success) {
      setSentCount(prev => prev + 1);
    } else {
      setFailures(prev => [...prev, { clientName: client.display_name || client.company_name, error: result.error || 'Unknown error' }]);
    }
    setProgress(prev => prev + 1); // total processed count
  }
  ```
- Show Progress bar: `value={(progress / eligibleClients.length) * 100}`
- Show text: "Sending... X/Y" where X is progress and Y is total eligible
- No cancel button during send (per research: avoid partial send state complexity)

**Step: results**
- Re-enable modal close
- Show sent count and failed count as prominent numbers
- If failures exist, show a scrollable list of failed clients with their error reasons
- "Close" button that:
  1. Calls onClose()
  2. Shows a sonner toast: `toast.success('Sent X emails successfully')` (or `toast.warning` if there were failures: 'Sent X of Y emails. Z failed.')
- Reset all modal state on close (step, template, progress, results)

**Modal container:** Use shadcn Dialog component. Set `onInteractOutside` and `onEscapeKeyDown` to `e.preventDefault()` during 'sending' step. Standard close behavior for other steps.

**Step 3: Update `bulk-actions-toolbar.tsx`**

Add an `onSendEmail` prop to `BulkActionsToolbarProps`:
```typescript
interface BulkActionsToolbarProps {
  selectedCount: number;
  onBulkEdit: () => void;
  onSendEmail: () => void;  // NEW
  onClearSelection: () => void;
}
```

Add a new Button between "Bulk Edit" and "Clear":
```tsx
<Button
  variant="outline"
  size="sm"
  onClick={onSendEmail}
  className="gap-2 active:scale-[0.97]"
>
  <Mail className="size-4" />
  Send Email
</Button>
```

Import `Mail` from `lucide-react`.

**Step 4: Update `client-table.tsx`**

1. Add state: `const [isSendEmailModalOpen, setIsSendEmailModalOpen] = useState(false);`
2. Import `SendEmailModal` from `./send-email-modal`
3. Pass `onSendEmail={() => setIsSendEmailModalOpen(true)}` to `BulkActionsToolbar`
4. Render `SendEmailModal` alongside `BulkEditModal`:
   ```tsx
   <SendEmailModal
     open={isSendEmailModalOpen}
     onClose={() => setIsSendEmailModalOpen(false)}
     selectedClients={selectedClients}
   />
   ```

**Design decisions (Claude's discretion per CONTEXT.md):**
- Modal uses a single panel with step indicator at top (not a wizard with multiple panels) -- simpler, less visual weight
- Progress bar uses default shadcn styling (no custom animation)
- Toast duration: 5 seconds for success, 8 seconds for warnings (failures need more reading time)
- When all selected clients lack email: show warning text in the select-template step, disable Next
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Progress component exists at components/ui/progress.tsx
    - Send Email modal component exists with all 5 steps
    - Bulk actions toolbar shows Send Email button
    - Client table wires modal open/close and passes selectedClients
  </verify>
  <done>
    - Send Email button visible in bulk actions toolbar when clients selected
    - Modal opens with template selection dropdown
    - Preview step renders email HTML with first client data
    - Confirm step shows client count
    - Sending step shows progress bar with X/Y counter
    - Results step shows sent/failed counts with failure details
    - Modal closes with toast notification
    - Clients without email are silently skipped with count shown
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete ad-hoc email sending flow: select clients on clients page, click Send Email in toolbar, pick template, preview rendered email, confirm, send with progress, see results. Ad-hoc sends appear in delivery log with badge.</what-built>
  <how-to-verify>
    1. Go to /clients page
    2. Select 2-3 clients using checkboxes (ensure at least one has an email address)
    3. Verify "Send Email" button appears in the floating bulk actions toolbar
    4. Click "Send Email" -- modal should open with template dropdown
    5. Select a template from the dropdown
    6. Click Next -- preview should show rendered email for first selected client
    7. Click Next -- confirmation should show "Send to X clients?"
    8. Click Send -- progress bar should animate as emails send
    9. Results screen should show sent/failed counts
    10. Close modal -- success toast should appear
    11. Go to /delivery-log -- new sends should appear with "ad-hoc" badge in Type column
    12. (Optional) Test with a client that has no email -- should be skipped in count

    NOTE: If Postmark is not configured or rate-limited, sends will fail -- that's OK for verification. The progress bar and results screen (with failure reasons) should still display correctly.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Full flow works: select clients -> Send Email -> pick template -> preview -> confirm -> send -> results -> toast
2. Progress bar shows real-time X/Y progress
3. Clients without email are skipped (not counted in send count, reflected in UI)
4. Modal cannot be closed during sending step
5. Delivery log shows "ad-hoc" badge for ad-hoc sends, "scheduled" text for old sends
6. TypeScript compiles without errors
</verification>

<success_criteria>
- Complete ad-hoc sending flow works end-to-end from clients page
- Template selection, preview, confirmation, progress, and results all functional
- Delivery log distinguishes ad-hoc from scheduled sends
- No regressions to existing bulk edit, client table, or delivery log functionality
- All ADHC-01 through ADHC-09 requirements satisfied (per CONTEXT.md overrides)
</success_criteria>

<output>
After completion, create `.planning/phases/08-ad-hoc-sending/08-02-SUMMARY.md`
</output>
