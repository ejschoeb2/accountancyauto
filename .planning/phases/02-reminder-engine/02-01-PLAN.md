---
phase: 02-reminder-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/create_phase2_schema.sql
  - package.json
  - lib/types/database.ts
autonomous: true

must_haves:
  truths:
    - "Phase 2 database tables exist and can be queried"
    - "New dependencies (react-hook-form, react-big-calendar) are installed"
    - "TypeScript types for all Phase 2 tables are available for import"
  artifacts:
    - path: "supabase/migrations/create_phase2_schema.sql"
      provides: "Phase 2 database schema"
      contains: "CREATE TABLE reminder_templates"
    - path: "lib/types/database.ts"
      provides: "TypeScript types for Phase 2 tables"
      contains: "ReminderTemplate"
  key_links:
    - from: "lib/types/database.ts"
      to: "supabase/migrations/create_phase2_schema.sql"
      via: "Types mirror database schema"
      pattern: "ReminderTemplate|ClientFilingAssignment|ClientDeadlineOverride|ClientTemplateOverride|ReminderQueue"
---

<objective>
Create the Phase 2 database schema (templates, filing assignments, deadline overrides, client template overrides, reminder queue, bank holiday cache) and install new dependencies (react-hook-form, react-big-calendar). Export TypeScript types matching the schema.

Purpose: Every other Phase 2 plan depends on these tables and types existing. This is the foundation layer.
Output: SQL migration file, installed npm packages, TypeScript type definitions.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-reminder-engine/02-RESEARCH.md
@supabase/migrations/create_phase1_schema.sql
@lib/validations/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 2 database migration and install dependencies</name>
  <files>supabase/migrations/create_phase2_schema.sql, package.json</files>
  <action>
1. Install new dependencies:
   ```
   npm install react-hook-form@7 react-big-calendar@1
   npm install @types/react-big-calendar -D
   ```

2. Create `supabase/migrations/create_phase2_schema.sql` with these tables:

**filing_types** (reference table for filing types):
- `id` TEXT PRIMARY KEY (e.g., 'corporation_tax', 'companies_house', 'vat_return', 'self_assessment', 'ct600_filing')
- `name` TEXT NOT NULL (display name: 'Corporation Tax Payment', 'Companies House Accounts', etc.)
- `description` TEXT
- `applicable_client_types` client_type_enum[] NOT NULL (which client types this applies to by default)
- `created_at` TIMESTAMPTZ DEFAULT now()

Seed with these rows:
- corporation_tax_payment: 'Corporation Tax Payment', applicable to ['Limited Company', 'LLP']
- ct600_filing: 'CT600 Filing', applicable to ['Limited Company', 'LLP']
- companies_house: 'Companies House Accounts', applicable to ['Limited Company', 'LLP']
- vat_return: 'VAT Return', applicable to ['Limited Company', 'Sole Trader', 'Partnership', 'LLP'] (only if VAT registered, handled in app logic)
- self_assessment: 'Self Assessment', applicable to ['Sole Trader', 'Partnership']

**reminder_templates** (one per filing type, contains steps as JSONB array):
- `id` UUID PRIMARY KEY DEFAULT uuid_generate_v4()
- `filing_type_id` TEXT REFERENCES filing_types(id) ON DELETE CASCADE, UNIQUE
- `name` TEXT NOT NULL
- `description` TEXT
- `steps` JSONB NOT NULL DEFAULT '[]' -- Array of {step_number, delay_days, subject, body}
  - Each step: step_number (int), delay_days (int, days before deadline), subject (text), body (text)
  - Enforce 1-5 steps via app-level Zod validation (not DB constraint, per research recommendation)
- `is_active` BOOLEAN NOT NULL DEFAULT true
- `created_at` TIMESTAMPTZ DEFAULT now()
- `updated_at` TIMESTAMPTZ DEFAULT now()

**client_filing_assignments** (which filing types each client has):
- `id` UUID PRIMARY KEY DEFAULT uuid_generate_v4()
- `client_id` UUID REFERENCES clients(id) ON DELETE CASCADE
- `filing_type_id` TEXT REFERENCES filing_types(id) ON DELETE CASCADE
- `is_active` BOOLEAN NOT NULL DEFAULT true (manual toggle)
- `created_at` TIMESTAMPTZ DEFAULT now()
- UNIQUE(client_id, filing_type_id)

**client_deadline_overrides** (per-client deadline date overrides):
- `id` UUID PRIMARY KEY DEFAULT uuid_generate_v4()
- `client_id` UUID REFERENCES clients(id) ON DELETE CASCADE
- `filing_type_id` TEXT REFERENCES filing_types(id) ON DELETE CASCADE
- `override_date` DATE NOT NULL
- `reason` TEXT (e.g., 'HMRC extension granted')
- `created_at` TIMESTAMPTZ DEFAULT now()
- `updated_at` TIMESTAMPTZ DEFAULT now()
- UNIQUE(client_id, filing_type_id)

**client_template_overrides** (field-level overrides per client per template step):
- `id` UUID PRIMARY KEY DEFAULT uuid_generate_v4()
- `client_id` UUID REFERENCES clients(id) ON DELETE CASCADE
- `template_id` UUID REFERENCES reminder_templates(id) ON DELETE CASCADE
- `step_index` INT NOT NULL (which step in the template array, 0-based)
- `overridden_fields` JSONB NOT NULL (only fields that differ: {subject?, body?, delay_days?})
- `created_at` TIMESTAMPTZ DEFAULT now()
- `updated_at` TIMESTAMPTZ DEFAULT now()
- UNIQUE(client_id, template_id, step_index)

**bank_holidays_cache** (cached gov.uk bank holidays):
- `id` SERIAL PRIMARY KEY
- `holiday_date` DATE NOT NULL UNIQUE
- `title` TEXT NOT NULL
- `region` TEXT NOT NULL DEFAULT 'england-and-wales'
- `fetched_at` TIMESTAMPTZ NOT NULL DEFAULT now()

**reminder_queue** (scheduled/pending reminders for the cron job):
- `id` UUID PRIMARY KEY DEFAULT uuid_generate_v4()
- `client_id` UUID REFERENCES clients(id) ON DELETE CASCADE
- `filing_type_id` TEXT REFERENCES filing_types(id) ON DELETE CASCADE
- `template_id` UUID REFERENCES reminder_templates(id) ON DELETE SET NULL
- `step_index` INT NOT NULL
- `deadline_date` DATE NOT NULL
- `send_date` DATE NOT NULL (calculated: deadline_date - delay_days, adjusted for working days)
- `status` TEXT NOT NULL DEFAULT 'scheduled' CHECK (status IN ('scheduled', 'pending', 'sent', 'cancelled', 'failed'))
- `resolved_subject` TEXT (populated when status becomes 'pending', with variables substituted)
- `resolved_body` TEXT
- `queued_at` TIMESTAMPTZ
- `sent_at` TIMESTAMPTZ
- `created_at` TIMESTAMPTZ DEFAULT now()
- `updated_at` TIMESTAMPTZ DEFAULT now()

Add indexes:
- `idx_reminder_queue_send_date_status` ON reminder_queue(send_date, status)
- `idx_reminder_queue_client_filing` ON reminder_queue(client_id, filing_type_id)
- `idx_client_filing_assignments_client` ON client_filing_assignments(client_id)
- `idx_client_template_overrides_client` ON client_template_overrides(client_id)
- `idx_client_deadline_overrides_client` ON client_deadline_overrides(client_id)

Add update triggers for reminder_templates, client_deadline_overrides, client_template_overrides, reminder_queue.

Add RLS policies matching Phase 1 pattern:
- Authenticated users: full CRUD on all new tables
- Service role: full access on all new tables

Also add `has_overrides` BOOLEAN DEFAULT false column to the existing `clients` table (for badge display in client list per research recommendation #4). Add a trigger function that sets has_overrides = true when rows are inserted into client_template_overrides for that client, and false when all overrides for that client are deleted.

Also add `reminders_paused` BOOLEAN DEFAULT false column to the existing `clients` table (needed for pause/unpause logic).

Also add `records_received_for` JSONB DEFAULT '[]' column to the existing `clients` table (array of filing_type_ids where records have been received, used to auto-cancel reminders).
  </action>
  <verify>
Read the SQL file and confirm:
- All 7 tables defined (filing_types, reminder_templates, client_filing_assignments, client_deadline_overrides, client_template_overrides, bank_holidays_cache, reminder_queue)
- Seed data for filing_types present
- All foreign keys reference existing Phase 1 tables correctly
- RLS policies present for all tables
- Indexes created
- has_overrides, reminders_paused, records_received_for columns added to clients
- `npm ls react-hook-form react-big-calendar` shows both installed
  </verify>
  <done>SQL migration file is complete and syntactically valid. react-hook-form and react-big-calendar installed in package.json.</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types for Phase 2 database tables</name>
  <files>lib/types/database.ts</files>
  <action>
Create `lib/types/database.ts` exporting TypeScript interfaces that mirror the Phase 2 database schema:

```typescript
// Filing type identifiers
export type FilingTypeId =
  | 'corporation_tax_payment'
  | 'ct600_filing'
  | 'companies_house'
  | 'vat_return'
  | 'self_assessment';

export interface FilingType {
  id: FilingTypeId;
  name: string;
  description: string | null;
  applicable_client_types: Array<'Limited Company' | 'Sole Trader' | 'Partnership' | 'LLP'>;
  created_at: string;
}

export interface TemplateStep {
  step_number: number;
  delay_days: number; // days before deadline
  subject: string;
  body: string;
}

export interface ReminderTemplate {
  id: string;
  filing_type_id: FilingTypeId;
  name: string;
  description: string | null;
  steps: TemplateStep[];
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

export interface ClientFilingAssignment {
  id: string;
  client_id: string;
  filing_type_id: FilingTypeId;
  is_active: boolean;
  created_at: string;
}

export interface ClientDeadlineOverride {
  id: string;
  client_id: string;
  filing_type_id: FilingTypeId;
  override_date: string; // YYYY-MM-DD
  reason: string | null;
  created_at: string;
  updated_at: string;
}

export interface ClientTemplateOverride {
  id: string;
  client_id: string;
  template_id: string;
  step_index: number;
  overridden_fields: Partial<Pick<TemplateStep, 'subject' | 'body' | 'delay_days'>>;
  created_at: string;
  updated_at: string;
}

export interface BankHoliday {
  id: number;
  holiday_date: string; // YYYY-MM-DD
  title: string;
  region: string;
  fetched_at: string;
}

export type ReminderStatus = 'scheduled' | 'pending' | 'sent' | 'cancelled' | 'failed';

export interface ReminderQueueItem {
  id: string;
  client_id: string;
  filing_type_id: FilingTypeId;
  template_id: string | null;
  step_index: number;
  deadline_date: string; // YYYY-MM-DD
  send_date: string; // YYYY-MM-DD
  status: ReminderStatus;
  resolved_subject: string | null;
  resolved_body: string | null;
  queued_at: string | null;
  sent_at: string | null;
  created_at: string;
  updated_at: string;
}

// Available placeholder variables for template editor reference
export const PLACEHOLDER_VARIABLES = [
  { name: 'client_name', description: "Client's company or trading name" },
  { name: 'deadline', description: 'Deadline date in long format (e.g., 31 January 2026)' },
  { name: 'deadline_short', description: 'Deadline date in short format (e.g., 31/01/2026)' },
  { name: 'filing_type', description: 'Type of filing (e.g., Corporation Tax Payment)' },
  { name: 'days_until_deadline', description: 'Number of days remaining until deadline' },
  { name: 'accountant_name', description: 'Practice name (Peninsula Accounting)' },
] as const;
```

Ensure all types are exported and can be imported from `@/lib/types/database`.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm TypeScript compiles without errors. Check that `lib/types/database.ts` exports all 8+ interfaces/types.</verify>
  <done>All Phase 2 TypeScript types are defined, exported, and compile without errors.</done>
</task>

</tasks>

<verification>
- SQL migration file exists at `supabase/migrations/create_phase2_schema.sql`
- `npm ls react-hook-form react-big-calendar` confirms both installed
- `npx tsc --noEmit` passes
- Types in `lib/types/database.ts` match schema tables 1:1
</verification>

<success_criteria>
- Phase 2 migration SQL is complete with all 7 new tables + 3 new client columns
- react-hook-form and react-big-calendar installed
- TypeScript types defined for all new tables
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-reminder-engine/02-01-SUMMARY.md`
</output>
