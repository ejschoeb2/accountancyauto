---
phase: 02-reminder-engine
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/deadlines/calculators.ts
  - lib/deadlines/calculators.test.ts
  - lib/deadlines/working-days.ts
  - lib/deadlines/working-days.test.ts
  - lib/deadlines/rollover.ts
  - lib/deadlines/rollover.test.ts
  - lib/bank-holidays/cache.ts
autonomous: true

must_haves:
  truths:
    - "Deadline calculators return correct dates for all UK filing types"
    - "Working day calculation skips weekends and UK bank holidays"
    - "Rollover logic produces next cycle deadline from current deadline"
  artifacts:
    - path: "lib/deadlines/calculators.ts"
      provides: "UK filing deadline formulas"
      exports: ["calculateCorporationTaxPayment", "calculateCT600Filing", "calculateCompaniesHouseAccounts", "calculateVATDeadline", "calculateSelfAssessmentDeadline", "getVATQuarterEnds"]
    - path: "lib/deadlines/working-days.ts"
      provides: "Working day calculation with bank holiday support"
      exports: ["getNextWorkingDay", "isWorkingDay"]
    - path: "lib/deadlines/rollover.ts"
      provides: "Year-on-year deadline rollover"
      exports: ["rolloverDeadline"]
    - path: "lib/bank-holidays/cache.ts"
      provides: "gov.uk bank holiday fetching and caching"
      exports: ["fetchUKBankHolidays", "getUKBankHolidaySet"]
  key_links:
    - from: "lib/deadlines/working-days.ts"
      to: "lib/bank-holidays/cache.ts"
      via: "import getUKBankHolidaySet"
      pattern: "import.*bank-holidays"
    - from: "lib/deadlines/rollover.ts"
      to: "lib/deadlines/calculators.ts"
      via: "import calculator functions"
      pattern: "import.*calculators"
---

<objective>
TDD the core deadline calculation engine: UK filing deadline formulas, working day calculation (skip weekends + bank holidays), and year-on-year rollover logic. Also implement the gov.uk bank holiday cache.

Purpose: These are pure functions with well-defined inputs and outputs -- perfect TDD candidates. Getting deadline math right is critical to the entire reminder system.
Output: Tested, working deadline calculation library.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-reminder-engine/02-RESEARCH.md
</context>

<feature>
  <name>UK Filing Deadline Calculators</name>
  <files>lib/deadlines/calculators.ts, lib/deadlines/calculators.test.ts</files>
  <behavior>
  All functions take a Date and return a Date.

  Test cases (use exact dates to verify):

  **Corporation Tax Payment** (year-end + 9 months + 1 day):
  - Input: 2025-03-31 (year-end) -> Output: 2026-01-01
  - Input: 2025-12-31 -> Output: 2026-10-01
  - Input: 2024-02-29 (leap year) -> Output: 2024-12-01 (Nov 29 + 1 day = Nov 30... wait: Feb 29 + 9 months = Nov 29 + 1 day = Nov 30. Actually: addMonths(Feb 29, 9) = Nov 29, addDays(Nov 29, 1) = Nov 30. So output: 2024-11-30)

  **CT600 Filing** (year-end + 12 months):
  - Input: 2025-03-31 -> Output: 2026-03-31
  - Input: 2025-06-30 -> Output: 2026-06-30

  **Companies House Accounts** (year-end + 9 months for private companies):
  - Input: 2025-03-31 -> Output: 2025-12-31
  - Input: 2025-06-30 -> Output: 2026-03-30

  **VAT Return** (quarter-end + 1 month + 7 days):
  - Input: 2025-03-31 (Q1 end) -> Output: 2025-05-07
  - Input: 2025-06-30 (Q2 end) -> Output: 2025-08-07
  - Input: 2025-12-31 (Q4 end) -> Output: 2026-02-07

  **Self Assessment** (always 31 January following tax year ending 5 April):
  - Input: tax year ending 2025-04-05 -> Output: 2026-01-31
  - Input: tax year ending 2026-04-05 -> Output: 2027-01-31

  **VAT Quarter End Dates** (given quarter enum and year):
  - 'Jan-Mar', 2025 -> [2025-03-31]
  - 'Apr-Jun', 2025 -> [2025-06-30]
  - 'Jul-Sep', 2025 -> [2025-09-30]
  - 'Oct-Dec', 2025 -> [2025-12-31]
  - Should return all 4 quarter-end dates for a year when given a quarter type

  Use date-fns functions: addMonths, addDays, addYears, getYear, isLeapYear.
  </behavior>
  <implementation>
  Create `lib/deadlines/calculators.ts` with exported functions:
  - `calculateCorporationTaxPayment(yearEndDate: Date): Date`
  - `calculateCT600Filing(yearEndDate: Date): Date`
  - `calculateCompaniesHouseAccounts(yearEndDate: Date): Date`
  - `calculateVATDeadline(quarterEndDate: Date): Date`
  - `calculateSelfAssessmentDeadline(taxYearEndYear: number): Date` (takes year, e.g. 2025 meaning tax year ending April 2025)
  - `getVATQuarterEnds(quarter: VatQuarterEnum, year: number): Date[]` (returns all 4 quarter-end dates for that year with that quarter pattern)
  - `calculateDeadline(filingTypeId: string, clientMetadata: { year_end_date?: string; vat_quarter?: string }): Date | null` (dispatcher function)
  </implementation>
</feature>

<feature>
  <name>Bank Holiday Cache + Working Day Calculation</name>
  <files>lib/bank-holidays/cache.ts, lib/deadlines/working-days.ts, lib/deadlines/working-days.test.ts</files>
  <behavior>
  **Bank Holiday Cache:**
  - Fetches from https://www.gov.uk/bank-holidays.json
  - Extracts england-and-wales events
  - Returns Set of date strings (YYYY-MM-DD format)
  - Caches for 7 days (in-memory or Supabase bank_holidays_cache table)
  - Graceful fallback: if API fails, use cached data from bank_holidays_cache table

  **Working Day Calculation:**
  - getNextWorkingDay(date): if date is weekend or bank holiday, shift forward to next working day
  - isWorkingDay(date): returns false for weekends and bank holidays

  Test cases (mock bank holidays for deterministic tests):
  - Monday 2025-01-06 (regular working day) -> returns same date
  - Saturday 2025-01-04 -> returns Monday 2025-01-06
  - Sunday 2025-01-05 -> returns Monday 2025-01-06
  - Friday 2025-12-26 (Boxing Day, bank holiday) -> skip to Monday 2025-12-29
  - Thursday 2025-12-25 (Christmas Day) + Friday 2025-12-26 (Boxing Day) -> Saturday 2025-12-27 -> Sunday 2025-12-28 -> Monday 2025-12-29
  - If date falls on Wednesday and is a bank holiday, return Thursday (if Thursday is working day)
  </behavior>
  <implementation>
  Create `lib/bank-holidays/cache.ts`:
  - `fetchUKBankHolidays(): Promise<BankHoliday[]>` - fetches from gov.uk API, stores in bank_holidays_cache table
  - `getUKBankHolidaySet(): Promise<Set<string>>` - returns Set of YYYY-MM-DD strings, checks cache first
  - In-memory cache with 7-day TTL, falls back to Supabase table, falls back to empty set with error log

  Create `lib/deadlines/working-days.ts`:
  - `getNextWorkingDay(date: Date, holidays: Set<string>): Date` - takes pre-fetched holiday set (no async in the function itself)
  - `isWorkingDay(date: Date, holidays: Set<string>): boolean`
  - Uses date-fns isWeekend() and format() to check against holiday set

  NOTE: Make working-days functions synchronous by accepting the holiday set as a parameter. The caller fetches holidays once and passes them in. This makes testing trivial (no mocks needed for the core logic).
  </implementation>
</feature>

<feature>
  <name>Year-on-Year Deadline Rollover</name>
  <files>lib/deadlines/rollover.ts, lib/deadlines/rollover.test.ts</files>
  <behavior>
  Given a current deadline and filing type, calculate the next cycle's deadline.

  Test cases:
  - Corporation Tax: year-end 2025-03-31, current deadline 2026-01-01 -> next year-end 2026-03-31 -> next deadline 2027-01-01
  - Companies House: year-end 2025-03-31, current deadline 2025-12-31 -> next: 2026-12-31
  - VAT Return (quarterly): quarter 'Jan-Mar', current deadline 2025-05-07 -> next quarter end 2025-06-30 -> next deadline 2025-08-07
  - VAT Return rollover should produce 4 deadlines per year (quarterly cycle)
  - Self Assessment: current deadline 2026-01-31 -> next: 2027-01-31

  Edge case: Leap year year-end (Feb 29) rolling over to non-leap year should handle gracefully (date-fns addYears handles this).
  </behavior>
  <implementation>
  Create `lib/deadlines/rollover.ts`:
  - `rolloverDeadline(filingTypeId: string, yearEndDate: Date | null, vatQuarter: string | null, currentDeadline: Date): Date`
  - For Corporation Tax / CT600 / Companies House: advance year-end by 1 year, recalculate deadline
  - For VAT: advance to next quarter-end, recalculate deadline
  - For Self Assessment: advance by 1 year (always Jan 31)
  - Import and reuse calculator functions from `./calculators`
  </implementation>
</feature>

<verification>
- All test files pass: `npx vitest run lib/deadlines/ lib/bank-holidays/` (or jest, whichever is configured)
- If no test runner configured, install vitest: `npm install -D vitest` and add test script to package.json
- Each calculator function has at least 2 test cases
- Working day function has weekend, bank holiday, and consecutive holiday tests
- Rollover has test cases for each filing type
</verification>

<success_criteria>
- All deadline calculator functions return correct dates per UK filing rules
- Working day calculation correctly skips weekends and bank holidays
- Rollover produces next cycle deadline for all filing types
- All tests pass
- Bank holiday cache fetches from gov.uk API with fallback
</success_criteria>

<output>
After completion, create `.planning/phases/02-reminder-engine/02-02-SUMMARY.md`
</output>
