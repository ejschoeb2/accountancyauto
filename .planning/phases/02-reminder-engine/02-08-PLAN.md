---
phase: 02-reminder-engine
plan: 08
type: execute
wave: 3
depends_on: ["02-01", "02-02", "02-03"]
files_modified:
  - app/api/cron/reminders/route.ts
  - lib/reminders/scheduler.ts
  - lib/reminders/queue-builder.ts
  - vercel.json
  - app/api/reminders/rebuild-queue/route.ts
autonomous: true

must_haves:
  truths:
    - "Daily cron job identifies which reminders are due based on send dates and client status"
    - "Cron job runs at 9am UK time (accounting for BST/GMT)"
    - "Reminders on weekends/bank holidays are shifted to next working day"
    - "Paused clients and received-records clients have reminders skipped/cancelled"
    - "Cron job uses queue pattern to avoid Vercel 5-minute timeout"
    - "Reminder queue is populated from templates, filing assignments, and deadlines"
  artifacts:
    - path: "app/api/cron/reminders/route.ts"
      provides: "Vercel Cron endpoint for daily reminder processing"
      exports: ["GET"]
    - path: "lib/reminders/scheduler.ts"
      provides: "Core scheduling logic"
      exports: ["processReminders"]
    - path: "lib/reminders/queue-builder.ts"
      provides: "Builds reminder queue entries from templates and deadlines"
      exports: ["buildReminderQueue", "rebuildQueueForClient"]
    - path: "vercel.json"
      provides: "Cron job configuration"
      contains: "crons"
  key_links:
    - from: "app/api/cron/reminders/route.ts"
      to: "lib/reminders/scheduler.ts"
      via: "calls processReminders()"
      pattern: "import.*scheduler"
    - from: "lib/reminders/scheduler.ts"
      to: "lib/deadlines/working-days.ts"
      via: "adjusts send dates for working days"
      pattern: "import.*working-days"
    - from: "lib/reminders/queue-builder.ts"
      to: "lib/deadlines/calculators.ts"
      via: "calculates deadlines to determine send dates"
      pattern: "import.*calculators"
    - from: "lib/reminders/queue-builder.ts"
      to: "lib/templates/inheritance.ts"
      via: "resolves template overrides for each client"
      pattern: "import.*inheritance"
---

<objective>
Build the cron job and reminder queue system. A daily cron job (9am UK time) identifies due reminders by checking the reminder_queue table. The queue is populated from templates, filing assignments, and calculated deadlines. Handles working day adjustment, paused clients, received records auto-cancellation, and unpause skip-ahead logic.

Purpose: This is the engine that drives the entire reminder system. It connects templates, deadlines, and client status into a queue of scheduled reminders that the Phase 3 email delivery system will process.
Output: Working cron endpoint, queue builder, and scheduler logic. The cron job populates and processes the reminder queue.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-reminder-engine/02-RESEARCH.md
@.planning/phases/02-reminder-engine/02-01-SUMMARY.md
@.planning/phases/02-reminder-engine/02-02-SUMMARY.md
@.planning/phases/02-reminder-engine/02-03-SUMMARY.md
@lib/types/database.ts
@lib/deadlines/calculators.ts
@lib/deadlines/working-days.ts
@lib/deadlines/rollover.ts
@lib/bank-holidays/cache.ts
@lib/templates/inheritance.ts
@lib/templates/variables.ts
@lib/supabase/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reminder queue builder</name>
  <files>lib/reminders/queue-builder.ts, app/api/reminders/rebuild-queue/route.ts</files>
  <action>
1. Create `lib/reminders/queue-builder.ts`:

   `buildReminderQueue(supabase: SupabaseClient): Promise<{ created: number; skipped: number }>`:
   - Fetch all clients with active filing assignments (join client_filing_assignments WHERE is_active = true)
   - Fetch all active reminder templates
   - Fetch all client_template_overrides and client_deadline_overrides
   - Fetch bank holidays via getUKBankHolidaySet()
   - For each client + filing type pair:
     a. Skip if client.reminders_paused = true
     b. Skip if filing_type_id is in client.records_received_for array
     c. Calculate deadline (use override if exists, else calculator)
     d. If no deadline calculable (missing year-end date etc.), skip
     e. Find the reminder template for this filing type
     f. If no template exists, skip
     g. Resolve template steps with client overrides (use resolveTemplateForClient)
     h. For each resolved step:
        - Calculate send_date = deadline_date - delay_days
        - Adjust send_date to next working day if it falls on weekend/bank holiday
        - Check if this exact reminder already exists in queue (client_id + filing_type_id + step_index + deadline_date)
        - If exists, skip (idempotent)
        - If not exists, insert into reminder_queue with status 'scheduled'
   - Return count of created and skipped

   `rebuildQueueForClient(supabase: SupabaseClient, clientId: string): Promise<void>`:
   - Delete all 'scheduled' reminders for this client (don't touch 'pending', 'sent', 'cancelled')
   - Rebuild queue entries for this client only (same logic as above but filtered to one client)
   - Use case: when client metadata changes, filing assignments change, or overrides change

   `cancelRemindersForReceivedRecords(supabase: SupabaseClient, clientId: string, filingTypeId: string): Promise<number>`:
   - Update all reminder_queue entries for this client + filing type with status 'scheduled' to 'cancelled'
   - Per user decision: auto-cancel all remaining steps when records received, no confirmation
   - Return count of cancelled reminders

   `handleUnpauseClient(supabase: SupabaseClient, clientId: string): Promise<void>`:
   - Per user decision: skip any missed reminders and resume from next due step
   - Find all 'scheduled' reminders for this client where send_date < today
   - Update those to 'cancelled' (they were missed while paused)
   - The remaining scheduled reminders with future send_date will execute normally

2. Create `app/api/reminders/rebuild-queue/route.ts`:
   - POST handler: triggers full queue rebuild (buildReminderQueue)
   - Useful for initial setup and debugging
   - Requires auth (use createClient from supabase/server)
   - Returns { created, skipped } counts

Queue builder uses `createAdminClient()` from `@/lib/supabase/admin` for service-role access (background job).
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Check that queue-builder imports deadline calculators, working-days, and inheritance correctly. Verify idempotency logic (duplicate check before insert).
  </verify>
  <done>Queue builder creates reminder_queue entries from templates + deadlines + overrides, with working day adjustment, pause/receive handling, and idempotent inserts.</done>
</task>

<task type="auto">
  <name>Task 2: Cron job endpoint and scheduler</name>
  <files>app/api/cron/reminders/route.ts, lib/reminders/scheduler.ts, vercel.json</files>
  <action>
1. Create `vercel.json` at project root:
   ```json
   {
     "crons": [
       {
         "path": "/api/cron/reminders",
         "schedule": "0 9 * * *"
       }
     ]
   }
   ```
   Note: This runs at 9am UTC. Per research recommendation, the cron function will check if it's 9am UK time and handle BST accordingly. Alternative: run at both 8am and 9am UTC and check inside.

2. Create `lib/reminders/scheduler.ts`:

   `processReminders(supabase: SupabaseClient): Promise<ProcessResult>`:
   - Step 1: Acquire distributed lock using existing `locks` table (id: 'cron_reminders', expires_at: now + 5 min). If lock held, return early (prevents concurrent cron runs per Pitfall #6).
   - Step 2: Check current UK time using date-fns-tz:
     ```typescript
     import { toZonedTime } from 'date-fns-tz';
     const ukTime = toZonedTime(new Date(), 'Europe/London');
     const ukHour = ukTime.getHours();
     // If not 9am UK time (8 or 9 depending on BST), exit early
     // OR: just process regardless since cron runs at 9 UTC
     ```
     Per research recommendation: run cron at 9 UTC, check UK time inside. If UK hour is not 9 (because BST shifts it), log and exit. This handles BST transitions cleanly.
     ACTUALLY simpler approach: Run at 9 UTC. During GMT (winter), that's 9am UK. During BST (summer), that's 10am UK. If user wants exactly 9am UK, we need two cron entries (8 UTC and 9 UTC) and check inside. Let's do the two-entry approach:
     - vercel.json: schedule "0 8,9 * * *" (runs at both 8 and 9 UTC)
     - Inside function: check if current UK time hour === 9, if not, exit early
     - This ensures 9am UK in both GMT and BST

   - Step 3: Build/update queue for any new reminders: call `buildReminderQueue()` to ensure queue is current
   - Step 4: Find all reminder_queue entries where send_date = today and status = 'scheduled'
   - Step 5: Update their status to 'pending' and set queued_at = now()
   - Step 6: For reminders that are now 'pending', resolve template variables:
     - Fetch client data for each
     - Use substituteVariables() to populate resolved_subject and resolved_body
     - Update the queue entries with resolved content
   - Step 7: Check for rollover: find deadlines that have passed, trigger rollover via rolloverDeadline() to calculate next cycle
   - Step 8: Release lock
   - Step 9: Return { queued: number, rolled_over: number, errors: string[] }

   Interface:
   ```typescript
   interface ProcessResult {
     queued: number;
     rolled_over: number;
     errors: string[];
     skipped_wrong_hour: boolean;
   }
   ```

3. Create `app/api/cron/reminders/route.ts`:
   - `export const maxDuration = 300;` (5 minutes, Vercel Pro limit)
   - GET handler:
     - Verify CRON_SECRET: `request.headers.get('authorization') === Bearer ${process.env.CRON_SECRET}`
     - If no match, return 401
     - Call processReminders() with admin supabase client
     - Return JSON with result
   - Use createAdminClient() for service-role access

4. Update vercel.json cron schedule to `"0 8,9 * * *"` (both 8 and 9 UTC to cover BST/GMT).

5. Add CRON_SECRET to `.env.local.example` with a placeholder.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Verify vercel.json has cron configuration. Check that the cron route has CRON_SECRET validation and maxDuration = 300. Verify scheduler imports all required modules (working-days, calculators, variables, inheritance, bank-holidays).
  </verify>
  <done>Cron endpoint runs at 9am UK time (via 8+9 UTC with UK time check), acquires lock, builds/updates queue, marks due reminders as pending, resolves template variables, handles rollover. Queue pattern avoids 5-minute timeout.</done>
</task>

<task type="auto">
  <name>Task 3: Wire records-received and pause/unpause to queue</name>
  <files>app/api/clients/[id]/route.ts, app/(dashboard)/clients/[id]/page.tsx</files>
  <action>
1. Update `app/api/clients/[id]/route.ts` (existing file from Phase 1):
   - Add PATCH handler (or extend existing PUT handler) to handle:
     a. `reminders_paused` toggle: When set to true, no action needed on queue (reminders stay scheduled but cron skips paused clients). When set to false (unpause), call `handleUnpauseClient()` to cancel missed reminders.
     b. `records_received_for` update: When a filing_type_id is added to the array, call `cancelRemindersForReceivedRecords()` to cancel all scheduled reminders for that filing type.
     c. When a filing_type_id is removed from records_received_for (marking records as NOT received again), call `rebuildQueueForClient()` to re-create the scheduled reminders.

2. Update `app/(dashboard)/clients/[id]/page.tsx`:
   - Add "Mark Records Received" section:
     - For each active filing type assignment, show a checkbox "Records received"
     - When checked, calls PATCH /api/clients/[id] with updated records_received_for array
     - Show visual feedback (strikethrough on the filing type, or green checkmark)
   - The reminders_paused toggle should already exist from Plan 05, but ensure the unpause logic calls the queue handler

Both handlers use `createAdminClient()` for the queue operations (service-role needed for reminder_queue writes).
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Test: mark records as received for a filing type, verify reminders for that type are cancelled in the queue. Unpause a client, verify missed reminders are cancelled.
  </verify>
  <done>Records-received auto-cancels remaining reminders. Unpause skips missed reminders. Queue stays in sync with client status changes.</done>
</task>

</tasks>

<verification>
- vercel.json exists with cron configuration
- Cron route validates CRON_SECRET and has maxDuration = 300
- Scheduler acquires lock, checks UK time, builds queue, marks pending
- Queue builder creates entries from templates + deadlines + overrides
- Working day adjustment shifts send dates off weekends/holidays
- Records received cancels scheduled reminders
- Unpause skips missed reminders
- Rollover calculates next cycle deadlines
- `npm run build` passes
</verification>

<success_criteria>
- Daily cron correctly identifies due reminders
- Queue pattern prevents timeout (lightweight cron, batch processing)
- Working day adjustment per user decision
- Pause/unpause and records-received per user decision
- Automatic rollover when deadlines pass
- All template variables resolved in pending reminders
- Distributed lock prevents concurrent cron runs
</success_criteria>

<output>
After completion, create `.planning/phases/02-reminder-engine/02-08-SUMMARY.md`
</output>
