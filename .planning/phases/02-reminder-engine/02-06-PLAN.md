---
phase: 02-reminder-engine
plan: 06
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - app/(dashboard)/calendar/page.tsx
  - app/(dashboard)/calendar/components/deadline-calendar.tsx
  - app/api/calendar/deadlines/route.ts
  - app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Accountant can see a monthly calendar grid showing deadlines across ALL clients"
    - "Calendar events are color-coded by filing type"
    - "Calendar helps identify when deadlines cluster (busy periods)"
  artifacts:
    - path: "app/(dashboard)/calendar/page.tsx"
      provides: "Calendar page"
    - path: "app/(dashboard)/calendar/components/deadline-calendar.tsx"
      provides: "react-big-calendar month grid component"
    - path: "app/api/calendar/deadlines/route.ts"
      provides: "API endpoint returning deadline events for calendar"
      exports: ["GET"]
  key_links:
    - from: "app/(dashboard)/calendar/components/deadline-calendar.tsx"
      to: "app/api/calendar/deadlines/route.ts"
      via: "fetch to load deadline events"
      pattern: "fetch.*api/calendar/deadlines"
    - from: "app/api/calendar/deadlines/route.ts"
      to: "lib/deadlines/calculators.ts"
      via: "calculate deadlines for all clients"
      pattern: "import.*calculators"
---

<objective>
Build the global monthly calendar grid view showing filing deadlines across ALL clients. Uses react-big-calendar for the month view. Events are color-coded by filing type, helping the accountant see when deadlines cluster.

Purpose: Per user decision, the calendar gives a bird's-eye view of when deadlines cluster -- helping the accountant see busy periods coming and plan their workload.
Output: Calendar page at /calendar with react-big-calendar month grid, deadline events loaded from API.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-reminder-engine/02-RESEARCH.md
@.planning/phases/02-reminder-engine/02-01-SUMMARY.md
@.planning/phases/02-reminder-engine/02-02-SUMMARY.md
@lib/types/database.ts
@lib/deadlines/calculators.ts
@app/(dashboard)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Calendar deadlines API</name>
  <files>app/api/calendar/deadlines/route.ts</files>
  <action>
Create `app/api/calendar/deadlines/route.ts`:

- GET handler accepts query params: `month` (1-12), `year` (e.g. 2026)
- Fetch all clients with their filing assignments (client_filing_assignments with is_active = true)
- For each client + filing type pair, calculate the deadline using calculator functions from `@/lib/deadlines/calculators`
  - Also check client_deadline_overrides for custom dates
  - Use override date if present, otherwise use calculated date
- Filter to deadlines falling within the requested month/year (with some padding: include last few days of prior month and first few days of next month for calendar display)
- Return array of deadline events:
  ```typescript
  {
    events: Array<{
      id: string; // composite: clientId_filingTypeId
      title: string; // "ABC Ltd - Corporation Tax"
      date: string; // YYYY-MM-DD
      client_id: string;
      client_name: string;
      filing_type_id: string;
      filing_type_name: string;
      is_overridden: boolean;
    }>
  }
  ```
- Use createClient() from supabase/server
- If month/year params missing, default to current month
- Handle clients with missing metadata gracefully (skip if year-end not set for Corp Tax calc, etc.)
  </action>
  <verify>Run `npm run build` to confirm no TypeScript errors. Check that the route handles missing metadata gracefully.</verify>
  <done>Calendar deadlines API returns events for a given month/year with client name, filing type, and date.</done>
</task>

<task type="auto">
  <name>Task 2: Calendar page with react-big-calendar month grid</name>
  <files>app/(dashboard)/calendar/page.tsx, app/(dashboard)/calendar/components/deadline-calendar.tsx, app/(dashboard)/layout.tsx</files>
  <action>
1. Add "Calendar" nav link to `app/(dashboard)/layout.tsx` alongside "Clients" and "Templates" links.

2. Create `app/(dashboard)/calendar/components/deadline-calendar.tsx`:
   - Client component ("use client")
   - Uses react-big-calendar with date-fns localizer (NOT moment.js -- use the date-fns localizer since date-fns is already installed):
     ```
     import { Calendar, dateFnsLocalizer } from 'react-big-calendar';
     import { format, parse, startOfWeek, getDay } from 'date-fns';
     import { enGB } from 'date-fns/locale';
     import 'react-big-calendar/lib/css/react-big-calendar.css';
     ```
   - Configure with enGB locale (UK week starts Monday)
   - Month view only (views={['month']}, defaultView="month")
   - Color-code events by filing type using eventPropGetter:
     - corporation_tax_payment: blue (#3b82f6)
     - ct600_filing: indigo (#6366f1)
     - companies_house: amber (#f59e0b)
     - vat_return: green (#10b981)
     - self_assessment: red (#ef4444)
   - Event tooltip shows full info: client name, filing type, date, "(overridden)" if applicable
   - Calendar height: 600px minimum
   - On month change (onNavigate), fetch new deadlines for that month
   - Props: receives initial events and onMonthChange callback

3. Create `app/(dashboard)/calendar/page.tsx`:
   - Page title: "Deadline Calendar"
   - Subtitle: "Bird's-eye view of filing deadlines across all clients"
   - Fetch initial month's deadlines (current month) on server side
   - Render DeadlineCalendar component
   - Include a legend showing color-to-filing-type mapping (small colored badges below calendar)
   - Show total deadline count for current month view

4. Import and apply react-big-calendar CSS. If Next.js has issues with the CSS import, add it via a `calendar.css` file that imports the library CSS, or use a global import in layout.

Styling: Match dashboard design patterns. Calendar should fill available width. Use Tailwind for page layout around the calendar component.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Navigate to /calendar in browser. Verify month grid renders with react-big-calendar. Check that events appear color-coded on the correct dates. Navigate between months and verify events update.
  </verify>
  <done>Calendar page shows monthly grid with color-coded deadline events across all clients. Navigation between months fetches new data. Legend shows filing type colors. Calendar link in dashboard nav.</done>
</task>

</tasks>

<verification>
- /calendar page loads and shows react-big-calendar month grid
- Events appear on correct dates based on calculated deadlines
- Events are color-coded by filing type
- Month navigation fetches new deadline data
- Legend shows color-to-filing-type mapping
- "Calendar" link in dashboard nav works
- `npm run build` passes
</verification>

<success_criteria>
- Monthly calendar grid view works with react-big-calendar and date-fns localizer
- Deadline events displayed for all clients with active filing assignments
- Color-coded by filing type
- Override deadlines shown correctly
- Month navigation triggers data refresh
- Responsive layout matching dashboard design
</success_criteria>

<output>
After completion, create `.planning/phases/02-reminder-engine/02-06-SUMMARY.md`
</output>
