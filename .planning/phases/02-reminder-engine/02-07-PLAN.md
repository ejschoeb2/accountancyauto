---
phase: 02-reminder-engine
plan: 07
type: execute
wave: 3
depends_on: ["02-04", "02-05"]
files_modified:
  - app/(dashboard)/clients/[id]/components/template-overrides.tsx
  - app/api/clients/[id]/template-overrides/route.ts
  - app/(dashboard)/clients/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Accountant can override specific fields (subject, body, delay) for individual client's template steps"
    - "Overridden fields persist while non-overridden fields update when base template changes"
    - "Accountant can see which fields are overridden vs inherited"
    - "has_overrides badge on client list updates when overrides are added/removed"
  artifacts:
    - path: "app/api/clients/[id]/template-overrides/route.ts"
      provides: "Template override CRUD per client"
      exports: ["GET", "PUT", "DELETE"]
    - path: "app/(dashboard)/clients/[id]/components/template-overrides.tsx"
      provides: "Template override editor component"
  key_links:
    - from: "app/(dashboard)/clients/[id]/components/template-overrides.tsx"
      to: "lib/templates/inheritance.ts"
      via: "resolveTemplateForClient to show merged view"
      pattern: "import.*inheritance"
    - from: "app/(dashboard)/clients/[id]/components/template-overrides.tsx"
      to: "app/api/clients/[id]/template-overrides/route.ts"
      via: "fetch to save overrides"
      pattern: "fetch.*template-overrides"
---

<objective>
Build the per-client template override system. The accountant can customize specific fields (subject, body, delay_days) on any template step for an individual client, while non-overridden fields continue to inherit from the base template.

Purpose: Per user decision, field-level overrides let the accountant change specific fields while the base template remains the source of truth. This is the inheritance model: overridden fields persist, non-overridden fields update when the base template changes.
Output: Template override editor on client detail page, API for override CRUD.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-reminder-engine/02-RESEARCH.md
@.planning/phases/02-reminder-engine/02-01-SUMMARY.md
@.planning/phases/02-reminder-engine/02-03-SUMMARY.md
@.planning/phases/02-reminder-engine/02-04-SUMMARY.md
@.planning/phases/02-reminder-engine/02-05-SUMMARY.md
@lib/types/database.ts
@lib/templates/inheritance.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Template override API</name>
  <files>app/api/clients/[id]/template-overrides/route.ts</files>
  <action>
Create `app/api/clients/[id]/template-overrides/route.ts`:

- GET: Fetch all template overrides for this client from client_template_overrides.
  - Join with reminder_templates to get base template data.
  - For each template that has overrides, use `resolveTemplateForClient()` from `@/lib/templates/inheritance` to return the merged view.
  - Return structure:
    ```typescript
    {
      templates: Array<{
        template: ReminderTemplate; // base template
        overrides: ClientTemplateOverride[]; // raw overrides
        resolved_steps: TemplateStep[]; // merged result
        overridden_field_map: Record<number, string[]>; // step_index -> field names
      }>
    }
    ```
  - Also include templates without overrides (so UI can show "no overrides" state)

- PUT: Accept body:
  ```typescript
  {
    template_id: string;
    step_index: number;
    overridden_fields: { subject?: string; body?: string; delay_days?: number }
  }
  ```
  - Upsert into client_template_overrides (UNIQUE on client_id + template_id + step_index)
  - If overridden_fields is empty object {}, delete the override for that step (clearing all overrides)
  - After insert/delete, update clients.has_overrides via checking if any overrides remain for this client
  - Return updated override

- DELETE: Accept query params `template_id` and optionally `step_index`.
  - If step_index provided: delete specific step override
  - If only template_id: delete ALL overrides for that template for this client
  - Update clients.has_overrides accordingly
  - Return 204

Use createClient() from supabase/server. Validate with Zod.
  </action>
  <verify>Run `npm run build` to confirm no TypeScript errors. Verify the route handles upsert, delete, and has_overrides update correctly.</verify>
  <done>Template override API supports GET (merged view), PUT (upsert override), DELETE (clear overrides), and updates has_overrides flag on client.</done>
</task>

<task type="auto">
  <name>Task 2: Template override editor component on client detail page</name>
  <files>app/(dashboard)/clients/[id]/components/template-overrides.tsx, app/(dashboard)/clients/[id]/page.tsx</files>
  <action>
1. Create `app/(dashboard)/clients/[id]/components/template-overrides.tsx`:
   - Client component ("use client")
   - Props: clientId (string)
   - On mount, fetch from /api/clients/[id]/template-overrides
   - Display section: "Template Customizations"
   - For each template that the client has filing assignments for:
     - Show template name with filing type
     - Expandable section (use accordion or collapsible card)
     - Inside, show each step with the resolved (merged) values
     - For each field (subject, body, delay_days):
       - Show the current value (from resolved_steps)
       - If the field is overridden, highlight it visually (e.g., bold text, colored border, or "customized" badge)
       - If not overridden, show in normal/muted style with "(inherited)" label
       - "Edit" button per step opens inline editing:
         - Shows input/textarea for each field
         - Pre-fills with current value (whether inherited or overridden)
         - "Save" button calls PUT /api/clients/[id]/template-overrides with the changed fields only
         - "Reset to template default" button calls DELETE for that step_index, clearing override
     - "Reset All" button per template calls DELETE with template_id only
   - Success/error feedback via sonner toasts

2. Update `app/(dashboard)/clients/[id]/page.tsx`:
   - Add TemplateOverrides component below the filing assignments and deadline overrides sections
   - Only show if client has active filing assignments with associated templates

Use shadcn components: Accordion (or Card with collapsible pattern), Button, Input, Label, Badge, Textarea. Visual distinction between inherited and overridden fields is critical for the UX.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Navigate to a client detail page. Verify template override section shows resolved steps with inherited vs overridden distinction. Test editing a field, saving, and resetting.
  </verify>
  <done>Template override editor on client detail page shows merged template steps with clear visual distinction between inherited and overridden fields. Accountant can edit specific fields, save overrides, and reset to template defaults. has_overrides badge updates in client list.</done>
</task>

</tasks>

<verification>
- Client detail page shows template override section
- Inherited fields show normal/muted style
- Overridden fields show highlighted/customized style
- Can edit a single field on a step and save
- Non-edited fields remain inherited from base
- Can reset individual step overrides
- Can reset all overrides for a template
- has_overrides badge in client list updates
- `npm run build` passes
</verification>

<success_criteria>
- Field-level template overrides work per user decision (inheritance model)
- Overridden fields persist, non-overridden fields update when base template changes
- Clear visual distinction between inherited and overridden fields
- Override CRUD API functional
- has_overrides flag maintained correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-reminder-engine/02-07-SUMMARY.md`
</output>
