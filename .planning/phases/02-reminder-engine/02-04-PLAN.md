---
phase: 02-reminder-engine
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-03"]
files_modified:
  - app/api/templates/route.ts
  - app/api/templates/[id]/route.ts
  - app/(dashboard)/templates/page.tsx
  - app/(dashboard)/templates/[id]/edit/page.tsx
  - app/(dashboard)/templates/components/template-step-editor.tsx
  - lib/validations/template.ts
  - app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Accountant can see a list of reminder templates (one per filing type)"
    - "Accountant can create/edit a template with 1-5 steps using inline accordion editor"
    - "Each step has configurable days-before-deadline, subject, and body fields"
    - "Templates are persisted to the database"
    - "Available placeholder variables are displayed for reference in the editor"
  artifacts:
    - path: "app/api/templates/route.ts"
      provides: "Template list and create API"
      exports: ["GET", "POST"]
    - path: "app/api/templates/[id]/route.ts"
      provides: "Template get, update, delete API"
      exports: ["GET", "PUT", "DELETE"]
    - path: "app/(dashboard)/templates/page.tsx"
      provides: "Template list page"
    - path: "app/(dashboard)/templates/[id]/edit/page.tsx"
      provides: "Template accordion editor page"
    - path: "lib/validations/template.ts"
      provides: "Zod validation for template data"
      exports: ["templateSchema", "templateStepSchema"]
  key_links:
    - from: "app/(dashboard)/templates/[id]/edit/page.tsx"
      to: "app/api/templates/[id]/route.ts"
      via: "fetch PUT to save template"
      pattern: "fetch.*api/templates"
    - from: "app/(dashboard)/templates/page.tsx"
      to: "app/api/templates/route.ts"
      via: "fetch GET to list templates"
      pattern: "fetch.*api/templates"
    - from: "app/(dashboard)/templates/[id]/edit/page.tsx"
      to: "lib/templates/variables.ts"
      via: "imports AVAILABLE_PLACEHOLDERS for reference display"
      pattern: "AVAILABLE_PLACEHOLDERS"
---

<objective>
Build the template management system: API routes for CRUD operations on reminder templates, a list page showing all templates, and an inline accordion editor for creating/editing template steps (1-5 steps per template). Each step has days-before-deadline, subject, and body fields.

Purpose: The accountant needs to create and manage reminder templates that define the escalating email sequence for each filing type. This is the core configuration interface for the reminder engine.
Output: Working template list page and accordion step editor with database persistence.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-reminder-engine/02-RESEARCH.md
@.planning/phases/02-reminder-engine/02-01-SUMMARY.md
@.planning/phases/02-reminder-engine/02-03-SUMMARY.md
@lib/types/database.ts
@lib/supabase/server.ts
@app/(dashboard)/layout.tsx
@app/(dashboard)/clients/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Template API routes and validation</name>
  <files>app/api/templates/route.ts, app/api/templates/[id]/route.ts, lib/validations/template.ts</files>
  <action>
1. Create `lib/validations/template.ts` with Zod schemas:
   - `templateStepSchema`: z.object with step_number (int 1-5), delay_days (int 1-365), subject (string min 1 max 200), body (string min 1 max 5000)
   - `templateSchema`: z.object with filing_type_id (FilingTypeId), name (string min 1 max 100), description (string optional), steps (array of templateStepSchema, min 1 max 5), is_active (boolean)
   - Export inferred types

2. Create `app/api/templates/route.ts`:
   - GET: Fetch all templates from reminder_templates table, join with filing_types to get filing type name. Return array sorted by filing_type name.
   - POST: Validate body with templateSchema. Insert into reminder_templates. Return 201 with created template. Return 409 if template for that filing_type already exists (unique constraint).

3. Create `app/api/templates/[id]/route.ts`:
   - GET: Fetch single template by UUID, join with filing_types. Return 404 if not found.
   - PUT: Validate body with templateSchema (partial for update). Update reminder_templates row. Return updated template.
   - DELETE: Delete template by UUID. Return 204.

All routes use `createClient()` from `@/lib/supabase/server` (follow existing pattern from `app/api/clients/[id]/route.ts`). Return proper error responses with Zod error messages on validation failure.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Manually verify API routes exist by checking file paths. Check that Zod schemas enforce 1-5 step limit and all required fields.
  </verify>
  <done>Template API routes handle GET/POST (list), GET/PUT/DELETE (single), with Zod validation enforcing 1-5 steps and required fields.</done>
</task>

<task type="auto">
  <name>Task 2: Template list page and accordion step editor</name>
  <files>app/(dashboard)/templates/page.tsx, app/(dashboard)/templates/[id]/edit/page.tsx, app/(dashboard)/templates/components/template-step-editor.tsx, app/(dashboard)/layout.tsx</files>
  <action>
1. Add "Templates" nav link to `app/(dashboard)/layout.tsx` alongside existing "Clients" link. Link to `/templates`.

2. Create `app/(dashboard)/templates/page.tsx` (template list):
   - Fetch templates from /api/templates on server side (use createClient from supabase/server)
   - Display as card grid (one card per template)
   - Each card shows: template name, filing type, number of steps, active/inactive badge
   - "Create Template" button links to a create page (or opens a dialog to select filing type, then redirects to edit page)
   - Each card has "Edit" link to `/templates/[id]/edit`
   - Show which filing types don't have templates yet (fetch filing_types, compare)
   - If no templates exist, show empty state with prompt to create first template

3. Create `app/(dashboard)/templates/components/template-step-editor.tsx`:
   - Client component ("use client")
   - Uses React Hook Form with useFieldArray for steps
   - Each step renders inside a shadcn Accordion item (per user decision: inline accordion editor)
   - AccordionTrigger shows: "Step {n}: {delay_days} days before deadline - {subject preview}"
   - AccordionContent contains:
     - Days before deadline: number input (1-365)
     - Subject: text input
     - Body: textarea (5 rows)
     - Remove step button (disabled if only 1 step)
   - "Add Step" button at bottom (disabled if 5 steps, per user decision: max 5)
   - All steps visible on one page as accordion items (per user decision: all steps visible)
   - Below the steps, show a "Available Variables" reference section listing AVAILABLE_PLACEHOLDERS from `@/lib/types/database` with name and description for each

4. Create `app/(dashboard)/templates/[id]/edit/page.tsx`:
   - For existing templates: fetch template data, pre-populate form
   - For new templates (id = "new"): show empty form with filing type selector
   - Use TemplateStepEditor component
   - Form fields: name (input), description (textarea, optional), is_active (checkbox), filing type (select, read-only for existing templates)
   - Save button calls PUT /api/templates/[id] (or POST /api/templates for new)
   - Success: show sonner toast and redirect to template list
   - Error: show sonner toast with error message
   - Use shadcn components: Button, Input, Select, Accordion, Badge, Label

Styling: Follow existing dashboard patterns (max-w-7xl, consistent spacing, Tailwind). Cards should use border + rounded-lg + p-6 pattern.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Navigate to /templates in browser to see template list. Click through to create/edit a template. Verify accordion expands/collapses, steps can be added/removed (1-5 limit), and save persists to database.
  </verify>
  <done>Template list page shows all templates with cards. Accordion editor allows creating/editing 1-5 steps per template with days-before-deadline, subject, body fields. Available placeholder variables are displayed for reference. Templates persist to database on save.</done>
</task>

</tasks>

<verification>
- /templates page loads and shows template cards (or empty state)
- Can create a new template with 3 steps
- Accordion editor works: expand/collapse, add/remove steps
- Step limit enforced (min 1, max 5)
- Save persists to database
- Available variables reference displayed in editor
- "Templates" link visible in dashboard nav
- `npm run build` passes
</verification>

<success_criteria>
- Template CRUD API fully functional (list, create, read, update, delete)
- Template list page with cards showing all templates
- Accordion step editor with React Hook Form useFieldArray
- 1-5 step limit enforced in UI
- Placeholder variable reference displayed
- Templates link in dashboard nav
</success_criteria>

<output>
After completion, create `.planning/phases/02-reminder-engine/02-04-SUMMARY.md`
</output>
