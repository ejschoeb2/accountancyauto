---
phase: 02-reminder-engine
plan: 05
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - app/api/clients/[id]/filings/route.ts
  - app/api/clients/[id]/deadlines/route.ts
  - app/api/filing-types/route.ts
  - app/(dashboard)/clients/[id]/page.tsx
  - app/(dashboard)/clients/[id]/components/filing-assignments.tsx
  - app/(dashboard)/clients/[id]/components/deadline-overrides.tsx
  - app/(dashboard)/clients/components/client-table.tsx
autonomous: true

must_haves:
  truths:
    - "Filing types are auto-assigned based on client type when a client is first viewed"
    - "Accountant can toggle filing types on/off per client"
    - "System calculates deadlines from client metadata using deadline calculator functions"
    - "Accountant can override calculated deadline with a custom date per filing type"
    - "Override badge appears on clients in the list view"
  artifacts:
    - path: "app/api/clients/[id]/filings/route.ts"
      provides: "Filing assignment CRUD per client"
      exports: ["GET", "PUT"]
    - path: "app/api/clients/[id]/deadlines/route.ts"
      provides: "Deadline override CRUD per client"
      exports: ["GET", "PUT", "DELETE"]
    - path: "app/(dashboard)/clients/[id]/page.tsx"
      provides: "Client detail page with filing management"
    - path: "app/(dashboard)/clients/[id]/components/filing-assignments.tsx"
      provides: "Filing type toggle component"
    - path: "app/(dashboard)/clients/[id]/components/deadline-overrides.tsx"
      provides: "Deadline override editor component"
  key_links:
    - from: "app/(dashboard)/clients/[id]/components/filing-assignments.tsx"
      to: "app/api/clients/[id]/filings/route.ts"
      via: "fetch to toggle filing assignments"
      pattern: "fetch.*filings"
    - from: "app/(dashboard)/clients/[id]/components/deadline-overrides.tsx"
      to: "lib/deadlines/calculators.ts"
      via: "calculates deadline to show alongside override"
      pattern: "import.*calculators"
---

<objective>
Build the filing type assignment system and deadline override functionality. Clients get filing types auto-assigned based on their client type (Limited Company gets Corp Tax + Companies House, etc.) with manual toggle. Each filing type shows the calculated deadline with option to override with a custom date.

Purpose: Before reminders can be scheduled, the system needs to know which filing types apply to each client and what the deadlines are. This plan creates the client detail page where the accountant manages filings and overrides.
Output: Client detail page with filing assignment toggles, calculated deadlines, and deadline override capability.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-reminder-engine/02-RESEARCH.md
@.planning/phases/02-reminder-engine/02-01-SUMMARY.md
@.planning/phases/02-reminder-engine/02-02-SUMMARY.md
@lib/types/database.ts
@lib/deadlines/calculators.ts
@lib/supabase/server.ts
@app/(dashboard)/clients/components/client-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Filing assignment and deadline override API routes</name>
  <files>app/api/clients/[id]/filings/route.ts, app/api/clients/[id]/deadlines/route.ts, app/api/filing-types/route.ts</files>
  <action>
1. Create `app/api/filing-types/route.ts`:
   - GET: Fetch all filing_types from database. Return sorted by name.

2. Create `app/api/clients/[id]/filings/route.ts`:
   - GET: Fetch client's filing assignments from client_filing_assignments. Join with filing_types for display names. Also fetch the client record to get client_type, year_end_date, vat_quarter, vat_registered.
     - For each assigned filing type, calculate the deadline using the calculator functions from `@/lib/deadlines/calculators`.
     - Also check client_deadline_overrides for any overrides.
     - Return structure: `{ filings: Array<{ filing_type: FilingType, is_active: boolean, calculated_deadline: string | null, override_deadline: string | null, override_reason: string | null }> }`
   - PUT: Accept body `{ assignments: Array<{ filing_type_id: string, is_active: boolean }> }`.
     - Upsert into client_filing_assignments (insert on conflict update is_active).
     - Return updated assignments.

   Auto-assignment logic (in GET handler):
   - If client has NO filing assignments yet, auto-create them based on client_type:
     - Check filing_types.applicable_client_types against client.client_type
     - Insert matching assignments with is_active = true
     - For VAT: only assign if client.vat_registered = true
   - This runs on first GET (lazy initialization)

3. Create `app/api/clients/[id]/deadlines/route.ts`:
   - GET: Fetch all deadline overrides for this client from client_deadline_overrides. Return array.
   - PUT: Accept body `{ filing_type_id: string, override_date: string, reason?: string }`.
     - Upsert into client_deadline_overrides (UNIQUE on client_id + filing_type_id).
     - Return the override.
   - DELETE: Accept query param `filing_type_id`. Delete the override for that client + filing type. Return 204.

All routes: use createClient() from supabase/server. Return proper error codes. Validate params with Zod.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Verify API routes exist at the correct paths. Check that calculator functions are imported and used to compute deadlines.
  </verify>
  <done>Filing assignment API auto-assigns filing types based on client type, returns calculated deadlines, and supports manual toggle. Deadline override API supports create/update/delete per client per filing type.</done>
</task>

<task type="auto">
  <name>Task 2: Client detail page with filing assignments and deadline overrides</name>
  <files>app/(dashboard)/clients/[id]/page.tsx, app/(dashboard)/clients/[id]/components/filing-assignments.tsx, app/(dashboard)/clients/[id]/components/deadline-overrides.tsx, app/(dashboard)/clients/components/client-table.tsx</files>
  <action>
1. Create `app/(dashboard)/clients/[id]/page.tsx` (client detail page):
   - Server component that fetches client data by UUID from params
   - Shows client header: company name, client type badge, email, phone
   - Shows client metadata: year-end date, VAT registered, VAT quarter
   - Renders FilingAssignments component
   - Renders DeadlineOverrides component
   - Back link to /clients
   - Add "reminders_paused" toggle (checkbox/switch) that updates the client record

2. Create `app/(dashboard)/clients/[id]/components/filing-assignments.tsx`:
   - Client component ("use client")
   - Fetches filing assignments from /api/clients/[id]/filings on mount
   - Displays each filing type as a row with:
     - Filing type name
     - Toggle switch (is_active) - when toggled, calls PUT /api/clients/[id]/filings
     - Calculated deadline date (formatted with date-fns: "31 January 2026")
     - If no deadline calculable (missing year-end date), show "Set year-end date to calculate"
     - If override exists, show override date with "(overridden)" label
   - Auto-assignment happens transparently (first GET triggers it)

3. Create `app/(dashboard)/clients/[id]/components/deadline-overrides.tsx`:
   - Client component ("use client")
   - For each active filing type assignment, show an "Override" button
   - When clicked, expand inline form with:
     - Date picker (input type="date")
     - Reason text input (optional)
     - Save button -> PUT /api/clients/[id]/deadlines
   - If override already exists, show current override with "Remove Override" button -> DELETE
   - Show calculated vs overridden deadline clearly

4. Update `app/(dashboard)/clients/components/client-table.tsx`:
   - Make company_name column a clickable link to `/clients/[id]`
   - Add "has_overrides" badge column (small indicator if client.has_overrides is true) per user decision
   - Add "reminders_paused" badge if client.reminders_paused is true

Use shadcn components: Badge, Button, Input, Label, Checkbox. Follow existing dashboard styling patterns.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Navigate to /clients, click a client name to open detail page. Verify filing types appear with toggles. Check that deadlines are calculated and displayed. Test override creation and removal.
  </verify>
  <done>Client detail page shows filing assignments with auto-assignment, calculated deadlines, toggle controls, and deadline override capability. Client table has clickable names linking to detail page with has_overrides badge.</done>
</task>

</tasks>

<verification>
- Client detail page loads at /clients/[id]
- Filing types auto-assigned on first visit based on client type
- Toggles work to enable/disable filing types
- Deadlines calculated from client metadata
- Deadline overrides can be created, viewed, and removed
- has_overrides badge shows in client list
- Client names in table are clickable links
- `npm run build` passes
</verification>

<success_criteria>
- Filing type auto-assignment works for all client types
- Manual toggle on/off per filing type per client
- Calculated deadlines displayed for all active filings
- Deadline overrides with date and reason
- Client list shows has_overrides and reminders_paused badges
- Client names link to detail page
</success_criteria>

<output>
After completion, create `.planning/phases/02-reminder-engine/02-05-SUMMARY.md`
</output>
