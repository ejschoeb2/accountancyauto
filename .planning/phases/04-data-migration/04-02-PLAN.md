---
phase: 04-data-migration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - supabase/migrations/20260208000002_migrate_v10_data_to_normalized.sql
  - scripts/verify-migration.ts
autonomous: true

must_haves:
  truths:
    - "Every reminder_templates row has a corresponding email_templates row preserving its UUID"
    - "Every reminder_templates row has a corresponding schedules row linked to the same filing_type_id"
    - "Every step in reminder_templates.steps JSONB has a corresponding schedule_steps row with correct delay_days and step_number"
    - "Plain text template bodies are wrapped in TipTap JSON paragraph nodes"
    - "Empty or missing template bodies produce a valid empty TipTap document"
    - "Content overrides (subject, body) from client_template_overrides are in client_email_overrides"
    - "Timing overrides (delay_days) from client_template_overrides are in client_schedule_overrides"
    - "Row counts match between old and new structures"
    - "Old tables (reminder_templates, client_template_overrides) are untouched and still contain their original data"
  artifacts:
    - path: "supabase/migrations/20260208000002_migrate_v10_data_to_normalized.sql"
      provides: "Data migration from JSONB to normalized tables"
      contains: "INSERT INTO email_templates"
    - path: "scripts/verify-migration.ts"
      provides: "Verification script comparing old and new data"
      contains: "verify"
  key_links:
    - from: "reminder_templates.id"
      to: "email_templates.id"
      via: "UUID preservation in migration INSERT"
      pattern: "INSERT INTO email_templates.*SELECT.*id.*FROM reminder_templates"
    - from: "reminder_templates.steps"
      to: "schedule_steps"
      via: "JSONB array element extraction"
      pattern: "jsonb_array_elements"
    - from: "client_template_overrides.overridden_fields"
      to: "client_email_overrides + client_schedule_overrides"
      via: "Field splitting in migration"
      pattern: "subject|body.*client_email_overrides|delay_days.*client_schedule_overrides"
---

<objective>
Migrate existing v1.0 data from JSONB-embedded reminder templates into the new normalized tables, then verify the migration is correct.

Purpose: This is the actual data migration that fulfills MIGR-01 through MIGR-07. After this plan, the new tables contain all existing template and override data, ready for Phase 5+ to build UI on top of. The old tables remain intact for rollback safety.

Output: A SQL migration that copies data from old to new structure, and a verification script that confirms row counts and data integrity.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-data-migration/04-CONTEXT.md
@.planning/phases/04-data-migration/04-01-SUMMARY.md

Key source files for understanding the data being migrated:
@supabase/migrations/20260207000002_create_phase2_schema.sql
@lib/types/database.ts
@lib/templates/inheritance.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data migration SQL</name>
  <files>supabase/migrations/20260208000002_migrate_v10_data_to_normalized.sql</files>
  <action>
Create a Supabase migration that copies data from old tables to new tables. This migration must be idempotent (safe to run multiple times). Use a DO block with PL/pgSQL for the migration logic.

**Step 1: Migrate reminder_templates -> email_templates (MIGR-01, MIGR-05)**

For each row in reminder_templates, create ONE email_template using the SAME UUID (preserving template IDs per MIGR-05). Each reminder_template currently has one body per step, but in the new model each email_template is standalone. Since each step has its own subject+body, create one email_template per unique (subject, body) combination across all steps. However, for simplicity and UUID preservation, create one email_template per step (each step becomes its own template).

Actually, the cleaner approach given the data model: For each reminder_template, iterate its steps array and create one email_template per step. The email_template.id should be a NEW UUID (we can't reuse the template UUID for multiple rows). BUT we need to preserve the original template UUID somewhere for override mapping.

**Revised approach (simplest correct migration):**

For each `reminder_templates` row:
1. Create a `schedules` row with a NEW UUID, linking to the same `filing_type_id`. Copy `name`, `description`, `is_active`.
2. For each step in the `steps` JSONB array:
   a. Create an `email_templates` row with a NEW UUID. Set:
      - `name`: `{template_name} - Step {step_number}` (e.g., "Corporation Tax - Step 1")
      - `subject`: step.subject
      - `body_json`: Convert step.body to TipTap JSON (see conversion logic below)
      - `body_plain`: step.body (preserve original plain text)
      - `is_active`: true
   b. Create a `schedule_steps` row linking the new schedule to the new email_template:
      - `schedule_id`: the schedule created in step 1
      - `email_template_id`: the email_template created in step 2a
      - `step_number`: step.step_number
      - `delay_days`: step.delay_days
      - `urgency_level`: Derive from step_number: step 1 = 'normal', step 2 = 'normal', step 3 = 'high', step 4+ = 'urgent'

**TipTap JSON conversion (MIGR-03, per user decision):**

Plain text body -> TipTap paragraph node. The conversion wraps the entire body in a single paragraph:

```json
{
  "type": "doc",
  "content": [
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "<original body text here>"
        }
      ]
    }
  ]
}
```

For empty or null bodies, create an empty doc:
```json
{
  "type": "doc",
  "content": [
    {
      "type": "paragraph"
    }
  ]
}
```

Keep {{placeholders}} as plain text in the JSON (per user decision -- NOT converted to mention nodes).

**Step 2: Migrate client_template_overrides -> client_email_overrides + client_schedule_overrides (MIGR-04)**

For each `client_template_overrides` row:
1. Find the corresponding schedule_step by matching:
   - The old `template_id` -> find the schedule created from that template
   - The old `step_index` -> match to step_number (step_index is 0-based, step_number is 1-based, so step_number = step_index + 1)
   - From the schedule_step, get the email_template_id

2. If `overridden_fields` contains `subject` or `body`:
   - Create/update a `client_email_overrides` row with:
     - `client_id`: same
     - `email_template_id`: from the matched schedule_step
     - `subject_override`: overridden_fields.subject (or null if not overridden)
     - `body_json_override`: Convert overridden_fields.body to TipTap JSON (same paragraph-wrap logic) or null if not overridden

3. If `overridden_fields` contains `delay_days`:
   - Create a `client_schedule_overrides` row with:
     - `client_id`: same
     - `schedule_step_id`: from the matched schedule_step
     - `delay_days_override`: overridden_fields.delay_days

**Implementation approach:** Use a PL/pgSQL DO block with a temporary mapping table to track old_template_id + step_index -> new email_template_id + schedule_step_id. This mapping is needed for the override migration.

Create a temporary table `_migration_step_map` with columns:
- old_template_id UUID
- old_step_index INT
- new_email_template_id UUID
- new_schedule_step_id UUID
- new_schedule_id UUID

Populate it during Step 1, use it during Step 2, then drop it at the end.

**Idempotency:** Check if email_templates is empty before running. If already populated, skip the migration with a RAISE NOTICE.

**MIGR-07 compliance:** Do NOT modify or drop reminder_templates or client_template_overrides tables. They remain as-is.
  </action>
  <verify>
1. Migration file exists and is valid SQL
2. Contains INSERT INTO email_templates with TipTap JSON construction
3. Contains INSERT INTO schedules linked to filing_types
4. Contains INSERT INTO schedule_steps linking schedules to email_templates
5. Contains logic to split client_template_overrides into client_email_overrides and client_schedule_overrides
6. Uses idempotency check (skip if email_templates already has data)
7. Does NOT contain ALTER TABLE, DROP TABLE, or any modifications to reminder_templates or client_template_overrides
  </verify>
  <done>Data migration SQL exists that transforms JSONB-embedded templates to normalized rows with TipTap JSON bodies and split overrides. Old tables are untouched.</done>
</task>

<task type="auto">
  <name>Task 2: Create migration verification script</name>
  <files>scripts/verify-migration.ts</files>
  <action>
Create a TypeScript script at scripts/verify-migration.ts that can be run with `npx tsx scripts/verify-migration.ts` to verify the migration was successful (MIGR-06).

The script should:

1. **Connect to Supabase** using the admin client (import from @/lib/supabase/admin.ts)

2. **Count comparisons:**
   - Count reminder_templates rows -> should equal schedules rows (1:1)
   - Count total steps across all reminder_templates.steps JSONB arrays -> should equal schedule_steps rows AND email_templates rows
   - Count client_template_overrides rows -> should have corresponding entries in client_email_overrides and/or client_schedule_overrides (total override rows in new tables >= old rows, since one old row can produce both a content and timing override)

3. **Data integrity checks:**
   - For each schedule, verify filing_type_id matches the original reminder_template's filing_type_id
   - For each email_template, verify body_json is valid TipTap JSON (has type: 'doc' and content array)
   - For each schedule_step, verify delay_days matches the original step's delay_days
   - Verify no email_templates have null or empty body_json

4. **Output format:**
   Print a clear results table:
   ```
   === Migration Verification ===

   Row Counts:
     reminder_templates:        N
     schedules:                 N  (expected: N) [PASS/FAIL]
     total steps (JSONB):       N
     schedule_steps:            N  (expected: N) [PASS/FAIL]
     email_templates:           N  (expected: N) [PASS/FAIL]
     client_template_overrides: N
     client_email_overrides:    N
     client_schedule_overrides: N
     total new overrides:       N  (expected: >= N) [PASS/FAIL]

   Data Integrity:
     Filing type consistency:   [PASS/FAIL]
     TipTap JSON validity:      [PASS/FAIL]
     Delay days consistency:    [PASS/FAIL]

   Overall: [PASS/FAIL]
   ```

5. **Exit code:** Exit 0 if all checks pass, exit 1 if any fail.

Import the admin supabase client. Use `dotenv` or rely on the Next.js env loading -- check if `@/lib/supabase/admin.ts` uses `process.env` directly and match that approach.

The script should handle the case where migration hasn't run yet (new tables empty) gracefully, printing a message like "Migration has not been run yet (new tables are empty)".
  </action>
  <verify>
1. Script exists at scripts/verify-migration.ts
2. Script can be parsed by TypeScript (no syntax errors)
3. Script connects to Supabase and runs count queries on both old and new tables
4. Script checks TipTap JSON structure validity
5. Script prints clear PASS/FAIL output
6. Script exits with code 0 on success, 1 on failure
  </verify>
  <done>Verification script exists that compares row counts between old and new structures, validates TipTap JSON format, and prints a clear pass/fail report. Can be run anytime to confirm migration integrity.</done>
</task>

</tasks>

<verification>
1. Migration file 20260208000002 exists and contains data migration logic
2. email_templates rows are created from reminder_templates.steps with TipTap JSON bodies
3. schedules rows are created 1:1 from reminder_templates with filing_type_id preserved
4. schedule_steps rows link schedules to email_templates with correct step_number and delay_days
5. client_template_overrides are split: subject/body -> client_email_overrides, delay_days -> client_schedule_overrides
6. Template UUIDs from reminder_templates are NOT reused (new UUIDs for email_templates) but a mapping tracks the relationship
7. Empty bodies produce valid empty TipTap documents, not null
8. {{placeholders}} remain as plain text in TipTap JSON (not converted to mention nodes)
9. Verification script confirms row counts match
10. Old tables remain untouched with original data
</verification>

<success_criteria>
- Data migration SQL transforms all reminder_templates into email_templates + schedules + schedule_steps
- Override splitting correctly separates content from timing overrides
- Verification script confirms data integrity with PASS result
- Old reminder system is completely unaffected (old tables unchanged, queue-builder.ts still reads from reminder_templates)
- All 7 MIGR requirements are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-migration/04-02-SUMMARY.md`
</output>
