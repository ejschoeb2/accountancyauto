---
phase: 04-data-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260208000001_create_v11_normalized_tables.sql
  - lib/types/database.ts
autonomous: true

must_haves:
  truths:
    - "email_templates table exists with id, name, subject, body_json, created_at, updated_at columns"
    - "schedules table exists with id, filing_type_id (FK), name, is_active, created_at, updated_at columns"
    - "schedule_steps table exists with id, schedule_id (FK), email_template_id (FK), step_number, delay_days, urgency_level, created_at columns"
    - "client_email_overrides table exists with client_id + email_template_id unique constraint"
    - "client_schedule_overrides table exists with client_id + schedule_step_id unique constraint"
    - "All new tables have RLS enabled with anon, authenticated, and service_role policies"
    - "TypeScript types match the new table schemas"
  artifacts:
    - path: "supabase/migrations/20260208000001_create_v11_normalized_tables.sql"
      provides: "DDL for all v1.1 normalized tables"
      contains: "CREATE TABLE email_templates"
    - path: "lib/types/database.ts"
      provides: "Updated TypeScript interfaces for new tables"
      contains: "EmailTemplate"
  key_links:
    - from: "schedule_steps"
      to: "email_templates"
      via: "FK email_template_id"
      pattern: "REFERENCES email_templates"
    - from: "schedule_steps"
      to: "schedules"
      via: "FK schedule_id"
      pattern: "REFERENCES schedules"
    - from: "client_email_overrides"
      to: "email_templates"
      via: "FK email_template_id"
      pattern: "REFERENCES email_templates"
    - from: "client_schedule_overrides"
      to: "schedule_steps"
      via: "FK schedule_step_id"
      pattern: "REFERENCES schedule_steps"
---

<objective>
Create the v1.1 normalized database tables alongside the existing v1.0 tables.

Purpose: Phase 5-9 all depend on these tables existing. This is the foundation for decoupling email templates from scheduling logic. The old tables remain untouched so the existing reminder system continues to function.

Output: A Supabase migration file creating 5 new tables (email_templates, schedules, schedule_steps, client_email_overrides, client_schedule_overrides) and updated TypeScript types.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-data-migration/04-CONTEXT.md

Key existing schema files to reference for conventions:
@supabase/migrations/20260207000002_create_phase2_schema.sql
@supabase/migrations/20260207193244_add_anon_phase2_policies.sql
@lib/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create v1.1 normalized tables migration</name>
  <files>supabase/migrations/20260208000001_create_v11_normalized_tables.sql</files>
  <action>
Create a Supabase migration file with the following tables. Follow the exact conventions from the Phase 2 migration (uuid_generate_v4() or gen_random_uuid() for PKs, TIMESTAMPTZ defaults, update_updated_at trigger reuse, RLS with authenticated + service_role + anon policies).

**Table 1: email_templates**
- id: UUID PK (use gen_random_uuid() to match reminder_templates convention)
- name: TEXT NOT NULL
- subject: TEXT NOT NULL (the email subject line with {{placeholder}} syntax)
- body_json: JSONB NOT NULL (TipTap JSON document structure)
- body_plain: TEXT (plain text fallback, preserved from original)
- is_active: BOOLEAN NOT NULL DEFAULT true
- created_at: TIMESTAMPTZ DEFAULT now()
- updated_at: TIMESTAMPTZ DEFAULT now()
- Add update_updated_at trigger

**Table 2: schedules**
- id: UUID PK (gen_random_uuid())
- filing_type_id: TEXT REFERENCES filing_types(id) ON DELETE CASCADE, UNIQUE (one schedule per filing type, same as reminder_templates)
- name: TEXT NOT NULL
- description: TEXT
- is_active: BOOLEAN NOT NULL DEFAULT true
- created_at: TIMESTAMPTZ DEFAULT now()
- updated_at: TIMESTAMPTZ DEFAULT now()
- Add update_updated_at trigger

**Table 3: schedule_steps**
- id: UUID PK (gen_random_uuid())
- schedule_id: UUID REFERENCES schedules(id) ON DELETE CASCADE NOT NULL
- email_template_id: UUID REFERENCES email_templates(id) ON DELETE RESTRICT NOT NULL (RESTRICT because deleting a template that's in use would break the schedule)
- step_number: INT NOT NULL (1-based, matches existing step_number convention)
- delay_days: INT NOT NULL (days before deadline to send)
- urgency_level: TEXT NOT NULL DEFAULT 'normal' CHECK (urgency_level IN ('low', 'normal', 'high', 'urgent'))
- created_at: TIMESTAMPTZ DEFAULT now()
- UNIQUE(schedule_id, step_number) to prevent duplicate step numbers within a schedule

**Table 4: client_email_overrides**
- id: UUID PK (gen_random_uuid())
- client_id: UUID REFERENCES clients(id) ON DELETE CASCADE NOT NULL
- email_template_id: UUID REFERENCES email_templates(id) ON DELETE CASCADE NOT NULL
- subject_override: TEXT (null means use template default)
- body_json_override: JSONB (null means use template default)
- created_at: TIMESTAMPTZ DEFAULT now()
- updated_at: TIMESTAMPTZ DEFAULT now()
- UNIQUE(client_id, email_template_id) -- one content override per client per template
- Add update_updated_at trigger

**Table 5: client_schedule_overrides**
- id: UUID PK (gen_random_uuid())
- client_id: UUID REFERENCES clients(id) ON DELETE CASCADE NOT NULL
- schedule_step_id: UUID REFERENCES schedule_steps(id) ON DELETE CASCADE NOT NULL
- delay_days_override: INT (null means use step default)
- is_skipped: BOOLEAN NOT NULL DEFAULT false (allows skipping a step for this client)
- created_at: TIMESTAMPTZ DEFAULT now()
- updated_at: TIMESTAMPTZ DEFAULT now()
- UNIQUE(client_id, schedule_step_id) -- one timing override per client per step
- Add update_updated_at trigger

**Indexes:**
- idx_schedule_steps_schedule ON schedule_steps(schedule_id)
- idx_schedule_steps_template ON schedule_steps(email_template_id)
- idx_client_email_overrides_client ON client_email_overrides(client_id)
- idx_client_email_overrides_template ON client_email_overrides(email_template_id)
- idx_client_schedule_overrides_client ON client_schedule_overrides(client_id)
- idx_client_schedule_overrides_step ON client_schedule_overrides(schedule_step_id)

**RLS policies** (follow exact pattern from 20260207193244):
- All 5 tables: Enable RLS
- All 5 tables: authenticated SELECT + ALL policies
- All 5 tables: service_role ALL policy
- All 5 tables: anon SELECT + ALL policies (app uses anon role, no Supabase Auth login)

**Important:** Do NOT modify or drop any existing tables. The old reminder_templates and client_template_overrides tables must remain intact.
  </action>
  <verify>
Run `npx supabase db push` or verify migration SQL syntax is valid by checking:
1. File exists at the correct path with timestamp prefix
2. All CREATE TABLE statements use IF NOT EXISTS for safety
3. All FK references point to existing tables (filing_types, clients) or tables created earlier in this migration (email_templates, schedules, schedule_steps)
4. RLS policies cover anon, authenticated, and service_role for all 5 tables
  </verify>
  <done>Migration file exists with 5 tables, proper FKs, indexes, triggers, and RLS policies. No existing tables are modified or dropped.</done>
</task>

<task type="auto">
  <name>Task 2: Add TypeScript interfaces for new tables</name>
  <files>lib/types/database.ts</files>
  <action>
Add new TypeScript interfaces to lib/types/database.ts. Append them AFTER the existing interfaces (do NOT modify any existing types -- ReminderTemplate, ClientTemplateOverride, TemplateStep etc. must remain unchanged since the old system still uses them).

Add these interfaces:

```typescript
// ============================================================================
// v1.1 Normalized Tables
// ============================================================================

export interface EmailTemplate {
  id: string;
  name: string;
  subject: string;
  body_json: TipTapDocument;
  body_plain: string | null;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

export interface TipTapDocument {
  type: 'doc';
  content: TipTapNode[];
}

export interface TipTapNode {
  type: string;
  content?: TipTapNode[];
  text?: string;
  attrs?: Record<string, unknown>;
  marks?: Array<{ type: string; attrs?: Record<string, unknown> }>;
}

export type UrgencyLevel = 'low' | 'normal' | 'high' | 'urgent';

export interface Schedule {
  id: string;
  filing_type_id: FilingTypeId;
  name: string;
  description: string | null;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

export interface ScheduleStep {
  id: string;
  schedule_id: string;
  email_template_id: string;
  step_number: number;
  delay_days: number;
  urgency_level: UrgencyLevel;
  created_at: string;
}

export interface ClientEmailOverride {
  id: string;
  client_id: string;
  email_template_id: string;
  subject_override: string | null;
  body_json_override: TipTapDocument | null;
  created_at: string;
  updated_at: string;
}

export interface ClientScheduleOverride {
  id: string;
  client_id: string;
  schedule_step_id: string;
  delay_days_override: number | null;
  is_skipped: boolean;
  created_at: string;
  updated_at: string;
}
```

Preserve all existing exports. The PLACEHOLDER_VARIABLES const at the bottom must remain.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify that:
1. All existing types (ReminderTemplate, ClientTemplateOverride, TemplateStep, etc.) still exist unchanged
2. New types (EmailTemplate, Schedule, ScheduleStep, etc.) are exported
3. TipTapDocument and TipTapNode types are properly defined
4. UrgencyLevel union type matches the CHECK constraint in the migration
  </verify>
  <done>lib/types/database.ts contains both old and new interfaces. TypeScript compilation passes. No existing types were modified.</done>
</task>

</tasks>

<verification>
1. Migration file exists at supabase/migrations/20260208000001_create_v11_normalized_tables.sql
2. Migration creates exactly 5 tables: email_templates, schedules, schedule_steps, client_email_overrides, client_schedule_overrides
3. All FKs are correct (schedule_steps.email_template_id -> email_templates, schedule_steps.schedule_id -> schedules, etc.)
4. email_templates uses ON DELETE RESTRICT from schedule_steps (prevents accidental deletion of in-use templates)
5. RLS policies exist for anon, authenticated, and service_role on all 5 tables
6. lib/types/database.ts exports EmailTemplate, Schedule, ScheduleStep, ClientEmailOverride, ClientScheduleOverride, TipTapDocument, TipTapNode, UrgencyLevel
7. Existing types (ReminderTemplate, ClientTemplateOverride, TemplateStep) are unchanged
8. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- 5 new database tables exist alongside old tables
- TypeScript types match schema exactly
- No existing tables or types were modified
- Old reminder system remains fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-migration/04-01-SUMMARY.md`
</output>
