---
phase: 01-foundation-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - tailwind.config.ts
  - postcss.config.mjs
  - middleware.ts
  - instrumentation.ts
  - .env.local.example
  - lib/supabase/client.ts
  - lib/supabase/server.ts
  - lib/supabase/middleware.ts
  - lib/supabase/admin.ts
  - lib/validations/env.ts
  - app/layout.tsx
  - app/page.tsx
  - components/ui/*
autonomous: true
user_setup:
  - service: supabase
    why: "Database, auth, and backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API -> anon public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API -> service_role secret key"
  - service: quickbooks
    why: "QuickBooks OAuth integration (keys needed for env validation at startup)"
    env_vars:
      - name: QUICKBOOKS_CLIENT_ID
        source: "Intuit Developer Portal -> Dashboard -> Your App -> Keys & credentials"
      - name: QUICKBOOKS_CLIENT_SECRET
        source: "Intuit Developer Portal -> Dashboard -> Your App -> Keys & credentials"
      - name: QUICKBOOKS_REDIRECT_URI
        source: "Set to http://localhost:3000/onboarding/callback for development"
      - name: QUICKBOOKS_ENVIRONMENT
        source: "Set to 'sandbox' for development"

must_haves:
  truths:
    - "Next.js dev server starts without errors"
    - "Environment variables are validated at startup with clear error messages for missing vars"
    - "Supabase client can be created in both server and browser contexts"
    - "Database schema exists with tables for clients, oauth_tokens, and locks"
    - "Middleware refreshes Supabase auth tokens on every request"
  artifacts:
    - path: "package.json"
      provides: "All Phase 1 dependencies installed"
      contains: "next"
    - path: "lib/supabase/server.ts"
      provides: "Server-side Supabase client"
      exports: ["createClient"]
    - path: "lib/supabase/client.ts"
      provides: "Browser Supabase client"
      exports: ["createClient"]
    - path: "lib/validations/env.ts"
      provides: "Zod env validation"
      exports: ["validateEnv"]
    - path: "middleware.ts"
      provides: "Auth token refresh middleware"
      exports: ["middleware", "config"]
    - path: "instrumentation.ts"
      provides: "Startup env validation hook"
      exports: ["register"]
  key_links:
    - from: "instrumentation.ts"
      to: "lib/validations/env.ts"
      via: "dynamic import in register()"
      pattern: "import.*validations/env"
    - from: "middleware.ts"
      to: "lib/supabase/middleware.ts"
      via: "updateSession call"
      pattern: "updateSession"
---

<objective>
Scaffold the Next.js 15 project with Supabase integration, database schema, environment validation, and all Phase 1 dependencies installed.

Purpose: Establish the foundation that all other Phase 1 plans depend on -- project structure, database tables, Supabase auth, and validated configuration.
Output: A running Next.js dev server with Supabase connected, database schema applied via Supabase MCP, and environment validation at startup.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-integration/01-RESEARCH.md
@.planning/phases/01-foundation-integration/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 15 project and install all Phase 1 dependencies</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    tailwind.config.ts
    postcss.config.mjs
    app/layout.tsx
    app/page.tsx
    .env.local.example
    .gitignore
  </files>
  <action>
    Create a new Next.js 15 project using `npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir=false --import-alias="@/*" --turbopack`. The project root is the current directory (peninsulaacounting/).

    After scaffolding, install all Phase 1 dependencies:

    Core:
    - `@supabase/supabase-js @supabase/ssr` (Supabase client -- NOT @supabase/auth-helpers-nextjs which is deprecated)
    - `intuit-oauth` (official Intuit OAuth library)
    - `node-quickbooks` (QuickBooks API client)

    Supporting:
    - `zod` (runtime validation)
    - `date-fns date-fns-tz` (UK date handling)
    - `@tanstack/react-table` (data table)
    - `papaparse` (CSV parsing, server-side)

    Dev dependencies:
    - `@types/node-quickbooks @types/papaparse`

    Initialize shadcn/ui: `npx shadcn@latest init` with defaults (New York style, zinc base color, CSS variables).
    Then add initial components: `npx shadcn@latest add button input select table dialog checkbox badge toast dropdown-menu`

    Create `.env.local.example` with all required environment variables (comments explaining each):
    ```
    # Supabase
    NEXT_PUBLIC_SUPABASE_URL=
    NEXT_PUBLIC_SUPABASE_ANON_KEY=
    SUPABASE_SERVICE_ROLE_KEY=

    # QuickBooks
    QUICKBOOKS_CLIENT_ID=
    QUICKBOOKS_CLIENT_SECRET=
    QUICKBOOKS_REDIRECT_URI=http://localhost:3000/onboarding/callback
    QUICKBOOKS_ENVIRONMENT=sandbox

    # App
    NEXT_PUBLIC_APP_URL=http://localhost:3000
    ```

    Update `.gitignore` to include `.env.local` and `.env*.local`.

    Verify Next.js version is 15.2.3+ in package.json (middleware security fix). If create-next-app installs lower, upgrade explicitly.

    Update `app/layout.tsx` with basic metadata (title: "Peninsula Accounting", description: "Client reminder system").
    Update `app/page.tsx` to redirect to `/onboarding` (temporary -- will be updated when dashboard exists).
  </action>
  <verify>
    Run `npm run build` and confirm it completes without errors.
    Verify package.json contains all listed dependencies.
    Verify Next.js version >= 15.2.3 in package.json.
  </verify>
  <done>
    Next.js 15 project scaffolded with all Phase 1 dependencies installed, shadcn/ui initialized with required components, and build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase clients, env validation, middleware, and database schema</name>
  <files>
    lib/supabase/client.ts
    lib/supabase/server.ts
    lib/supabase/middleware.ts
    lib/supabase/admin.ts
    lib/validations/env.ts
    middleware.ts
    instrumentation.ts
  </files>
  <action>
    **Supabase clients (follow Pattern 2 from research exactly):**

    Create `lib/supabase/server.ts` -- server-side Supabase client using `createServerClient` from `@supabase/ssr`. Uses `cookies()` from `next/headers`. Exports async `createClient()` function.

    Create `lib/supabase/client.ts` -- browser Supabase client using `createBrowserClient` from `@supabase/ssr`. Exports `createClient()` function.

    Create `lib/supabase/admin.ts` -- service role client for server-only operations (token management, sync). Uses `createClient` from `@supabase/supabase-js` with `SUPABASE_SERVICE_ROLE_KEY`. Exports `createAdminClient()`.

    Create `lib/supabase/middleware.ts` -- exports `updateSession(request)` function that creates a Supabase server client within middleware context, calls `supabase.auth.getUser()` to refresh the session, and returns the response with updated cookies. Follow the official Supabase SSR middleware pattern.

    **Environment validation (Pattern 6 from research):**

    Create `lib/validations/env.ts` -- Zod schema for all required env vars:
    - NEXT_PUBLIC_SUPABASE_URL (string, url)
    - NEXT_PUBLIC_SUPABASE_ANON_KEY (string, min 1)
    - SUPABASE_SERVICE_ROLE_KEY (string, min 1)
    - QUICKBOOKS_CLIENT_ID (string, min 1)
    - QUICKBOOKS_CLIENT_SECRET (string, min 1)
    - QUICKBOOKS_REDIRECT_URI (string, url)
    - QUICKBOOKS_ENVIRONMENT (enum: sandbox | production)
    - NEXT_PUBLIC_APP_URL (string, url)

    Export `validateEnv()` that calls `envSchema.safeParse(process.env)` and exits with clear error if invalid.
    Also export the validated `env` object for type-safe access throughout the app.

    Create `instrumentation.ts` -- Next.js instrumentation hook. In `register()`, dynamically import and call `validateEnv()` only when `NEXT_RUNTIME === 'nodejs'`.

    **Middleware:**

    Create `middleware.ts` at project root. Import `updateSession` from `lib/supabase/middleware`. Call it and return the response. Use matcher pattern that excludes static files:
    ```
    matcher: ['/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)']
    ```

    **Database schema via Supabase MCP:**

    Apply migration using the Supabase MCP `apply_migration` tool with the following schema:

    ```sql
    -- Enable UUID extension
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    -- Client type enum
    CREATE TYPE client_type_enum AS ENUM ('Limited Company', 'Sole Trader', 'Partnership', 'LLP');

    -- VAT quarter enum
    CREATE TYPE vat_quarter_enum AS ENUM ('Jan-Mar', 'Apr-Jun', 'Jul-Sep', 'Oct-Dec');

    -- VAT scheme enum
    CREATE TYPE vat_scheme_enum AS ENUM ('Standard', 'Flat Rate', 'Cash Accounting', 'Annual Accounting');

    -- OAuth tokens table
    CREATE TABLE oauth_tokens (
      id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      provider TEXT NOT NULL DEFAULT 'quickbooks',
      access_token TEXT NOT NULL,
      refresh_token TEXT NOT NULL,
      realm_id TEXT NOT NULL,
      expires_at TIMESTAMPTZ NOT NULL,
      created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );

    -- Distributed locks table
    CREATE TABLE locks (
      id TEXT PRIMARY KEY,
      expires_at TIMESTAMPTZ NOT NULL,
      created_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );

    -- Clients table (synced from QuickBooks + metadata)
    CREATE TABLE clients (
      id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      quickbooks_id TEXT UNIQUE NOT NULL,
      company_name TEXT NOT NULL,
      display_name TEXT,
      primary_email TEXT,
      phone TEXT,
      active BOOLEAN NOT NULL DEFAULT true,

      -- Filing metadata (set by accountant)
      client_type client_type_enum,
      year_end_date DATE,
      vat_registered BOOLEAN DEFAULT false,
      vat_quarter vat_quarter_enum,
      vat_frequency TEXT DEFAULT 'quarterly',
      vat_scheme vat_scheme_enum,

      -- Timestamps
      synced_at TIMESTAMPTZ,
      created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );

    -- Index for company name matching (CSV import)
    CREATE INDEX idx_clients_company_name_lower ON clients (LOWER(company_name));

    -- Auto-update updated_at trigger
    CREATE OR REPLACE FUNCTION update_updated_at()
    RETURNS TRIGGER AS $$
    BEGIN
      NEW.updated_at = now();
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER clients_updated_at
      BEFORE UPDATE ON clients
      FOR EACH ROW
      EXECUTE FUNCTION update_updated_at();

    CREATE TRIGGER oauth_tokens_updated_at
      BEFORE UPDATE ON oauth_tokens
      FOR EACH ROW
      EXECUTE FUNCTION update_updated_at();

    -- Lock cleanup function (delete expired locks)
    CREATE OR REPLACE FUNCTION cleanup_expired_locks()
    RETURNS void AS $$
    BEGIN
      DELETE FROM locks WHERE expires_at < now();
    END;
    $$ LANGUAGE plpgsql;

    -- Bulk update function for CSV import and bulk edit
    CREATE OR REPLACE FUNCTION bulk_update_client_metadata(
      updates jsonb
    )
    RETURNS void
    LANGUAGE plpgsql
    AS $$
    DECLARE
      update_record jsonb;
    BEGIN
      FOR update_record IN SELECT * FROM jsonb_array_elements(updates)
      LOOP
        UPDATE clients
        SET
          client_type = COALESCE((update_record->'metadata'->>'client_type')::client_type_enum, client_type),
          year_end_date = COALESCE((update_record->'metadata'->>'year_end_date')::date, year_end_date),
          vat_registered = COALESCE((update_record->'metadata'->>'vat_registered')::boolean, vat_registered),
          vat_quarter = COALESCE((update_record->'metadata'->>'vat_quarter')::vat_quarter_enum, vat_quarter),
          vat_scheme = COALESCE((update_record->'metadata'->>'vat_scheme')::vat_scheme_enum, vat_scheme),
          updated_at = now()
        WHERE id = (update_record->>'id')::uuid;
      END LOOP;
    END;
    $$;

    -- RLS policies (basic -- single-tenant but future-proof)
    ALTER TABLE clients ENABLE ROW LEVEL SECURITY;
    ALTER TABLE oauth_tokens ENABLE ROW LEVEL SECURITY;
    ALTER TABLE locks ENABLE ROW LEVEL SECURITY;

    -- Allow authenticated users full access (single-tenant)
    CREATE POLICY "Authenticated users can read clients" ON clients
      FOR SELECT TO authenticated USING (true);
    CREATE POLICY "Authenticated users can insert clients" ON clients
      FOR INSERT TO authenticated WITH CHECK (true);
    CREATE POLICY "Authenticated users can update clients" ON clients
      FOR UPDATE TO authenticated USING (true) WITH CHECK (true);

    CREATE POLICY "Authenticated users can manage tokens" ON oauth_tokens
      FOR ALL TO authenticated USING (true) WITH CHECK (true);

    CREATE POLICY "Authenticated users can manage locks" ON locks
      FOR ALL TO authenticated USING (true) WITH CHECK (true);

    -- Service role bypass for background jobs (sync, token refresh)
    CREATE POLICY "Service role full access to clients" ON clients
      FOR ALL TO service_role USING (true) WITH CHECK (true);
    CREATE POLICY "Service role full access to tokens" ON oauth_tokens
      FOR ALL TO service_role USING (true) WITH CHECK (true);
    CREATE POLICY "Service role full access to locks" ON locks
      FOR ALL TO service_role USING (true) WITH CHECK (true);
    ```

    Apply this as a single migration named `create_phase1_schema`.
  </action>
  <verify>
    Verify `lib/supabase/server.ts` exports createClient.
    Verify `lib/supabase/client.ts` exports createClient.
    Verify `lib/supabase/admin.ts` exports createAdminClient.
    Verify `lib/validations/env.ts` exports validateEnv and env.
    Verify `middleware.ts` exists at project root.
    Verify `instrumentation.ts` exists at project root.
    Run `npm run build` to confirm compilation succeeds.
    Verify database tables exist via Supabase MCP `list_tables`.
  </verify>
  <done>
    Supabase server/browser/admin clients created following @supabase/ssr patterns. Environment validation runs at startup via instrumentation hook. Middleware refreshes auth tokens. Database schema applied with clients, oauth_tokens, and locks tables plus RLS policies and bulk update function.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. All dependencies from research are in package.json
3. Next.js version >= 15.2.3
4. Database tables (clients, oauth_tokens, locks) exist in Supabase
5. Environment validation catches missing vars at startup
6. shadcn/ui components are available for use
</verification>

<success_criteria>
- Project scaffolded with Next.js 15.2.3+ and all Phase 1 dependencies
- Supabase clients work in server, browser, and admin contexts
- Database schema applied with all tables, indexes, triggers, and RLS policies
- Environment validation runs at startup and fails fast with clear errors
- Middleware refreshes Supabase auth tokens on every request
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-integration/01-01-SUMMARY.md`
</output>
