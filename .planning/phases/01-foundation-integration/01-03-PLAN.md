---
phase: 01-foundation-integration
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - app/(dashboard)/layout.tsx
  - app/(dashboard)/clients/page.tsx
  - app/(dashboard)/clients/components/client-table.tsx
  - app/(dashboard)/clients/components/editable-cell.tsx
  - app/(dashboard)/clients/components/bulk-edit-modal.tsx
  - app/(dashboard)/clients/components/bulk-actions-toolbar.tsx
  - app/actions/clients.ts
  - app/api/clients/[id]/route.ts
  - app/api/clients/bulk/route.ts
  - components/qbo-status-banner.tsx
autonomous: true

must_haves:
  truths:
    - "Accountant sees a table of all synced clients with columns: name/company, client type, year-end date, VAT details"
    - "Accountant can search clients by name using search box above the table"
    - "Accountant can filter clients by client type and VAT status using dropdown filters"
    - "Accountant can click any editable cell to edit inline -- changes save on blur"
    - "Accountant can select multiple clients via checkboxes and click 'Bulk Edit' to edit year-end, VAT registration, and VAT quarter"
    - "Client type dropdown appears inline for individual editing but is NOT available in bulk edit"
    - "A persistent banner shows 'QuickBooks disconnected' when OAuth tokens are invalid or missing"
  artifacts:
    - path: "app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with nav and QBO status banner"
    - path: "app/(dashboard)/clients/page.tsx"
      provides: "Server component that fetches clients and renders table"
    - path: "app/(dashboard)/clients/components/client-table.tsx"
      provides: "TanStack Table with inline editing, bulk selection, search, and filters"
    - path: "app/(dashboard)/clients/components/editable-cell.tsx"
      provides: "Reusable inline-editable cell component"
    - path: "app/(dashboard)/clients/components/bulk-edit-modal.tsx"
      provides: "Modal dialog for bulk editing selected clients"
    - path: "app/(dashboard)/clients/components/bulk-actions-toolbar.tsx"
      provides: "Floating toolbar that appears when rows are selected"
    - path: "app/actions/clients.ts"
      provides: "Server actions for client CRUD and bulk operations"
      exports: ["updateClientMetadata", "bulkUpdateClients", "getClients"]
    - path: "components/qbo-status-banner.tsx"
      provides: "QuickBooks connection status banner"
  key_links:
    - from: "app/(dashboard)/clients/components/client-table.tsx"
      to: "app/actions/clients.ts"
      via: "server action calls on cell blur"
      pattern: "updateClientMetadata"
    - from: "app/(dashboard)/clients/components/bulk-edit-modal.tsx"
      to: "app/actions/clients.ts"
      via: "bulkUpdateClients server action"
      pattern: "bulkUpdateClients"
    - from: "app/(dashboard)/clients/page.tsx"
      to: "Supabase clients table"
      via: "server component data fetch"
      pattern: "from.*clients.*select"
    - from: "components/qbo-status-banner.tsx"
      to: "app/actions/quickbooks.ts"
      via: "getConnectionStatus server action"
      pattern: "getConnectionStatus"
---

<objective>
Build the dashboard layout, client data table with inline editing, bulk edit functionality, search/filters, and QuickBooks connection status banner.

Purpose: Give the accountant the primary interface for viewing and managing client metadata -- the core interaction surface of Phase 1. This is where they spend most of their time configuring client types, year-end dates, and VAT details.
Output: Fully interactive client table with inline editing, bulk edit via checkboxes, search/filter, and persistent QBO status banner.
</objective>

<execution_context>
@C:\Users\ejsch\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ejsch\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-integration/01-RESEARCH.md
@.planning/phases/01-foundation-integration/01-CONTEXT.md
@.planning/phases/01-foundation-integration/01-01-SUMMARY.md
@.planning/phases/01-foundation-integration/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard layout, QBO status banner, and client server actions</name>
  <files>
    app/(dashboard)/layout.tsx
    components/qbo-status-banner.tsx
    app/actions/clients.ts
    app/api/clients/[id]/route.ts
    app/api/clients/bulk/route.ts
  </files>
  <action>
    **Dashboard layout (`app/(dashboard)/layout.tsx`):**

    Server component. Minimal layout with:
    - Simple header/nav bar at top with "Peninsula Accounting" branding on left
    - Navigation links: "Clients" (active for this phase, others come later)
    - QBO status banner below nav (rendered from server -- check connection status)
    - Main content area below banner with consistent padding (px-6 py-8, max-w-7xl mx-auto)

    Fetch QBO connection status server-side using `getConnectionStatus()` from quickbooks server actions. Pass `connected` boolean to QboStatusBanner.

    **QBO status banner (`components/qbo-status-banner.tsx`):**

    Client component. Props: `{ connected: boolean }`.

    When `connected === false`:
    - Show a persistent yellow/amber warning banner across full width below nav
    - Text: "QuickBooks disconnected" with a "Reconnect" link that navigates to /onboarding
    - Use shadcn Badge or custom alert styling
    - Per locked decision: this is a persistent banner, NOT a dismissable toast

    When `connected === true`:
    - Render nothing (no banner)

    **Client server actions (`app/actions/clients.ts`):**

    Use `'use server'` directive. All actions use the server Supabase client.

    1. `getClients()` -- fetches all clients from Supabase ordered by company_name. Returns typed array. No pagination (locked decision: under 50 clients, all on one page).

    2. `updateClientMetadata(clientId: string, data: Partial<ClientMetadata>)` -- validates input with Zod schema from `lib/validations/client.ts`, updates single client in Supabase. Returns updated client. Used for inline cell edits.

    3. `bulkUpdateClients(clientIds: string[], updates: BulkUpdateFields)` -- validates that only bulk-editable fields are included (year_end_date, vat_registered, vat_quarter -- NOT client_type per locked decision). Calls the `bulk_update_client_metadata` Postgres function via Supabase RPC. Returns success/failure.

    **API routes (for future webhook/external use):**

    `app/api/clients/[id]/route.ts` -- PATCH handler. Parses body, validates with Zod, calls updateClientMetadata. Returns JSON response.

    `app/api/clients/bulk/route.ts` -- PATCH handler. Parses body (array of IDs + updates), validates, calls bulkUpdateClients. Returns JSON response.
  </action>
  <verify>
    Run `npm run build` to confirm layout, banner, actions, and API routes compile.
    Verify the dashboard layout renders at /clients path.
  </verify>
  <done>
    Dashboard layout has nav bar with "Peninsula Accounting" branding and "Clients" link. QBO status banner shows amber warning when disconnected with "Reconnect" link. Server actions handle individual and bulk client metadata updates with Zod validation. Bulk edit restricts to allowed fields only (year_end_date, vat_registered, vat_quarter).
  </done>
</task>

<task type="auto">
  <name>Task 2: Client data table with inline editing, bulk selection, and search/filters</name>
  <files>
    app/(dashboard)/clients/page.tsx
    app/(dashboard)/clients/components/client-table.tsx
    app/(dashboard)/clients/components/editable-cell.tsx
    app/(dashboard)/clients/components/bulk-edit-modal.tsx
    app/(dashboard)/clients/components/bulk-actions-toolbar.tsx
  </files>
  <action>
    **Clients page (`app/(dashboard)/clients/page.tsx`):**

    Server component. Fetches all clients via `getClients()` action. Renders the ClientTable with initial data. Page title "Clients" as h1.

    **Editable cell component (`app/(dashboard)/clients/components/editable-cell.tsx`):**

    Reusable client component for inline editing. Props: `{ value, onSave, type: 'text' | 'date' | 'select' | 'boolean', options?: { value: string, label: string }[] }`.

    Behavior (per locked decision -- spreadsheet-like inline editing):
    - Display mode: shows current value with subtle hover highlight (cursor-pointer)
    - Click to enter edit mode
    - Edit mode renders appropriate input based on type:
      - 'text': Input field
      - 'date': Date input (stores as YYYY-MM-DD internally, displays as "1 Jan 2026" format per UK convention)
      - 'select': Select dropdown (for client type, VAT quarter)
      - 'boolean': Checkbox (for VAT registered)
    - Save on blur (onBlur handler calls onSave with new value)
    - Save on Enter key
    - Cancel on Escape key (revert to original value)
    - Show subtle loading indicator while saving (small spinner or opacity change)
    - Show error toast if save fails (via sonner/toast)

    For dates: display in UK format "DD MMM YYYY" (e.g., "31 Jan 2026") using date-fns format with enGB locale. Store as ISO date string.

    **Client table (`app/(dashboard)/clients/components/client-table.tsx`):**

    Client component using TanStack Table (useReactTable). Props: `{ initialData: Client[] }`.

    Manage local state with `useState(initialData)` for optimistic updates.

    Columns (per locked decision -- all visible, no column toggling):
    1. **Checkbox** -- row selection for bulk edit. Header has "select all" checkbox with indeterminate state.
    2. **Client Name** -- display_name or company_name. NOT editable (synced from QBO).
    3. **Client Type** -- EditableCell with type='select', options: Limited Company, Sole Trader, Partnership, LLP. Per locked decision: set individually, not bulk-editable.
    4. **Year End** -- EditableCell with type='date'. Displays in UK format.
    5. **VAT Registered** -- EditableCell with type='boolean'. Shows Yes/No badge or checkbox.
    6. **VAT Quarter** -- EditableCell with type='select', options: Jan-Mar, Apr-Jun, Jul-Sep, Oct-Dec. Only visible/editable when vat_registered is true.

    On cell edit (onSave callback):
    1. Optimistic update: immediately update local state
    2. Call `updateClientMetadata(clientId, { [field]: newValue })` server action
    3. If server action fails, revert local state and show error toast
    4. Use `useTransition` for pending states

    **Search and filters (per locked decision):**

    Above the table, render:
    - Search input (shadcn Input): filters by company_name using TanStack Table's globalFilter
    - Client Type dropdown (shadcn Select): filter by client_type column. Options: "All types", "Limited Company", "Sole Trader", "Partnership", "LLP"
    - VAT Status dropdown (shadcn Select): filter by vat_registered. Options: "All", "VAT Registered", "Not VAT Registered"

    Use TanStack Table's `getFilteredRowModel()` for search. For dropdown filters, use column-level filtering.

    **Bulk actions toolbar (`app/(dashboard)/clients/components/bulk-actions-toolbar.tsx`):**

    Client component. Props: `{ selectedCount: number, onBulkEdit: () => void, onClearSelection: () => void }`.

    Fixed position at bottom of screen (floating toolbar). Shows when selectedCount > 0.
    - Text: "{N} client(s) selected"
    - Button: "Bulk Edit" (primary) -> triggers onBulkEdit callback
    - Button: "Clear" (secondary) -> triggers onClearSelection callback
    - Smooth enter/exit animation (CSS transition or Tailwind animate)

    **Bulk edit modal (`app/(dashboard)/clients/components/bulk-edit-modal.tsx`):**

    Client component using shadcn Dialog. Props: `{ open, onClose, selectedClients: Client[], onSave: (updates) => Promise<void> }`.

    Modal content:
    - Title: "Bulk Edit {N} Clients"
    - Form with ONLY bulk-editable fields (per locked decision):
      - Year End Date (date input)
      - VAT Registered (checkbox)
      - VAT Quarter (select dropdown)
    - Each field has a checkbox "Update this field" -- only checked fields are included in the update. This prevents accidentally blanking fields.
    - **Confirmation step** (per research pitfall 9): Before applying, show preview text: "This will update {N} clients: {field1} -> {value1}, {field2} -> {value2}"
    - Buttons: "Cancel" (closes modal) and "Apply Changes" (calls onSave)

    Wire bulk edit flow in client-table.tsx:
    1. User selects rows via checkboxes
    2. Floating toolbar appears
    3. User clicks "Bulk Edit"
    4. Modal opens with selected clients
    5. User fills form, confirms preview
    6. Call `bulkUpdateClients()` server action
    7. Optimistic update: update all selected rows in local state
    8. Clear selection
    9. Show success toast: "Updated {N} clients"
  </action>
  <verify>
    Run `npm run build` to confirm all components compile.
    Verify the clients page renders at /clients with the table.
    Check that TanStack Table is properly configured with columns.
    Verify shadcn Dialog, Select, Input, Checkbox, Badge, and Toast components are used.
  </verify>
  <done>
    Client table displays all synced clients in a table with columns for name, client type, year-end, VAT registered, and VAT quarter. Inline editing works via click-to-edit with blur-to-save. Search box filters by client name. Dropdown filters for client type and VAT status work. Bulk selection via checkboxes shows floating toolbar. Bulk edit modal allows updating year-end date, VAT registered, and VAT quarter for multiple clients at once with confirmation preview. Client type is only editable individually (not in bulk edit). All edits persist to database via server actions with optimistic updates.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Dashboard layout renders with nav and content area
3. QBO status banner shows/hides based on connection status
4. Client table displays all columns per spec
5. Inline editing saves on blur for all editable fields
6. Search filters clients by name
7. Dropdown filters work for client type and VAT status
8. Bulk selection shows floating toolbar with count
9. Bulk edit modal only shows allowed fields (no client_type)
10. Bulk edit has confirmation preview before applying
11. UK date formatting used throughout (DD MMM YYYY)
</verification>

<success_criteria>
- All synced clients visible in table with correct columns
- Inline editing works: click cell -> edit -> blur saves -> optimistic update
- Search and filter dropdowns correctly filter table rows
- Bulk edit: select rows -> floating toolbar -> bulk edit modal -> confirmation -> update
- Client type editable individually but NOT in bulk edit
- QBO disconnection banner appears when tokens missing/expired
- UK date formatting throughout
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-integration/01-03-SUMMARY.md`
</output>
