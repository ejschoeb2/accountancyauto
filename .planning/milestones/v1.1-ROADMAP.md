# Milestone v1.1: Template & Scheduling Redesign

**Status:** SHIPPED 2026-02-08
**Phases:** 4-9
**Total Plans:** 13

## Overview

Decouple email templates from scheduling logic, add rich text editing with live preview, and enable ad-hoc client communications. Migrated from JSONB-embedded template structure to normalized relational tables, introduced TipTap 3.x rich text editor, and rewired the entire automated reminder pipeline.

## Phases

### Phase 4: Data Migration
**Goal**: Existing reminder data is safely restructured into normalized tables without data loss or disruption to the running system
**Depends on**: Nothing (foundational for v1.1)
**Requirements**: MIGR-01, MIGR-02, MIGR-03, MIGR-04, MIGR-05, MIGR-06, MIGR-07
**Success Criteria**:
  1. New email_templates table contains one row per unique template body, with body stored as TipTap JSON
  2. New schedules and schedule_steps tables contain the same step sequences previously embedded in reminder_templates.steps JSONB
  3. Client overrides are split into content overrides and timing overrides with no data lost
  4. Data verification query confirms row counts match between old and new structures
  5. Old tables are retained and the existing reminder queue continues to function without disruption
**Plans**: 2 plans

Plans:
- [x] 04-01-PLAN.md — Create v1.1 normalized tables (DDL migration + TypeScript types)
- [x] 04-02-PLAN.md — Migrate v1.0 data to normalized structure + verification script

### Phase 5: Rich Text Editor & Templates
**Goal**: User can create and manage standalone email templates using a rich text editor with placeholder autocomplete
**Depends on**: Phase 4 (email_templates table must exist)
**Requirements**: EDIT-01, EDIT-02, EDIT-03, EDIT-04, EDIT-05, TMPL-01, TMPL-02, TMPL-03, TMPL-04, TMPL-05
**Success Criteria**:
  1. User can create a new email template with name, subject line, and rich text body using a toolbar with bold, italic, underline, lists, and links
  2. User can type `/` in the editor body to trigger an autocomplete dropdown and insert a placeholder that renders as a styled pill
  3. User can insert placeholders in the subject line via a button dropdown
  4. User can paste content from Word or Outlook and the editor strips complex styles without breaking layout
  5. User can view a list of all templates and edit any existing template with content loading correctly in the editor
**Plans**: 4 plans

Plans:
- [x] 05-01-PLAN.md — Install TipTap + create PlaceholderNode and PasteHandler extensions
- [x] 05-02-PLAN.md — API routes for email_templates CRUD (validation, list, create, update, delete)
- [x] 05-03-PLAN.md — TipTap editor component, toolbar, placeholder dropdown, subject line editor
- [x] 05-04-PLAN.md — Template list page (card grid) and create/edit pages with visual verification

### Phase 6: Email Rendering Pipeline
**Goal**: TipTap JSON content converts to email-safe HTML with inline styles for correct rendering in Gmail, Outlook, and Apple Mail
**Depends on**: Phase 5 (TipTap editor must produce JSON content)
**Requirements**: RNDR-04, RNDR-05 (RNDR-01, RNDR-02, RNDR-03 removed from scope)
**Success Criteria**:
  1. Sent emails render correctly in Gmail, Outlook, and Apple Mail
  2. Placeholders are replaced with client data at render time, with fallback text for missing values
  3. All links open in new tab with proper security attributes
**Plans**: 1 plan

Plans:
- [x] 06-01-PLAN.md — Rendering pipeline: TipTap JSON to inline-styled email HTML + tests

### Phase 7: Schedule Management
**Goal**: User can create and manage reminder schedules independently from templates, with sub-tab navigation alongside templates
**Depends on**: Phase 5 (email templates must exist to assign to schedule steps)
**Requirements**: SCHD-01 through SCHD-08 (SCHD-09, SCHD-10, OVRD-01 through OVRD-05 deferred)
**Success Criteria**:
  1. User can create a schedule for a filing type with multiple steps
  2. User can reorder, add, and remove steps within a schedule
  3. User can view all schedules with their filing types and edit any schedule
**Plans**: 2 plans

Plans:
- [x] 07-01-PLAN.md — Validation schema, CRUD API routes, sub-tab navigation, schedule list
- [x] 07-02-PLAN.md — Schedule editor page with step management (reorder, template/delay/urgency config)

### Phase 8: Ad-Hoc Sending
**Goal**: User can send one-off emails to selected clients outside the automated reminder schedule
**Depends on**: Phase 5 (templates), Phase 6 (rendering pipeline)
**Requirements**: ADHC-01 through ADHC-09
**Success Criteria**:
  1. User can start an ad-hoc send from the clients page bulk actions toolbar
  2. User can pick an email template, preview it with selected clients' data
  3. User sees confirmation modal, progress indicator, and results summary
  4. Ad-hoc sends appear in the delivery log with an "ad-hoc" type indicator
**Plans**: 2 plans

Plans:
- [x] 08-01-PLAN.md — Server action for ad-hoc sending, email_log send_type column, delivery log ad-hoc badge
- [x] 08-02-PLAN.md — Send Email modal (template select, preview, confirm, progress, results) + toolbar wiring

### Phase 9: Queue Integration
**Goal**: The automated reminder system reads from the new normalized tables, completing the migration from the old JSONB structure
**Depends on**: Phase 4 (new tables), Phase 7 (schedules), Phase 6 (rendering pipeline)
**Requirements**: QUEU-01 through QUEU-04
**Success Criteria**:
  1. Queue builder reads from schedules and schedule_steps tables
  2. Queue builder resolves email content from email_templates via schedule_step_id
  3. Existing reminder queue continues to function during transition with no missed or duplicate sends
**Plans**: 2 plans

Plans:
- [x] 09-01-PLAN.md — Rewire queue builder, scheduler, and send-emails cron to v1.1 tables + rendering
- [x] 09-02-PLAN.md — Remove all v1.0 code references and drop reminder_templates table

## Progress

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 4. Data Migration | 2/2 | Complete | 2026-02-08 |
| 5. Rich Text Editor & Templates | 4/4 | Complete | 2026-02-08 |
| 6. Email Rendering Pipeline | 1/1 | Complete | 2026-02-08 |
| 7. Schedule Management | 2/2 | Complete | 2026-02-08 |
| 8. Ad-Hoc Sending | 2/2 | Complete | 2026-02-08 |
| 9. Queue Integration | 2/2 | Complete | 2026-02-08 |

## Milestone Summary

**Key Decisions:**
- TipTap 3.x for rich text editing (React 19 compatible, atomic placeholder nodes)
- Composition over embedding — email templates as standalone entities referenced by FK
- Three-phase migration strategy (add tables, verify, cleanup old structure)
- ON DELETE RESTRICT for schedule_steps -> email_templates FK (prevents breaking schedules)
- Per-client overrides deferred from v1.1 scope (tables exist, no UI)
- Schedule duplicate feature removed (one schedule per filing type by design)
- Lazy Postmark client initialization via Proxy pattern

**Issues Resolved:**
- Filing types API response format mismatch (wrapper object vs plain array)
- Schedule duplicate FK violation (UNIQUE constraint on filing_type_id)
- Postmark client eager initialization crash during preview flow
- Zod v4 record type signature change

**Issues Deferred:**
- RNDR-01/02/03: Live preview pane (descoped — not needed)
- SCHD-09/10: Cancel/reschedule individual reminders (deferred to v2)
- OVRD-01 to OVRD-05: Per-client override UI (tables exist, no UI built)

**Technical Debt Incurred:**
- Dual PlaceholderNode implementations (client vs server) — maintenance risk
- Extension config duplicated between editor and server renderer
- 9 pre-existing test failures in rollover.test.ts and variables.test.ts

---
*For current project status, see .planning/ROADMAP.md*
